This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: abc-parser, abc-test/src/test/resources/**, test-output.txt, test_output.txt, abc-test/**.txt, reports/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
abc-core/
  src/
    main/
      kotlin/
        io/
          github/
            ryangardner/
              abc/
                core/
                  model/
                    AbcTune.kt
                    Accidental.kt
                    BarLineType.kt
                    Decoration.kt
                    HeaderType.kt
                    KeyMode.kt
                    KeyRoot.kt
                    KeySignature.kt
                    MusicElement.kt
                    NoteDuration.kt
                    NoteStep.kt
                    Pitch.kt
                    Tempo.kt
                    TieType.kt
                    TimeSignature.kt
                    TuneBody.kt
                    TuneHeader.kt
                    TuneMetadata.kt
  pom.xml
abc-interop/
  pom.xml
abc-parser-antlr/
  src/
    main/
      antlr4/
        io/
          github/
            ryangardner/
              abc/
                antlr/
                  ABCLexer.g4
                  ABCParser.g4
      kotlin/
        io/
          github/
            ryangardner/
              abc/
                antlr/
                  AntlrAbcParser.kt
    test/
      kotlin/
        io/
          github/
            ryangardner/
              abc/
                antlr/
                  TortureTest.kt
  pom.xml
abc-parser-v2/
  src/
    main/
      kotlin/
        io/
          github/
            ryangardner/
              abc/
                parser/
                  v2/
                    AntlrAbcParser.kt
  pom.xml
abc-test/
  src/
    main/
      kotlin/
        io/
          github/
            ryangardner/
              abc/
                test/
                  DatasetDownloader.kt
    test/
      kotlin/
        io/
          github/
            ryangardner/
              abc/
                test/
                  AbcjsSemanticParityTest.kt
                  AbcParserDebug.kt
                  RegressionHeavyTest.kt
                  RoundTripAntlrTest.kt
                  RoundTripTest.kt
                  SemanticFidelityTest.kt
                  SymbolLineParserTest.kt
                  TextBlockParserTest.kt
  pom.xml
  REGRESSION.md
abc-theory/
  src/
    main/
      kotlin/
        io/
          github/
            ryangardner/
              abc/
                theory/
                  util/
                    KeyParserUtil.kt
                  AbcExtensions.kt
                  CircleOfFifths.kt
                  MeasureValidator.kt
                  PitchInterpreter.kt
                  RepeatExpander.kt
                  Transposer.kt
    test/
      kotlin/
        io/
          github/
            ryangardner/
              abc/
                theory/
                  PitchInterpretationTest.kt
                  RepeatExpanderTest.kt
                  TransposerTest.kt
  pom.xml
config/
  detekt/
    detekt.yml
docs/
  architecture.md
  parser-gotchas.md
  parser.md
tools/
  abcjs-exporter/
    export-abc.js
    export-batch.js
    generate-baselines.sh
    inspect-tune.js
    package.json
    test_repeat.abc
  music21-exporter/
    m21_validator.py
  compare_durations.py
  compare_ends.py
.gitignore
abcjs_pitches.txt
accid_abcjs.json
pom.xml
tune_010337_abcjs.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="abc-test/src/test/kotlin/io/github/ryangardner/abc/test/AbcParserDebug.kt">
package io.github.ryangardner.abc.test

import io.github.ryangardner.abc.parser.v2.AntlrAbcParser
import org.junit.jupiter.api.Test
import java.io.File

class AbcParserDebug {
    @Test
    fun debug011215() {
        val abcFile = File("../target/abc-dataset/abc_notation_batch_007/abc_files/tune_011215.abc")
        if (!abcFile.exists()) {
            println("File not found: ${abcFile.absolutePath}")
            return
        }
        val abcContent = abcFile.readText()
        val tune = AntlrAbcParser().parse(abcContent)
        
        println("--- Music Elements for tune_011215 (Original) ---")
        tune.body.elements.forEachIndexed { index, element ->
            println("[$index] ${element.javaClass.simpleName}: $element")
        }

        val expanded = io.github.ryangardner.abc.theory.RepeatExpander.expand(tune)
        println("--- Music Elements for tune_011215 (Expanded) ---")
        expanded.forEachIndexed { index, element ->
            println("[$index] ${element.javaClass.simpleName}: $element")
        }
    }
}
</file>

<file path="abcjs_pitches.txt">
4
3
4
6
5
8
7
6
8
5
7
6
2
2
3
4
3
4
6
5
8
7
6
4
5
4
3
1
2
3
4
3
4
6
5
8
7
6
7
8
5
7
6
2
2
3
4
4
3
4
5
6
7
8
6
5
4
3
1
1
10
11
10
9
10
11
9
10
11
9
12
11
10
8
8
10
11
10
9
10
11
10
9
8
6
8
5
4
3
1
1
10
11
10
9
10
11
13
11
10
11
12
11
10
8
8
10
11
13
12
10
11
10
9
8
6
7
8
5
4
3
1
2
3
</file>

<file path="accid_abcjs.json">
[
  {
    "metaText": {
      "title": "Accidental Same Octave"
    },
    "formatting": {
      "composerfont": {
        "face": "\"Times New Roman\"",
        "size": 14,
        "weight": "normal",
        "style": "italic",
        "decoration": "none"
      },
      "subtitlefont": {
        "face": "\"Times New Roman\"",
        "size": 16,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "tempofont": {
        "face": "\"Times New Roman\"",
        "size": 15,
        "weight": "bold",
        "style": "normal",
        "decoration": "none"
      },
      "titlefont": {
        "face": "\"Times New Roman\"",
        "size": 20,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "footerfont": {
        "face": "\"Times New Roman\"",
        "size": 12,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "headerfont": {
        "face": "\"Times New Roman\"",
        "size": 12,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "voicefont": {
        "face": "\"Times New Roman\"",
        "size": 13,
        "weight": "bold",
        "style": "normal",
        "decoration": "none"
      },
      "tablabelfont": {
        "face": "\"Trebuchet MS\"",
        "size": 16,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "tabnumberfont": {
        "face": "\"Arial\"",
        "size": 11,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "tabgracefont": {
        "face": "\"Arial\"",
        "size": 8,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "annotationfont": {
        "face": "Helvetica",
        "size": 12,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "gchordfont": {
        "face": "Helvetica",
        "size": 12,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "historyfont": {
        "face": "\"Times New Roman\"",
        "size": 16,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "infofont": {
        "face": "\"Times New Roman\"",
        "size": 14,
        "weight": "normal",
        "style": "italic",
        "decoration": "none"
      },
      "measurefont": {
        "face": "\"Times New Roman\"",
        "size": 14,
        "weight": "normal",
        "style": "italic",
        "decoration": "none"
      },
      "partsfont": {
        "face": "\"Times New Roman\"",
        "size": 15,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "repeatfont": {
        "face": "\"Times New Roman\"",
        "size": 13,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "textfont": {
        "face": "\"Times New Roman\"",
        "size": 16,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "tripletfont": {
        "face": "Times",
        "size": 11,
        "weight": "normal",
        "style": "italic",
        "decoration": "none"
      },
      "vocalfont": {
        "face": "\"Times New Roman\"",
        "size": 13,
        "weight": "bold",
        "style": "normal",
        "decoration": "none"
      },
      "wordsfont": {
        "face": "\"Times New Roman\"",
        "size": 16,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "pagewidth": 612,
      "pageheight": 792
    },
    "lines": [
      {
        "staff": [
          {
            "voices": [
              [
                {
                  "pitches": [
                    {
                      "accidental": "sharp",
                      "pitch": 4,
                      "name": "^G",
                      "verticalPos": 4
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 45,
                  "endChar": 48,
                  "currentTrackMilliseconds": 0,
                  "currentTrackWholeNotes": 0,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 68,
                      "volume": 85,
                      "start": 0,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 45,
                      "endChar": 48,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 48,
                  "endChar": 50,
                  "currentTrackMilliseconds": 166.66666666666669,
                  "currentTrackWholeNotes": 0.125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 85,
                      "start": 0.125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 48,
                      "endChar": 50,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 4,
                      "name": "G",
                      "verticalPos": 4
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 50,
                  "endChar": 52,
                  "currentTrackMilliseconds": 333.33333333333337,
                  "currentTrackWholeNotes": 0.25,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 68,
                      "volume": 85,
                      "start": 0.25,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 50,
                      "endChar": 52,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 52,
                  "endChar": 54,
                  "currentTrackMilliseconds": 500,
                  "currentTrackWholeNotes": 0.375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 85,
                      "start": 0.375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 52,
                      "endChar": 54,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 54,
                  "endChar": 55
                },
                {
                  "pitches": [
                    {
                      "accidental": "sharp",
                      "pitch": 11,
                      "name": "^g",
                      "verticalPos": 11
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 55,
                  "endChar": 59,
                  "currentTrackMilliseconds": 666.6666666666667,
                  "currentTrackWholeNotes": 0.5,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 80,
                      "volume": 105,
                      "start": 0.5,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 55,
                      "endChar": 59,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 13,
                      "name": "b",
                      "verticalPos": 13
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 59,
                  "endChar": 61,
                  "currentTrackMilliseconds": 833.3333333333333,
                  "currentTrackWholeNotes": 0.625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 83,
                      "volume": 85,
                      "start": 0.625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 59,
                      "endChar": 61,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 11,
                      "name": "g",
                      "verticalPos": 11
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 61,
                  "endChar": 63,
                  "currentTrackMilliseconds": 1000,
                  "currentTrackWholeNotes": 0.75,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 80,
                      "volume": 95,
                      "start": 0.75,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 61,
                      "endChar": 63,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 13,
                      "name": "b",
                      "verticalPos": 13
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 63,
                  "endChar": 65,
                  "currentTrackMilliseconds": 1166.6666666666667,
                  "currentTrackWholeNotes": 0.875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 83,
                      "volume": 85,
                      "start": 0.875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 63,
                      "endChar": 65,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 65,
                  "endChar": 66
                }
              ]
            ],
            "clef": {
              "type": "treble",
              "verticalPos": 0,
              "clefPos": 4
            },
            "key": {
              "accidentals": [],
              "root": "C",
              "acc": "",
              "mode": ""
            },
            "meter": {
              "type": "specified",
              "value": [
                {
                  "num": "4",
                  "den": "4"
                }
              ]
            }
          }
        ]
      }
    ],
    "midiEvents": [
      [
        {
          "cmd": "program",
          "channel": 0,
          "instrument": 0
        },
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null
      ]
    ]
  }
]
</file>

<file path="tune_010337_abcjs.json">
[
  {
    "metaText": {
      "title": "AppleBlossom_Thomasson",
      "tempo": {
        "startChar": 41,
        "endChar": 50,
        "duration": [
          0.125
        ],
        "bpm": 420
      }
    },
    "formatting": {
      "composerfont": {
        "face": "\"Times New Roman\"",
        "size": 14,
        "weight": "normal",
        "style": "italic",
        "decoration": "none"
      },
      "subtitlefont": {
        "face": "\"Times New Roman\"",
        "size": 16,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "tempofont": {
        "face": "\"Times New Roman\"",
        "size": 15,
        "weight": "bold",
        "style": "normal",
        "decoration": "none"
      },
      "titlefont": {
        "face": "\"Times New Roman\"",
        "size": 20,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "footerfont": {
        "face": "\"Times New Roman\"",
        "size": 12,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "headerfont": {
        "face": "\"Times New Roman\"",
        "size": 12,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "voicefont": {
        "face": "\"Times New Roman\"",
        "size": 13,
        "weight": "bold",
        "style": "normal",
        "decoration": "none"
      },
      "tablabelfont": {
        "face": "\"Trebuchet MS\"",
        "size": 16,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "tabnumberfont": {
        "face": "\"Arial\"",
        "size": 11,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "tabgracefont": {
        "face": "\"Arial\"",
        "size": 8,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "annotationfont": {
        "face": "Helvetica",
        "size": 12,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "gchordfont": {
        "face": "Helvetica",
        "size": 12,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "historyfont": {
        "face": "\"Times New Roman\"",
        "size": 16,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "infofont": {
        "face": "\"Times New Roman\"",
        "size": 14,
        "weight": "normal",
        "style": "italic",
        "decoration": "none"
      },
      "measurefont": {
        "face": "\"Times New Roman\"",
        "size": 14,
        "weight": "normal",
        "style": "italic",
        "decoration": "none"
      },
      "partsfont": {
        "face": "\"Times New Roman\"",
        "size": 15,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "repeatfont": {
        "face": "\"Times New Roman\"",
        "size": 13,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "textfont": {
        "face": "\"Times New Roman\"",
        "size": 16,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "tripletfont": {
        "face": "Times",
        "size": 11,
        "weight": "normal",
        "style": "italic",
        "decoration": "none"
      },
      "vocalfont": {
        "face": "\"Times New Roman\"",
        "size": 13,
        "weight": "bold",
        "style": "normal",
        "decoration": "none"
      },
      "wordsfont": {
        "face": "\"Times New Roman\"",
        "size": 16,
        "weight": "normal",
        "style": "normal",
        "decoration": "none"
      },
      "pagewidth": 612,
      "pageheight": 792
    },
    "lines": [
      {
        "staff": [
          {
            "voices": [
              [
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 55,
                  "endChar": 56,
                  "startBeam": true,
                  "currentTrackMilliseconds": 0,
                  "currentTrackWholeNotes": 0,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 0,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 55,
                      "endChar": 56,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 56,
                  "endChar": 57,
                  "endBeam": true,
                  "currentTrackMilliseconds": 142.8571428571429,
                  "currentTrackWholeNotes": 0.125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 85,
                      "start": 0.125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 56,
                      "endChar": 57,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 57,
                  "endChar": 58
                },
                {
                  "chord": [
                    {
                      "name": "D",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 58,
                  "endChar": 62,
                  "currentTrackMilliseconds": 285.7142857142858,
                  "currentTrackWholeNotes": 0.25,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 105,
                      "start": 0.25,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 58,
                      "endChar": 62,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.25,
                  "el_type": "note",
                  "startChar": 62,
                  "endChar": 64,
                  "currentTrackMilliseconds": 428.57142857142856,
                  "currentTrackWholeNotes": 0.375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 85,
                      "start": 0.375,
                      "duration": 0.25,
                      "instrument": 0,
                      "startChar": 62,
                      "endChar": 64,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 64,
                  "endChar": 66,
                  "currentTrackMilliseconds": 714.2857142857142,
                  "currentTrackWholeNotes": 0.625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 0.625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 64,
                      "endChar": 66,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 66,
                  "endChar": 67,
                  "startBeam": true,
                  "currentTrackMilliseconds": 857.1428571428571,
                  "currentTrackWholeNotes": 0.75,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 95,
                      "start": 0.75,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 66,
                      "endChar": 67,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 67,
                  "endChar": 68,
                  "currentTrackMilliseconds": 1000,
                  "currentTrackWholeNotes": 0.875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 0.875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 67,
                      "endChar": 68,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 13,
                      "name": "b",
                      "verticalPos": 13
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 68,
                  "endChar": 69,
                  "currentTrackMilliseconds": 1142.8571428571431,
                  "currentTrackWholeNotes": 1,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 83,
                      "volume": 95,
                      "start": 1,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 68,
                      "endChar": 69,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 69,
                  "endChar": 70,
                  "endBeam": true,
                  "currentTrackMilliseconds": 1285.7142857142858,
                  "currentTrackWholeNotes": 1.125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 1.125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 69,
                      "endChar": 70,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 70,
                  "endChar": 71
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 71,
                  "endChar": 72,
                  "startBeam": true,
                  "currentTrackMilliseconds": 1428.5714285714284,
                  "currentTrackWholeNotes": 1.25,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 105,
                      "start": 1.25,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 71,
                      "endChar": 72,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 72,
                  "endChar": 73,
                  "currentTrackMilliseconds": 1571.4285714285713,
                  "currentTrackWholeNotes": 1.375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 1.375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 72,
                      "endChar": 73,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 73,
                  "endChar": 74,
                  "currentTrackMilliseconds": 1714.2857142857142,
                  "currentTrackWholeNotes": 1.5,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 95,
                      "start": 1.5,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 73,
                      "endChar": 74,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 74,
                  "endChar": 76,
                  "endBeam": true,
                  "currentTrackMilliseconds": 1857.142857142857,
                  "currentTrackWholeNotes": 1.625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 1.625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 74,
                      "endChar": 76,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 76,
                  "endChar": 77,
                  "startBeam": true,
                  "currentTrackMilliseconds": 2000,
                  "currentTrackWholeNotes": 1.75,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 95,
                      "start": 1.75,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 76,
                      "endChar": 77,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 77,
                  "endChar": 78,
                  "currentTrackMilliseconds": 2142.8571428571427,
                  "currentTrackWholeNotes": 1.875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 1.875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 77,
                      "endChar": 78,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 78,
                  "endChar": 79,
                  "currentTrackMilliseconds": 2285.7142857142862,
                  "currentTrackWholeNotes": 2,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 95,
                      "start": 2,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 78,
                      "endChar": 79,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 79,
                  "endChar": 80,
                  "endBeam": true,
                  "currentTrackMilliseconds": 2428.571428571429,
                  "currentTrackWholeNotes": 2.125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 2.125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 79,
                      "endChar": 80,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 80,
                  "endChar": 81
                },
                {
                  "chord": [
                    {
                      "name": "Bm",
                      "position": "default"
                    }
                  ],
                  "duration": 0.125,
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    },
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "el_type": "note",
                  "startChar": 81,
                  "endChar": 89,
                  "currentTrackMilliseconds": 2571.4285714285716,
                  "currentTrackWholeNotes": 2.25,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 105,
                      "start": 2.25,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 81,
                      "endChar": 89,
                      "gap": 0
                    },
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 105,
                      "start": 2.25,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 81,
                      "endChar": 89,
                      "gap": 0
                    }
                  ]
                },
                {
                  "duration": 0.25,
                  "pitches": [
                    {
                      "pitch": 13,
                      "name": "b",
                      "verticalPos": 13
                    },
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "el_type": "note",
                  "startChar": 89,
                  "endChar": 95,
                  "currentTrackMilliseconds": 2714.285714285714,
                  "currentTrackWholeNotes": 2.375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 83,
                      "volume": 85,
                      "start": 2.375,
                      "duration": 0.25,
                      "instrument": 0,
                      "startChar": 89,
                      "endChar": 95,
                      "gap": 0
                    },
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 85,
                      "start": 2.375,
                      "duration": 0.25,
                      "instrument": 0,
                      "startChar": 89,
                      "endChar": 95,
                      "gap": 0
                    }
                  ]
                },
                {
                  "duration": 0.125,
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    },
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "el_type": "note",
                  "startChar": 95,
                  "endChar": 100,
                  "currentTrackMilliseconds": 3000,
                  "currentTrackWholeNotes": 2.625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 2.625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 95,
                      "endChar": 100,
                      "gap": 0
                    },
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 85,
                      "start": 2.625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 95,
                      "endChar": 100,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 13,
                      "name": "b",
                      "verticalPos": 13
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 100,
                  "endChar": 101,
                  "startBeam": true,
                  "currentTrackMilliseconds": 3142.8571428571427,
                  "currentTrackWholeNotes": 2.75,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 83,
                      "volume": 95,
                      "start": 2.75,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 100,
                      "endChar": 101,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 101,
                  "endChar": 102,
                  "currentTrackMilliseconds": 3285.714285714286,
                  "currentTrackWholeNotes": 2.875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 2.875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 101,
                      "endChar": 102,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 13,
                      "name": "b",
                      "verticalPos": 13
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 102,
                  "endChar": 103,
                  "currentTrackMilliseconds": 3428.5714285714284,
                  "currentTrackWholeNotes": 3,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 83,
                      "volume": 95,
                      "start": 3,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 102,
                      "endChar": 103,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 103,
                  "endChar": 104,
                  "endBeam": true,
                  "currentTrackMilliseconds": 3571.428571428571,
                  "currentTrackWholeNotes": 3.125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 3.125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 103,
                      "endChar": 104,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 104,
                  "endChar": 105
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 105,
                  "endChar": 106,
                  "startBeam": true,
                  "currentTrackMilliseconds": 3714.285714285714,
                  "currentTrackWholeNotes": 3.25,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 105,
                      "start": 3.25,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 105,
                      "endChar": 106,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 106,
                  "endChar": 107,
                  "currentTrackMilliseconds": 3857.142857142857,
                  "currentTrackWholeNotes": 3.375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 3.375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 106,
                      "endChar": 107,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 107,
                  "endChar": 108,
                  "currentTrackMilliseconds": 4000,
                  "currentTrackWholeNotes": 3.5,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 95,
                      "start": 3.5,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 107,
                      "endChar": 108,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 108,
                  "endChar": 110,
                  "endBeam": true,
                  "currentTrackMilliseconds": 4142.857142857143,
                  "currentTrackWholeNotes": 3.625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 85,
                      "start": 3.625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 108,
                      "endChar": 110,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 110,
                  "endChar": 111,
                  "startBeam": true,
                  "currentTrackMilliseconds": 4285.714285714285,
                  "currentTrackWholeNotes": 3.75,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 95,
                      "start": 3.75,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 110,
                      "endChar": 111,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 111,
                  "endChar": 112,
                  "currentTrackMilliseconds": 4428.571428571428,
                  "currentTrackWholeNotes": 3.875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 3.875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 111,
                      "endChar": 112,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 112,
                  "endChar": 113,
                  "currentTrackMilliseconds": 4571.4285714285725,
                  "currentTrackWholeNotes": 4,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 95,
                      "start": 4,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 112,
                      "endChar": 113,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 11,
                      "name": "g",
                      "verticalPos": 11
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 113,
                  "endChar": 114,
                  "endBeam": true,
                  "currentTrackMilliseconds": 4714.285714285715,
                  "currentTrackWholeNotes": 4.125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 79,
                      "volume": 85,
                      "start": 4.125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 113,
                      "endChar": 114,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 114,
                  "endChar": 115
                }
              ]
            ],
            "clef": {
              "type": "treble",
              "verticalPos": 0,
              "clefPos": 4
            },
            "key": {
              "accidentals": [
                {
                  "acc": "sharp",
                  "note": "f",
                  "verticalPos": 10
                },
                {
                  "acc": "sharp",
                  "note": "c",
                  "verticalPos": 7
                }
              ],
              "root": "D",
              "acc": "",
              "mode": ""
            },
            "meter": {
              "type": "specified",
              "value": [
                {
                  "num": "4",
                  "den": "4"
                }
              ]
            }
          }
        ]
      },
      {
        "staff": [
          {
            "voices": [
              [
                {
                  "chord": [
                    {
                      "name": "D",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 116,
                  "endChar": 120,
                  "startBeam": true,
                  "currentTrackMilliseconds": 4857.142857142858,
                  "currentTrackWholeNotes": 4.25,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 105,
                      "start": 4.25,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 116,
                      "endChar": 120,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "accidental": "sharp",
                      "pitch": 11,
                      "name": "^g",
                      "verticalPos": 11
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 120,
                  "endChar": 122,
                  "currentTrackMilliseconds": 5000,
                  "currentTrackWholeNotes": 4.375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 80,
                      "volume": 85,
                      "start": 4.375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 120,
                      "endChar": 122,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 13,
                      "name": "b",
                      "verticalPos": 13
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 122,
                  "endChar": 123,
                  "currentTrackMilliseconds": 5142.857142857143,
                  "currentTrackWholeNotes": 4.5,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 83,
                      "volume": 95,
                      "start": 4.5,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 122,
                      "endChar": 123,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 11,
                      "name": "g",
                      "verticalPos": 11
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 123,
                  "endChar": 125,
                  "endBeam": true,
                  "currentTrackMilliseconds": 5285.714285714286,
                  "currentTrackWholeNotes": 4.625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 80,
                      "volume": 85,
                      "start": 4.625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 123,
                      "endChar": 125,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 125,
                  "endChar": 126,
                  "startBeam": true,
                  "currentTrackMilliseconds": 5428.571428571428,
                  "currentTrackWholeNotes": 4.75,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 95,
                      "start": 4.75,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 125,
                      "endChar": 126,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 126,
                  "endChar": 127,
                  "currentTrackMilliseconds": 5571.428571428572,
                  "currentTrackWholeNotes": 4.875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 4.875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 126,
                      "endChar": 127,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 127,
                  "endChar": 128,
                  "currentTrackMilliseconds": 5714.285714285714,
                  "currentTrackWholeNotes": 5,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 95,
                      "start": 5,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 127,
                      "endChar": 128,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 128,
                  "endChar": 129,
                  "endBeam": true,
                  "currentTrackMilliseconds": 5857.142857142857,
                  "currentTrackWholeNotes": 5.125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 85,
                      "start": 5.125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 128,
                      "endChar": 129,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 129,
                  "endChar": 130
                },
                {
                  "chord": [
                    {
                      "name": "G",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 130,
                  "endChar": 134,
                  "startBeam": true,
                  "currentTrackMilliseconds": 6000,
                  "currentTrackWholeNotes": 5.25,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 105,
                      "start": 5.25,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 130,
                      "endChar": 134,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 7,
                      "name": "c",
                      "verticalPos": 7
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 134,
                  "endChar": 135,
                  "currentTrackMilliseconds": 6142.857142857142,
                  "currentTrackWholeNotes": 5.375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 73,
                      "volume": 85,
                      "start": 5.375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 134,
                      "endChar": 135,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 135,
                  "endChar": 136,
                  "currentTrackMilliseconds": 6285.714285714285,
                  "currentTrackWholeNotes": 5.5,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 95,
                      "start": 5.5,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 135,
                      "endChar": 136,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 136,
                  "endChar": 138,
                  "endBeam": true,
                  "currentTrackMilliseconds": 6428.5714285714275,
                  "currentTrackWholeNotes": 5.625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 5.625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 136,
                      "endChar": 138,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 138,
                  "endChar": 139,
                  "startBeam": true,
                  "currentTrackMilliseconds": 6571.428571428572,
                  "currentTrackWholeNotes": 5.75,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 95,
                      "start": 5.75,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 138,
                      "endChar": 139,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 7,
                      "name": "c",
                      "verticalPos": 7
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 139,
                  "endChar": 140,
                  "currentTrackMilliseconds": 6714.285714285715,
                  "currentTrackWholeNotes": 5.875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 73,
                      "volume": 85,
                      "start": 5.875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 139,
                      "endChar": 140,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 140,
                  "endChar": 141,
                  "currentTrackMilliseconds": 6857.142857142857,
                  "currentTrackWholeNotes": 6,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 95,
                      "start": 6,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 140,
                      "endChar": 141,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 141,
                  "endChar": 142,
                  "endBeam": true,
                  "currentTrackMilliseconds": 7000,
                  "currentTrackWholeNotes": 6.125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 85,
                      "start": 6.125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 141,
                      "endChar": 142,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 142,
                  "endChar": 143
                },
                {
                  "chord": [
                    {
                      "name": "A7",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 143,
                  "endChar": 148,
                  "startBeam": true,
                  "currentTrackMilliseconds": 7142.857142857142,
                  "currentTrackWholeNotes": 6.25,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 105,
                      "start": 6.25,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 143,
                      "endChar": 148,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 148,
                  "endChar": 149,
                  "currentTrackMilliseconds": 7285.714285714285,
                  "currentTrackWholeNotes": 6.375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 85,
                      "start": 6.375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 148,
                      "endChar": 149,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 149,
                  "endChar": 150,
                  "currentTrackMilliseconds": 7428.571428571428,
                  "currentTrackWholeNotes": 6.5,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 95,
                      "start": 6.5,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 149,
                      "endChar": 150,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 150,
                  "endChar": 152,
                  "endBeam": true,
                  "currentTrackMilliseconds": 7571.428571428572,
                  "currentTrackWholeNotes": 6.625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 6.625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 150,
                      "endChar": 152,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 7,
                      "name": "c",
                      "verticalPos": 7
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 152,
                  "endChar": 153,
                  "startBeam": true,
                  "currentTrackMilliseconds": 7714.285714285714,
                  "currentTrackWholeNotes": 6.75,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 73,
                      "volume": 95,
                      "start": 6.75,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 152,
                      "endChar": 153,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 153,
                  "endChar": 154,
                  "currentTrackMilliseconds": 7857.142857142858,
                  "currentTrackWholeNotes": 6.875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 85,
                      "start": 6.875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 153,
                      "endChar": 154,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 154,
                  "endChar": 155,
                  "currentTrackMilliseconds": 8000,
                  "currentTrackWholeNotes": 7,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 95,
                      "start": 7,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 154,
                      "endChar": 155,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 155,
                  "endChar": 156,
                  "endBeam": true,
                  "currentTrackMilliseconds": 8142.857142857142,
                  "currentTrackWholeNotes": 7.125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 85,
                      "start": 7.125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 155,
                      "endChar": 156,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 156,
                  "endChar": 157
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 157,
                  "endChar": 158,
                  "startBeam": true,
                  "currentTrackMilliseconds": 8285.714285714286,
                  "currentTrackWholeNotes": 7.25,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 105,
                      "start": 7.25,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 157,
                      "endChar": 158,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 158,
                  "endChar": 159,
                  "currentTrackMilliseconds": 8428.57142857143,
                  "currentTrackWholeNotes": 7.375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 85,
                      "start": 7.375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 158,
                      "endChar": 159,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 2,
                      "name": "E",
                      "verticalPos": 2
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 159,
                  "endChar": 160,
                  "currentTrackMilliseconds": 8571.42857142857,
                  "currentTrackWholeNotes": 7.5,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 64,
                      "volume": 95,
                      "start": 7.5,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 159,
                      "endChar": 160,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 4,
                      "name": "G",
                      "verticalPos": 4
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 160,
                  "endChar": 162,
                  "endBeam": true,
                  "currentTrackMilliseconds": 8714.285714285716,
                  "currentTrackWholeNotes": 7.625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 67,
                      "volume": 85,
                      "start": 7.625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 160,
                      "endChar": 162,
                      "gap": 0
                    }
                  ]
                },
                {
                  "chord": [
                    {
                      "name": "D",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 162,
                  "endChar": 166,
                  "currentTrackMilliseconds": 8857.142857142857,
                  "currentTrackWholeNotes": 7.75,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 95,
                      "start": 7.75,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 162,
                      "endChar": 166,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.375,
                  "el_type": "note",
                  "startChar": 166,
                  "endChar": 168,
                  "currentTrackMilliseconds": 9000,
                  "currentTrackWholeNotes": 7.875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 7.875,
                      "duration": 0.375,
                      "instrument": 0,
                      "startChar": 166,
                      "endChar": 168,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 168,
                  "endChar": 169
                }
              ]
            ],
            "clef": {
              "type": "treble",
              "verticalPos": 0,
              "clefPos": 4
            },
            "key": {
              "accidentals": [
                {
                  "acc": "sharp",
                  "note": "f",
                  "verticalPos": 10
                },
                {
                  "acc": "sharp",
                  "note": "c",
                  "verticalPos": 7
                }
              ],
              "root": "D",
              "acc": "",
              "mode": ""
            }
          }
        ]
      },
      {
        "staff": [
          {
            "voices": [
              [
                {
                  "chord": [
                    {
                      "name": "D",
                      "position": "default"
                    }
                  ],
                  "duration": 0.125,
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    },
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "el_type": "note",
                  "startChar": 170,
                  "endChar": 177,
                  "currentTrackMilliseconds": 9428.57142857143,
                  "currentTrackWholeNotes": 8.25,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 105,
                      "start": 8.25,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 170,
                      "endChar": 177,
                      "gap": 0
                    },
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 105,
                      "start": 8.25,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 170,
                      "endChar": 177,
                      "gap": 0
                    }
                  ]
                },
                {
                  "duration": 0.25,
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    },
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "el_type": "note",
                  "startChar": 177,
                  "endChar": 183,
                  "currentTrackMilliseconds": 9571.42857142857,
                  "currentTrackWholeNotes": 8.375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 85,
                      "start": 8.375,
                      "duration": 0.25,
                      "instrument": 0,
                      "startChar": 177,
                      "endChar": 183,
                      "gap": 0
                    },
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 8.375,
                      "duration": 0.25,
                      "instrument": 0,
                      "startChar": 177,
                      "endChar": 183,
                      "gap": 0
                    }
                  ]
                },
                {
                  "duration": 0.125,
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    },
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "el_type": "note",
                  "startChar": 183,
                  "endChar": 188,
                  "currentTrackMilliseconds": 9857.142857142857,
                  "currentTrackWholeNotes": 8.625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 8.625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 183,
                      "endChar": 188,
                      "gap": 0
                    },
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 8.625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 183,
                      "endChar": 188,
                      "gap": 0
                    }
                  ]
                },
                {
                  "duration": 0.5,
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    },
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "el_type": "note",
                  "startChar": 188,
                  "endChar": 194,
                  "currentTrackMilliseconds": 10000,
                  "currentTrackWholeNotes": 8.75,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 95,
                      "start": 8.75,
                      "duration": 0.5,
                      "instrument": 0,
                      "startChar": 188,
                      "endChar": 194,
                      "gap": 0
                    },
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 95,
                      "start": 8.75,
                      "duration": 0.5,
                      "instrument": 0,
                      "startChar": 188,
                      "endChar": 194,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 194,
                  "endChar": 195
                },
                {
                  "startTriplet": 3,
                  "tripletMultiplier": 0.6666666666666666,
                  "tripletR": 3,
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.0625,
                  "el_type": "note",
                  "startChar": 195,
                  "endChar": 199,
                  "startBeam": true,
                  "currentTrackMilliseconds": 10571.428571428572,
                  "currentTrackWholeNotes": 9.25,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 105,
                      "start": 9.25,
                      "duration": 0.041667,
                      "instrument": 0,
                      "startChar": 195,
                      "endChar": 199,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.0625,
                  "el_type": "note",
                  "startChar": 199,
                  "endChar": 201,
                  "currentTrackMilliseconds": 10619.048,
                  "currentTrackWholeNotes": 9.291667,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 9.291667,
                      "duration": 0.041667,
                      "instrument": 0,
                      "startChar": 199,
                      "endChar": 201,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 11,
                      "name": "g",
                      "verticalPos": 11
                    }
                  ],
                  "duration": 0.0625,
                  "endTriplet": true,
                  "el_type": "note",
                  "startChar": 201,
                  "endChar": 203,
                  "currentTrackMilliseconds": 10666.667428571429,
                  "currentTrackWholeNotes": 9.333334,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 79,
                      "volume": 85,
                      "start": 9.333334,
                      "duration": 0.041666,
                      "instrument": 0,
                      "startChar": 201,
                      "endChar": 203,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 203,
                  "endChar": 205,
                  "endBeam": true,
                  "currentTrackMilliseconds": 10714.285714285716,
                  "currentTrackWholeNotes": 9.375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 85,
                      "start": 9.375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 203,
                      "endChar": 205,
                      "gap": 0
                    }
                  ]
                },
                {
                  "startTriplet": 4,
                  "tripletMultiplier": 0.75,
                  "tripletR": 4,
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.0625,
                  "el_type": "note",
                  "startChar": 205,
                  "endChar": 209,
                  "startBeam": true,
                  "currentTrackMilliseconds": 10857.142857142857,
                  "currentTrackWholeNotes": 9.5,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 95,
                      "start": 9.5,
                      "duration": 0.046875,
                      "instrument": 0,
                      "startChar": 205,
                      "endChar": 209,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 11,
                      "name": "g",
                      "verticalPos": 11
                    }
                  ],
                  "duration": 0.0625,
                  "el_type": "note",
                  "startChar": 209,
                  "endChar": 211,
                  "currentTrackMilliseconds": 10910.714285714284,
                  "currentTrackWholeNotes": 9.546875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 79,
                      "volume": 85,
                      "start": 9.546875,
                      "duration": 0.046875,
                      "instrument": 0,
                      "startChar": 209,
                      "endChar": 211,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.0625,
                  "el_type": "note",
                  "startChar": 211,
                  "endChar": 213,
                  "currentTrackMilliseconds": 10964.285714285714,
                  "currentTrackWholeNotes": 9.59375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 9.59375,
                      "duration": 0.046875,
                      "instrument": 0,
                      "startChar": 211,
                      "endChar": 213,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "endTriplet": true,
                  "el_type": "note",
                  "startChar": 213,
                  "endChar": 215,
                  "endBeam": true,
                  "currentTrackMilliseconds": 11017.857142857145,
                  "currentTrackWholeNotes": 9.640625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 85,
                      "start": 9.640625,
                      "duration": 0.046875,
                      "instrument": 0,
                      "startChar": 213,
                      "endChar": 215,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.375,
                  "el_type": "note",
                  "startChar": 215,
                  "endChar": 217,
                  "currentTrackMilliseconds": 11071.428571428572,
                  "currentTrackWholeNotes": 9.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 9.6875,
                      "duration": 0.375,
                      "instrument": 0,
                      "startChar": 215,
                      "endChar": 217,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 217,
                  "endChar": 218
                },
                {
                  "chord": [
                    {
                      "name": "Bm",
                      "position": "default"
                    }
                  ],
                  "startTriplet": 3,
                  "tripletMultiplier": 0.6666666666666666,
                  "tripletR": 3,
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.0625,
                  "el_type": "note",
                  "startChar": 218,
                  "endChar": 226,
                  "startBeam": true,
                  "currentTrackMilliseconds": 11500,
                  "currentTrackWholeNotes": 10.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 105,
                      "start": 10.0625,
                      "duration": 0.041667,
                      "instrument": 0,
                      "startChar": 218,
                      "endChar": 226,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 11,
                      "name": "g",
                      "verticalPos": 11
                    }
                  ],
                  "duration": 0.0625,
                  "el_type": "note",
                  "startChar": 226,
                  "endChar": 228,
                  "currentTrackMilliseconds": 11547.61942857143,
                  "currentTrackWholeNotes": 10.104167,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 79,
                      "volume": 85,
                      "start": 10.104167,
                      "duration": 0.041667,
                      "instrument": 0,
                      "startChar": 226,
                      "endChar": 228,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.0625,
                  "endTriplet": true,
                  "el_type": "note",
                  "startChar": 228,
                  "endChar": 230,
                  "currentTrackMilliseconds": 11595.238857142858,
                  "currentTrackWholeNotes": 10.145834,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 85,
                      "start": 10.145834,
                      "duration": 0.041666,
                      "instrument": 0,
                      "startChar": 228,
                      "endChar": 230,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 13,
                      "name": "b",
                      "verticalPos": 13
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 230,
                  "endChar": 232,
                  "endBeam": true,
                  "currentTrackMilliseconds": 11642.857142857143,
                  "currentTrackWholeNotes": 10.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 83,
                      "volume": 85,
                      "start": 10.1875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 230,
                      "endChar": 232,
                      "gap": 0
                    }
                  ]
                },
                {
                  "startTriplet": 3,
                  "tripletMultiplier": 0.6666666666666666,
                  "tripletR": 3,
                  "pitches": [
                    {
                      "pitch": 13,
                      "name": "b",
                      "verticalPos": 13
                    }
                  ],
                  "duration": 0.0625,
                  "el_type": "note",
                  "startChar": 232,
                  "endChar": 236,
                  "startBeam": true,
                  "currentTrackMilliseconds": 11785.714285714284,
                  "currentTrackWholeNotes": 10.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 83,
                      "volume": 95,
                      "start": 10.3125,
                      "duration": 0.041667,
                      "instrument": 0,
                      "startChar": 232,
                      "endChar": 236,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.0625,
                  "el_type": "note",
                  "startChar": 236,
                  "endChar": 238,
                  "currentTrackMilliseconds": 11833.333714285714,
                  "currentTrackWholeNotes": 10.354167,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 85,
                      "start": 10.354167,
                      "duration": 0.041667,
                      "instrument": 0,
                      "startChar": 236,
                      "endChar": 238,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 11,
                      "name": "g",
                      "verticalPos": 11
                    }
                  ],
                  "duration": 0.0625,
                  "endTriplet": true,
                  "el_type": "note",
                  "startChar": 238,
                  "endChar": 241,
                  "endBeam": true,
                  "currentTrackMilliseconds": 11880.953142857143,
                  "currentTrackWholeNotes": 10.395834,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 79,
                      "volume": 85,
                      "start": 10.395834,
                      "duration": 0.041666,
                      "instrument": 0,
                      "startChar": 238,
                      "endChar": 241,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.5,
                  "el_type": "note",
                  "startChar": 241,
                  "endChar": 243,
                  "currentTrackMilliseconds": 11928.571428571428,
                  "currentTrackWholeNotes": 10.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 10.4375,
                      "duration": 0.5,
                      "instrument": 0,
                      "startChar": 241,
                      "endChar": 243,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 243,
                  "endChar": 244
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 244,
                  "endChar": 245,
                  "startBeam": true,
                  "currentTrackMilliseconds": 12500,
                  "currentTrackWholeNotes": 10.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 105,
                      "start": 10.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 244,
                      "endChar": 245,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 13,
                      "name": "b",
                      "verticalPos": 13
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 245,
                  "endChar": 246,
                  "currentTrackMilliseconds": 12642.857142857143,
                  "currentTrackWholeNotes": 11.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 83,
                      "volume": 85,
                      "start": 11.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 245,
                      "endChar": 246,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 246,
                  "endChar": 247,
                  "currentTrackMilliseconds": 12785.714285714284,
                  "currentTrackWholeNotes": 11.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 95,
                      "start": 11.1875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 246,
                      "endChar": 247,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 247,
                  "endChar": 249,
                  "endBeam": true,
                  "currentTrackMilliseconds": 12928.57142857143,
                  "currentTrackWholeNotes": 11.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 85,
                      "start": 11.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 247,
                      "endChar": 249,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 249,
                  "endChar": 250,
                  "startBeam": true,
                  "currentTrackMilliseconds": 13071.42857142857,
                  "currentTrackWholeNotes": 11.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 95,
                      "start": 11.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 249,
                      "endChar": 250,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 250,
                  "endChar": 251,
                  "currentTrackMilliseconds": 13214.285714285714,
                  "currentTrackWholeNotes": 11.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 11.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 250,
                      "endChar": 251,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 251,
                  "endChar": 252,
                  "currentTrackMilliseconds": 13357.142857142855,
                  "currentTrackWholeNotes": 11.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 95,
                      "start": 11.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 251,
                      "endChar": 252,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 252,
                  "endChar": 253,
                  "endBeam": true,
                  "currentTrackMilliseconds": 13500,
                  "currentTrackWholeNotes": 11.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 11.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 252,
                      "endChar": 253,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 253,
                  "endChar": 254
                }
              ]
            ],
            "clef": {
              "type": "treble",
              "verticalPos": 0,
              "clefPos": 4
            },
            "key": {
              "accidentals": [
                {
                  "acc": "sharp",
                  "note": "f",
                  "verticalPos": 10
                },
                {
                  "acc": "sharp",
                  "note": "c",
                  "verticalPos": 7
                }
              ],
              "root": "D",
              "acc": "",
              "mode": ""
            }
          }
        ]
      },
      {
        "staff": [
          {
            "voices": [
              [
                {
                  "chord": [
                    {
                      "name": "D",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 255,
                  "endChar": 259,
                  "startBeam": true,
                  "currentTrackMilliseconds": 13642.857142857143,
                  "currentTrackWholeNotes": 11.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 105,
                      "start": 11.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 255,
                      "endChar": 259,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 259,
                  "endChar": 260,
                  "currentTrackMilliseconds": 13785.714285714284,
                  "currentTrackWholeNotes": 12.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 85,
                      "start": 12.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 259,
                      "endChar": 260,
                      "gap": 0
                    }
                  ]
                },
                {
                  "rest": {
                    "type": "rest"
                  },
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 260,
                  "endChar": 261,
                  "currentTrackMilliseconds": 13928.57142857143,
                  "currentTrackWholeNotes": 12.1875
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 261,
                  "endChar": 263,
                  "endBeam": true,
                  "currentTrackMilliseconds": 14071.42857142857,
                  "currentTrackWholeNotes": 12.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 12.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 261,
                      "endChar": 263,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 263,
                  "endChar": 264,
                  "startBeam": true,
                  "currentTrackMilliseconds": 14214.285714285714,
                  "currentTrackWholeNotes": 12.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 95,
                      "start": 12.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 263,
                      "endChar": 264,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 264,
                  "endChar": 265,
                  "currentTrackMilliseconds": 14357.142857142857,
                  "currentTrackWholeNotes": 12.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 12.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 264,
                      "endChar": 265,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 13,
                      "name": "b",
                      "verticalPos": 13
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 265,
                  "endChar": 266,
                  "currentTrackMilliseconds": 14500,
                  "currentTrackWholeNotes": 12.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 83,
                      "volume": 95,
                      "start": 12.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 265,
                      "endChar": 266,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 266,
                  "endChar": 267,
                  "endBeam": true,
                  "currentTrackMilliseconds": 14642.857142857143,
                  "currentTrackWholeNotes": 12.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 12.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 266,
                      "endChar": 267,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 267,
                  "endChar": 268
                },
                {
                  "chord": [
                    {
                      "name": "G",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 268,
                  "endChar": 272,
                  "startBeam": true,
                  "currentTrackMilliseconds": 14785.714285714286,
                  "currentTrackWholeNotes": 12.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 105,
                      "start": 12.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 268,
                      "endChar": 272,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 272,
                  "endChar": 273,
                  "currentTrackMilliseconds": 14928.57142857143,
                  "currentTrackWholeNotes": 13.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 13.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 272,
                      "endChar": 273,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 273,
                  "endChar": 274,
                  "currentTrackMilliseconds": 15071.42857142857,
                  "currentTrackWholeNotes": 13.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 95,
                      "start": 13.1875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 273,
                      "endChar": 274,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 274,
                  "endChar": 276,
                  "endBeam": true,
                  "currentTrackMilliseconds": 15214.285714285714,
                  "currentTrackWholeNotes": 13.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 85,
                      "start": 13.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 274,
                      "endChar": 276,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 276,
                  "endChar": 277,
                  "startBeam": true,
                  "currentTrackMilliseconds": 15357.142857142855,
                  "currentTrackWholeNotes": 13.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 95,
                      "start": 13.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 276,
                      "endChar": 277,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 277,
                  "endChar": 278,
                  "currentTrackMilliseconds": 15500.000000000002,
                  "currentTrackWholeNotes": 13.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 13.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 277,
                      "endChar": 278,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 278,
                  "endChar": 279,
                  "currentTrackMilliseconds": 15642.857142857145,
                  "currentTrackWholeNotes": 13.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 95,
                      "start": 13.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 278,
                      "endChar": 279,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 279,
                  "endChar": 280,
                  "endBeam": true,
                  "currentTrackMilliseconds": 15785.714285714286,
                  "currentTrackWholeNotes": 13.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 13.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 279,
                      "endChar": 280,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 280,
                  "endChar": 281
                },
                {
                  "chord": [
                    {
                      "name": "A7",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 281,
                  "endChar": 286,
                  "startBeam": true,
                  "currentTrackMilliseconds": 15928.57142857143,
                  "currentTrackWholeNotes": 13.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 105,
                      "start": 13.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 281,
                      "endChar": 286,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 7,
                      "name": "c",
                      "verticalPos": 7
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 286,
                  "endChar": 287,
                  "currentTrackMilliseconds": 16071.428571428569,
                  "currentTrackWholeNotes": 14.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 73,
                      "volume": 85,
                      "start": 14.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 286,
                      "endChar": 287,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 287,
                  "endChar": 288,
                  "currentTrackMilliseconds": 16214.285714285712,
                  "currentTrackWholeNotes": 14.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 95,
                      "start": 14.1875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 287,
                      "endChar": 288,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 288,
                  "endChar": 290,
                  "endBeam": true,
                  "currentTrackMilliseconds": 16357.142857142853,
                  "currentTrackWholeNotes": 14.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 14.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 288,
                      "endChar": 290,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 290,
                  "endChar": 291,
                  "startBeam": true,
                  "currentTrackMilliseconds": 16500,
                  "currentTrackWholeNotes": 14.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 95,
                      "start": 14.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 290,
                      "endChar": 291,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 291,
                  "endChar": 292,
                  "currentTrackMilliseconds": 16642.85714285714,
                  "currentTrackWholeNotes": 14.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 14.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 291,
                      "endChar": 292,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 292,
                  "endChar": 293,
                  "currentTrackMilliseconds": 16785.714285714286,
                  "currentTrackWholeNotes": 14.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 95,
                      "start": 14.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 292,
                      "endChar": 293,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 293,
                  "endChar": 294,
                  "endBeam": true,
                  "currentTrackMilliseconds": 16928.571428571428,
                  "currentTrackWholeNotes": 14.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 85,
                      "start": 14.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 293,
                      "endChar": 294,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 294,
                  "endChar": 295
                },
                {
                  "pitches": [
                    {
                      "pitch": 2,
                      "name": "E",
                      "verticalPos": 2
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 295,
                  "endChar": 296,
                  "startBeam": true,
                  "currentTrackMilliseconds": 17071.42857142857,
                  "currentTrackWholeNotes": 14.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 64,
                      "volume": 105,
                      "start": 14.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 295,
                      "endChar": 296,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 296,
                  "endChar": 297,
                  "currentTrackMilliseconds": 17214.28571428571,
                  "currentTrackWholeNotes": 15.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 15.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 296,
                      "endChar": 297,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": -1,
                      "name": "B,",
                      "verticalPos": -1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 297,
                  "endChar": 299,
                  "currentTrackMilliseconds": 17357.14285714286,
                  "currentTrackWholeNotes": 15.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 59,
                      "volume": 95,
                      "start": 15.1875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 297,
                      "endChar": 299,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 299,
                  "endChar": 301,
                  "endBeam": true,
                  "currentTrackMilliseconds": 17500,
                  "currentTrackWholeNotes": 15.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 15.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 299,
                      "endChar": 301,
                      "gap": 0
                    }
                  ]
                },
                {
                  "chord": [
                    {
                      "name": "D",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": -2,
                      "name": "A,",
                      "verticalPos": -2
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 301,
                  "endChar": 306,
                  "currentTrackMilliseconds": 17642.85714285714,
                  "currentTrackWholeNotes": 15.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 57,
                      "volume": 95,
                      "start": 15.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 301,
                      "endChar": 306,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.375,
                  "el_type": "note",
                  "startChar": 306,
                  "endChar": 308,
                  "currentTrackMilliseconds": 17785.714285714286,
                  "currentTrackWholeNotes": 15.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 15.5625,
                      "duration": 0.375,
                      "instrument": 0,
                      "startChar": 306,
                      "endChar": 308,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 308,
                  "endChar": 309
                }
              ]
            ],
            "clef": {
              "type": "treble",
              "verticalPos": 0,
              "clefPos": 4
            },
            "key": {
              "accidentals": [
                {
                  "acc": "sharp",
                  "note": "f",
                  "verticalPos": 10
                },
                {
                  "acc": "sharp",
                  "note": "c",
                  "verticalPos": 7
                }
              ],
              "root": "D",
              "acc": "",
              "mode": ""
            }
          }
        ]
      },
      {
        "staff": [
          {
            "voices": [
              [
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 310,
                  "endChar": 311,
                  "startBeam": true,
                  "currentTrackMilliseconds": 18214.28571428571,
                  "currentTrackWholeNotes": 15.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 105,
                      "start": 15.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 310,
                      "endChar": 311,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 311,
                  "endChar": 312,
                  "currentTrackMilliseconds": 18357.14285714286,
                  "currentTrackWholeNotes": 16.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 16.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 311,
                      "endChar": 312,
                      "gap": 0
                    }
                  ]
                },
                {
                  "rest": {
                    "type": "rest"
                  },
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 312,
                  "endChar": 313,
                  "currentTrackMilliseconds": 18500,
                  "currentTrackWholeNotes": 16.1875
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 313,
                  "endChar": 315,
                  "endBeam": true,
                  "currentTrackMilliseconds": 18642.85714285714,
                  "currentTrackWholeNotes": 16.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 85,
                      "start": 16.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 313,
                      "endChar": 315,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 315,
                  "endChar": 316,
                  "startBeam": true,
                  "currentTrackMilliseconds": 18785.714285714286,
                  "currentTrackWholeNotes": 16.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 95,
                      "start": 16.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 315,
                      "endChar": 316,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 316,
                  "endChar": 317,
                  "currentTrackMilliseconds": 18928.571428571428,
                  "currentTrackWholeNotes": 16.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 85,
                      "start": 16.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 316,
                      "endChar": 317,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 317,
                  "endChar": 318,
                  "currentTrackMilliseconds": 19071.42857142857,
                  "currentTrackWholeNotes": 16.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 95,
                      "start": 16.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 317,
                      "endChar": 318,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 318,
                  "endChar": 319,
                  "endBeam": true,
                  "currentTrackMilliseconds": 19214.28571428571,
                  "currentTrackWholeNotes": 16.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 16.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 318,
                      "endChar": 319,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 319,
                  "endChar": 320
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 320,
                  "endChar": 321,
                  "startBeam": true,
                  "currentTrackMilliseconds": 19357.14285714286,
                  "currentTrackWholeNotes": 16.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 105,
                      "start": 16.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 320,
                      "endChar": 321,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 321,
                  "endChar": 322,
                  "currentTrackMilliseconds": 19500,
                  "currentTrackWholeNotes": 17.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 17.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 321,
                      "endChar": 322,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 322,
                  "endChar": 323,
                  "currentTrackMilliseconds": 19642.85714285714,
                  "currentTrackWholeNotes": 17.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 95,
                      "start": 17.1875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 322,
                      "endChar": 323,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 323,
                  "endChar": 325,
                  "endBeam": true,
                  "currentTrackMilliseconds": 19785.714285714286,
                  "currentTrackWholeNotes": 17.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 17.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 323,
                      "endChar": 325,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 325,
                  "endChar": 326,
                  "startBeam": true,
                  "currentTrackMilliseconds": 19928.571428571428,
                  "currentTrackWholeNotes": 17.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 95,
                      "start": 17.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 325,
                      "endChar": 326,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 7,
                      "name": "c",
                      "verticalPos": 7
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 326,
                  "endChar": 327,
                  "endBeam": true,
                  "currentTrackMilliseconds": 20071.42857142857,
                  "currentTrackWholeNotes": 17.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 73,
                      "volume": 85,
                      "start": 17.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 326,
                      "endChar": 327,
                      "gap": 0
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.25,
                  "el_type": "note",
                  "startChar": 327,
                  "endChar": 329,
                  "currentTrackMilliseconds": 20214.285714285714,
                  "currentTrackWholeNotes": 17.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 95,
                      "start": 17.6875,
                      "duration": 0.25,
                      "instrument": 0,
                      "startChar": 327,
                      "endChar": 329,
                      "gap": 0
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 329,
                  "endChar": 330
                },
                {
                  "pitches": [
                    {
                      "pitch": 0,
                      "name": "C",
                      "startSlur": [
                        {
                          "label": 101
                        }
                      ],
                      "verticalPos": 0
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 330,
                  "endChar": 332,
                  "currentTrackMilliseconds": 20500,
                  "currentTrackWholeNotes": 17.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 61,
                      "volume": 105,
                      "start": 17.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 330,
                      "endChar": 332,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "duration": 0.375,
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    },
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "endSlur": [
                    101
                  ],
                  "el_type": "note",
                  "startChar": 332,
                  "endChar": 341,
                  "currentTrackMilliseconds": 20642.85714285714,
                  "currentTrackWholeNotes": 18.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 18.0625,
                      "duration": 0.375,
                      "instrument": 0,
                      "startChar": 332,
                      "endChar": 341,
                      "endType": "tenuto",
                      "gap": -0.001
                    },
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 18.0625,
                      "duration": 0.375,
                      "instrument": 0,
                      "startChar": 332,
                      "endChar": 341,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 341,
                  "endChar": 342,
                  "startBeam": true,
                  "currentTrackMilliseconds": 21071.42857142857,
                  "currentTrackWholeNotes": 18.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 95,
                      "start": 18.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 341,
                      "endChar": 342,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 2,
                      "name": "E",
                      "verticalPos": 2
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 342,
                  "endChar": 343,
                  "currentTrackMilliseconds": 21214.285714285714,
                  "currentTrackWholeNotes": 18.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 64,
                      "volume": 85,
                      "start": 18.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 342,
                      "endChar": 343,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 343,
                  "endChar": 344,
                  "currentTrackMilliseconds": 21357.14285714286,
                  "currentTrackWholeNotes": 18.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 95,
                      "start": 18.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 343,
                      "endChar": 344,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 344,
                  "endChar": 345,
                  "endBeam": true,
                  "currentTrackMilliseconds": 21500,
                  "currentTrackWholeNotes": 18.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 18.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 344,
                      "endChar": 345,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 345,
                  "endChar": 346
                },
                {
                  "chord": [
                    {
                      "name": "A7",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 2,
                      "name": "E",
                      "verticalPos": 2
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 346,
                  "endChar": 351,
                  "currentTrackMilliseconds": 21642.85714285714,
                  "currentTrackWholeNotes": 18.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 64,
                      "volume": 105,
                      "start": 18.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 346,
                      "endChar": 351,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 4,
                      "name": "G",
                      "verticalPos": 4
                    }
                  ],
                  "duration": 0.25,
                  "el_type": "note",
                  "startChar": 351,
                  "endChar": 353,
                  "currentTrackMilliseconds": 21785.714285714286,
                  "currentTrackWholeNotes": 19.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 67,
                      "volume": 85,
                      "start": 19.0625,
                      "duration": 0.25,
                      "instrument": 0,
                      "startChar": 351,
                      "endChar": 353,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 0,
                      "name": "C",
                      "verticalPos": 0
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 353,
                  "endChar": 355,
                  "currentTrackMilliseconds": 22071.428571428572,
                  "currentTrackWholeNotes": 19.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 61,
                      "volume": 85,
                      "start": 19.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 353,
                      "endChar": 355,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": -2,
                      "name": "A,",
                      "verticalPos": -2
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 355,
                  "endChar": 357,
                  "startBeam": true,
                  "currentTrackMilliseconds": 22214.285714285714,
                  "currentTrackWholeNotes": 19.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 57,
                      "volume": 95,
                      "start": 19.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 355,
                      "endChar": 357,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 2,
                      "name": "E",
                      "verticalPos": 2
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 357,
                  "endChar": 358,
                  "currentTrackMilliseconds": 22357.14285714286,
                  "currentTrackWholeNotes": 19.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 64,
                      "volume": 85,
                      "start": 19.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 357,
                      "endChar": 358,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 0,
                      "name": "C",
                      "verticalPos": 0
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 358,
                  "endChar": 359,
                  "currentTrackMilliseconds": 22500,
                  "currentTrackWholeNotes": 19.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 61,
                      "volume": 95,
                      "start": 19.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 358,
                      "endChar": 359,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 2,
                      "name": "E",
                      "verticalPos": 2
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 359,
                  "endChar": 360,
                  "endBeam": true,
                  "currentTrackMilliseconds": 22642.85714285714,
                  "currentTrackWholeNotes": 19.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 64,
                      "volume": 85,
                      "start": 19.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 359,
                      "endChar": 360,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 360,
                  "endChar": 361
                }
              ]
            ],
            "clef": {
              "type": "treble",
              "verticalPos": 0,
              "clefPos": 4
            },
            "key": {
              "accidentals": [
                {
                  "acc": "sharp",
                  "note": "f",
                  "verticalPos": 10
                },
                {
                  "acc": "sharp",
                  "note": "c",
                  "verticalPos": 7
                }
              ],
              "root": "D",
              "acc": "",
              "mode": ""
            }
          }
        ]
      },
      {
        "staff": [
          {
            "voices": [
              [
                {
                  "chord": [
                    {
                      "name": "D",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 362,
                  "endChar": 366,
                  "startBeam": true,
                  "currentTrackMilliseconds": 22785.714285714286,
                  "currentTrackWholeNotes": 19.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 105,
                      "start": 19.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 362,
                      "endChar": 366,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 366,
                  "endChar": 367,
                  "currentTrackMilliseconds": 22928.571428571428,
                  "currentTrackWholeNotes": 20.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 20.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 366,
                      "endChar": 367,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 367,
                  "endChar": 368,
                  "currentTrackMilliseconds": 23071.428571428572,
                  "currentTrackWholeNotes": 20.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 95,
                      "start": 20.1875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 367,
                      "endChar": 368,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 368,
                  "endChar": 370,
                  "endBeam": true,
                  "currentTrackMilliseconds": 23214.285714285714,
                  "currentTrackWholeNotes": 20.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 20.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 368,
                      "endChar": 370,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.0625,
                  "el_type": "note",
                  "startChar": 370,
                  "endChar": 372,
                  "startBeam": true,
                  "currentTrackMilliseconds": 23357.14285714286,
                  "currentTrackWholeNotes": 20.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 95,
                      "start": 20.4375,
                      "duration": 0.0625,
                      "instrument": 0,
                      "startChar": 370,
                      "endChar": 372,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 4,
                      "name": "G",
                      "verticalPos": 4
                    }
                  ],
                  "duration": 0.0625,
                  "el_type": "note",
                  "startChar": 372,
                  "endChar": 374,
                  "currentTrackMilliseconds": 23428.571428571428,
                  "currentTrackWholeNotes": 20.5,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 67,
                      "volume": 85,
                      "start": 20.5,
                      "duration": 0.0625,
                      "instrument": 0,
                      "startChar": 372,
                      "endChar": 374,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 374,
                  "endChar": 376,
                  "endBeam": true,
                  "currentTrackMilliseconds": 23500,
                  "currentTrackWholeNotes": 20.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 85,
                      "start": 20.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 374,
                      "endChar": 376,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 376,
                  "endChar": 377,
                  "startBeam": true,
                  "currentTrackMilliseconds": 23642.85714285714,
                  "currentTrackWholeNotes": 20.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 95,
                      "start": 20.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 376,
                      "endChar": 377,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 377,
                  "endChar": 378,
                  "endBeam": true,
                  "currentTrackMilliseconds": 23785.714285714286,
                  "currentTrackWholeNotes": 20.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 85,
                      "start": 20.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 377,
                      "endChar": 378,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 378,
                  "endChar": 379
                },
                {
                  "chord": [
                    {
                      "name": "G",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 379,
                  "endChar": 383,
                  "startBeam": true,
                  "currentTrackMilliseconds": 23928.57142857143,
                  "currentTrackWholeNotes": 20.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 105,
                      "start": 20.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 379,
                      "endChar": 383,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 383,
                  "endChar": 384,
                  "currentTrackMilliseconds": 24071.428571428572,
                  "currentTrackWholeNotes": 21.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 21.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 383,
                      "endChar": 384,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 384,
                  "endChar": 385,
                  "currentTrackMilliseconds": 24214.285714285714,
                  "currentTrackWholeNotes": 21.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 95,
                      "start": 21.1875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 384,
                      "endChar": 385,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 385,
                  "endChar": 387,
                  "endBeam": true,
                  "currentTrackMilliseconds": 24357.14285714286,
                  "currentTrackWholeNotes": 21.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 21.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 385,
                      "endChar": 387,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 387,
                  "endChar": 388,
                  "startBeam": true,
                  "currentTrackMilliseconds": 24500,
                  "currentTrackWholeNotes": 21.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 95,
                      "start": 21.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 387,
                      "endChar": 388,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 7,
                      "name": "c",
                      "verticalPos": 7
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 388,
                  "endChar": 389,
                  "currentTrackMilliseconds": 24642.85714285714,
                  "currentTrackWholeNotes": 21.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 73,
                      "volume": 85,
                      "start": 21.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 388,
                      "endChar": 389,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 389,
                  "endChar": 390,
                  "currentTrackMilliseconds": 24785.714285714286,
                  "currentTrackWholeNotes": 21.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 95,
                      "start": 21.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 389,
                      "endChar": 390,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 390,
                  "endChar": 391,
                  "endBeam": true,
                  "currentTrackMilliseconds": 24928.57142857143,
                  "currentTrackWholeNotes": 21.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 85,
                      "start": 21.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 390,
                      "endChar": 391,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 391,
                  "endChar": 392
                },
                {
                  "chord": [
                    {
                      "name": "A7",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 392,
                  "endChar": 397,
                  "startBeam": true,
                  "currentTrackMilliseconds": 25071.428571428572,
                  "currentTrackWholeNotes": 21.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 105,
                      "start": 21.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 392,
                      "endChar": 397,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 397,
                  "endChar": 398,
                  "currentTrackMilliseconds": 25214.285714285714,
                  "currentTrackWholeNotes": 22.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 22.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 397,
                      "endChar": 398,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "rest": {
                    "type": "rest"
                  },
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 398,
                  "endChar": 399,
                  "currentTrackMilliseconds": 25357.14285714286,
                  "currentTrackWholeNotes": 22.1875
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 399,
                  "endChar": 401,
                  "endBeam": true,
                  "currentTrackMilliseconds": 25500,
                  "currentTrackWholeNotes": 22.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 85,
                      "start": 22.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 399,
                      "endChar": 401,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 401,
                  "endChar": 402,
                  "startBeam": true,
                  "currentTrackMilliseconds": 25642.85714285714,
                  "currentTrackWholeNotes": 22.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 95,
                      "start": 22.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 401,
                      "endChar": 402,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 402,
                  "endChar": 403,
                  "currentTrackMilliseconds": 25785.71428571429,
                  "currentTrackWholeNotes": 22.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 85,
                      "start": 22.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 402,
                      "endChar": 403,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 403,
                  "endChar": 404,
                  "currentTrackMilliseconds": 25928.57142857143,
                  "currentTrackWholeNotes": 22.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 95,
                      "start": 22.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 403,
                      "endChar": 404,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 404,
                  "endChar": 405,
                  "endBeam": true,
                  "currentTrackMilliseconds": 26071.428571428572,
                  "currentTrackWholeNotes": 22.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 85,
                      "start": 22.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 404,
                      "endChar": 405,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 405,
                  "endChar": 406
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 406,
                  "endChar": 407,
                  "startBeam": true,
                  "currentTrackMilliseconds": 26214.285714285714,
                  "currentTrackWholeNotes": 22.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 105,
                      "start": 22.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 406,
                      "endChar": 407,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 407,
                  "endChar": 408,
                  "currentTrackMilliseconds": 26357.14285714286,
                  "currentTrackWholeNotes": 23.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 85,
                      "start": 23.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 407,
                      "endChar": 408,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 408,
                  "endChar": 409,
                  "currentTrackMilliseconds": 26500,
                  "currentTrackWholeNotes": 23.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 95,
                      "start": 23.1875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 408,
                      "endChar": 409,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 4,
                      "name": "G",
                      "verticalPos": 4
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 409,
                  "endChar": 411,
                  "endBeam": true,
                  "currentTrackMilliseconds": 26642.85714285714,
                  "currentTrackWholeNotes": 23.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 67,
                      "volume": 85,
                      "start": 23.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 409,
                      "endChar": 411,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "chord": [
                    {
                      "name": "D",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 411,
                  "endChar": 415,
                  "currentTrackMilliseconds": 26785.71428571429,
                  "currentTrackWholeNotes": 23.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 95,
                      "start": 23.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 411,
                      "endChar": 415,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.375,
                  "el_type": "note",
                  "startChar": 415,
                  "endChar": 417,
                  "currentTrackMilliseconds": 26928.57142857143,
                  "currentTrackWholeNotes": 23.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 23.5625,
                      "duration": 0.375,
                      "instrument": 0,
                      "startChar": 415,
                      "endChar": 417,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 417,
                  "endChar": 418
                }
              ]
            ],
            "clef": {
              "type": "treble",
              "verticalPos": 0,
              "clefPos": 4
            },
            "key": {
              "accidentals": [
                {
                  "acc": "sharp",
                  "note": "f",
                  "verticalPos": 10
                },
                {
                  "acc": "sharp",
                  "note": "c",
                  "verticalPos": 7
                }
              ],
              "root": "D",
              "acc": "",
              "mode": ""
            }
          }
        ]
      },
      {
        "staff": [
          {
            "voices": [
              [
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 419,
                  "endChar": 420,
                  "startBeam": true,
                  "currentTrackMilliseconds": 27357.14285714286,
                  "currentTrackWholeNotes": 23.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 105,
                      "start": 23.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 419,
                      "endChar": 420,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 420,
                  "endChar": 421,
                  "currentTrackMilliseconds": 27500,
                  "currentTrackWholeNotes": 24.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 24.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 420,
                      "endChar": 421,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "rest": {
                    "type": "rest"
                  },
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 421,
                  "endChar": 422,
                  "currentTrackMilliseconds": 27642.85714285714,
                  "currentTrackWholeNotes": 24.1875
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 422,
                  "endChar": 423,
                  "endBeam": true,
                  "currentTrackMilliseconds": 27785.71428571429,
                  "currentTrackWholeNotes": 24.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 85,
                      "start": 24.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 422,
                      "endChar": 423,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.5,
                  "el_type": "note",
                  "startChar": 423,
                  "endChar": 425,
                  "currentTrackMilliseconds": 27928.57142857143,
                  "currentTrackWholeNotes": 24.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 95,
                      "start": 24.4375,
                      "duration": 0.5,
                      "instrument": 0,
                      "startChar": 423,
                      "endChar": 425,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 425,
                  "endChar": 426
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 426,
                  "endChar": 427,
                  "startBeam": true,
                  "currentTrackMilliseconds": 28500,
                  "currentTrackWholeNotes": 24.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 105,
                      "start": 24.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 426,
                      "endChar": 427,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 427,
                  "endChar": 428,
                  "currentTrackMilliseconds": 28642.857142857145,
                  "currentTrackWholeNotes": 25.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 25.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 427,
                      "endChar": 428,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 428,
                  "endChar": 429,
                  "currentTrackMilliseconds": 28785.71428571429,
                  "currentTrackWholeNotes": 25.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 95,
                      "start": 25.1875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 428,
                      "endChar": 429,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 429,
                  "endChar": 430,
                  "currentTrackMilliseconds": 28928.57142857143,
                  "currentTrackWholeNotes": 25.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 25.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 429,
                      "endChar": 430,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 430,
                  "endChar": 431,
                  "endBeam": true,
                  "currentTrackMilliseconds": 29071.428571428572,
                  "currentTrackWholeNotes": 25.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 95,
                      "start": 25.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 430,
                      "endChar": 431,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.375,
                  "el_type": "note",
                  "startChar": 431,
                  "endChar": 433,
                  "currentTrackMilliseconds": 29214.285714285714,
                  "currentTrackWholeNotes": 25.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 25.5625,
                      "duration": 0.375,
                      "instrument": 0,
                      "startChar": 431,
                      "endChar": 433,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 433,
                  "endChar": 434
                },
                {
                  "duration": 0.125,
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    },
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "el_type": "note",
                  "startChar": 434,
                  "endChar": 438,
                  "currentTrackMilliseconds": 29642.857142857145,
                  "currentTrackWholeNotes": 25.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 105,
                      "start": 25.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 434,
                      "endChar": 438,
                      "endType": "tenuto",
                      "gap": -0.001
                    },
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 105,
                      "start": 25.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 434,
                      "endChar": 438,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "duration": 0.375,
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    },
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "el_type": "note",
                  "startChar": 438,
                  "endChar": 445,
                  "currentTrackMilliseconds": 29785.714285714286,
                  "currentTrackWholeNotes": 26.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 85,
                      "start": 26.0625,
                      "duration": 0.375,
                      "instrument": 0,
                      "startChar": 438,
                      "endChar": 445,
                      "endType": "tenuto",
                      "gap": -0.001
                    },
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 26.0625,
                      "duration": 0.375,
                      "instrument": 0,
                      "startChar": 438,
                      "endChar": 445,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 445,
                  "endChar": 446,
                  "startBeam": true,
                  "currentTrackMilliseconds": 30214.285714285714,
                  "currentTrackWholeNotes": 26.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 95,
                      "start": 26.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 445,
                      "endChar": 446,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 12,
                      "name": "a",
                      "verticalPos": 12
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 446,
                  "endChar": 447,
                  "currentTrackMilliseconds": 30357.142857142855,
                  "currentTrackWholeNotes": 26.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 81,
                      "volume": 85,
                      "start": 26.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 446,
                      "endChar": 447,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 447,
                  "endChar": 448,
                  "currentTrackMilliseconds": 30500,
                  "currentTrackWholeNotes": 26.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 95,
                      "start": 26.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 447,
                      "endChar": 448,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 448,
                  "endChar": 449,
                  "endBeam": true,
                  "currentTrackMilliseconds": 30642.857142857138,
                  "currentTrackWholeNotes": 26.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 85,
                      "start": 26.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 448,
                      "endChar": 449,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 449,
                  "endChar": 450
                },
                {
                  "chord": [
                    {
                      "name": "A7",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 450,
                  "endChar": 455,
                  "startBeam": true,
                  "currentTrackMilliseconds": 30785.714285714286,
                  "currentTrackWholeNotes": 26.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 105,
                      "start": 26.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 450,
                      "endChar": 455,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 455,
                  "endChar": 456,
                  "currentTrackMilliseconds": 30928.571428571424,
                  "currentTrackWholeNotes": 27.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 85,
                      "start": 27.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 455,
                      "endChar": 456,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 456,
                  "endChar": 457,
                  "currentTrackMilliseconds": 31071.428571428572,
                  "currentTrackWholeNotes": 27.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 95,
                      "start": 27.1875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 456,
                      "endChar": 457,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 457,
                  "endChar": 459,
                  "endBeam": true,
                  "currentTrackMilliseconds": 31214.285714285714,
                  "currentTrackWholeNotes": 27.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 85,
                      "start": 27.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 457,
                      "endChar": 459,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 2,
                      "name": "E",
                      "verticalPos": 2
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 459,
                  "endChar": 460,
                  "startBeam": true,
                  "currentTrackMilliseconds": 31357.14285714286,
                  "currentTrackWholeNotes": 27.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 64,
                      "volume": 95,
                      "start": 27.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 459,
                      "endChar": 460,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 460,
                  "endChar": 461,
                  "currentTrackMilliseconds": 31500,
                  "currentTrackWholeNotes": 27.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 27.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 460,
                      "endChar": 461,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": -1,
                      "name": "B,",
                      "verticalPos": -1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 461,
                  "endChar": 463,
                  "currentTrackMilliseconds": 31642.85714285714,
                  "currentTrackWholeNotes": 27.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 59,
                      "volume": 95,
                      "start": 27.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 461,
                      "endChar": 463,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": -3,
                      "name": "G,",
                      "verticalPos": -3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 463,
                  "endChar": 465,
                  "endBeam": true,
                  "currentTrackMilliseconds": 31785.714285714286,
                  "currentTrackWholeNotes": 27.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 55,
                      "volume": 85,
                      "start": 27.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 463,
                      "endChar": 465,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 465,
                  "endChar": 466
                }
              ]
            ],
            "clef": {
              "type": "treble",
              "verticalPos": 0,
              "clefPos": 4
            },
            "key": {
              "accidentals": [
                {
                  "acc": "sharp",
                  "note": "f",
                  "verticalPos": 10
                },
                {
                  "acc": "sharp",
                  "note": "c",
                  "verticalPos": 7
                }
              ],
              "root": "D",
              "acc": "",
              "mode": ""
            }
          }
        ]
      },
      {
        "staff": [
          {
            "voices": [
              [
                {
                  "chord": [
                    {
                      "name": "D",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": -2,
                      "name": "A,",
                      "verticalPos": -2
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 467,
                  "endChar": 472,
                  "startBeam": true,
                  "currentTrackMilliseconds": 31928.571428571428,
                  "currentTrackWholeNotes": 27.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 57,
                      "volume": 105,
                      "start": 27.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 467,
                      "endChar": 472,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 472,
                  "endChar": 473,
                  "endBeam": true,
                  "currentTrackMilliseconds": 32071.42857142857,
                  "currentTrackWholeNotes": 28.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 28.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 472,
                      "endChar": 473,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "duration": 0.25,
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    },
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "el_type": "note",
                  "startChar": 473,
                  "endChar": 480,
                  "currentTrackMilliseconds": 32214.285714285714,
                  "currentTrackWholeNotes": 28.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 95,
                      "start": 28.1875,
                      "duration": 0.25,
                      "instrument": 0,
                      "startChar": 473,
                      "endChar": 480,
                      "endType": "tenuto",
                      "gap": -0.001
                    },
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 95,
                      "start": 28.1875,
                      "duration": 0.25,
                      "instrument": 0,
                      "startChar": 473,
                      "endChar": 480,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 480,
                  "endChar": 481,
                  "startBeam": true,
                  "currentTrackMilliseconds": 32500,
                  "currentTrackWholeNotes": 28.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 95,
                      "start": 28.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 480,
                      "endChar": 481,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 481,
                  "endChar": 482,
                  "currentTrackMilliseconds": 32642.857142857138,
                  "currentTrackWholeNotes": 28.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 85,
                      "start": 28.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 481,
                      "endChar": 482,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 2,
                      "name": "E",
                      "verticalPos": 2
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 482,
                  "endChar": 483,
                  "currentTrackMilliseconds": 32785.71428571428,
                  "currentTrackWholeNotes": 28.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 64,
                      "volume": 95,
                      "start": 28.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 482,
                      "endChar": 483,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 483,
                  "endChar": 484,
                  "endBeam": true,
                  "currentTrackMilliseconds": 32928.57142857143,
                  "currentTrackWholeNotes": 28.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 28.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 483,
                      "endChar": 484,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 484,
                  "endChar": 485
                },
                {
                  "chord": [
                    {
                      "name": "G",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 485,
                  "endChar": 489,
                  "startBeam": true,
                  "currentTrackMilliseconds": 33071.42857142858,
                  "currentTrackWholeNotes": 28.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 105,
                      "start": 28.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 485,
                      "endChar": 489,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 489,
                  "endChar": 490,
                  "currentTrackMilliseconds": 33214.28571428572,
                  "currentTrackWholeNotes": 29.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 29.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 489,
                      "endChar": 490,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "rest": {
                    "type": "rest"
                  },
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 490,
                  "endChar": 491,
                  "currentTrackMilliseconds": 33357.14285714286,
                  "currentTrackWholeNotes": 29.1875
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 491,
                  "endChar": 493,
                  "endBeam": true,
                  "currentTrackMilliseconds": 33500,
                  "currentTrackWholeNotes": 29.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 85,
                      "start": 29.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 491,
                      "endChar": 493,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 493,
                  "endChar": 494,
                  "startBeam": true,
                  "currentTrackMilliseconds": 33642.857142857145,
                  "currentTrackWholeNotes": 29.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 95,
                      "start": 29.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 493,
                      "endChar": 494,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 494,
                  "endChar": 495,
                  "currentTrackMilliseconds": 33785.71428571428,
                  "currentTrackWholeNotes": 29.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 29.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 494,
                      "endChar": 495,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 495,
                  "endChar": 496,
                  "currentTrackMilliseconds": 33928.57142857143,
                  "currentTrackWholeNotes": 29.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 95,
                      "start": 29.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 495,
                      "endChar": 496,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 496,
                  "endChar": 497,
                  "endBeam": true,
                  "currentTrackMilliseconds": 34071.42857142857,
                  "currentTrackWholeNotes": 29.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 85,
                      "start": 29.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 496,
                      "endChar": 497,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 497,
                  "endChar": 498
                },
                {
                  "chord": [
                    {
                      "name": "A7",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 10,
                      "name": "f",
                      "verticalPos": 10
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 498,
                  "endChar": 503,
                  "startBeam": true,
                  "currentTrackMilliseconds": 34214.28571428572,
                  "currentTrackWholeNotes": 29.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 78,
                      "volume": 105,
                      "start": 29.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 498,
                      "endChar": 503,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 503,
                  "endChar": 504,
                  "currentTrackMilliseconds": 34357.142857142855,
                  "currentTrackWholeNotes": 30.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 30.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 503,
                      "endChar": 504,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 9,
                      "name": "e",
                      "verticalPos": 9
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 504,
                  "endChar": 505,
                  "currentTrackMilliseconds": 34500,
                  "currentTrackWholeNotes": 30.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 76,
                      "volume": 95,
                      "start": 30.1875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 504,
                      "endChar": 505,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 505,
                  "endChar": 507,
                  "endBeam": true,
                  "currentTrackMilliseconds": 34642.85714285714,
                  "currentTrackWholeNotes": 30.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 85,
                      "start": 30.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 505,
                      "endChar": 507,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 507,
                  "endChar": 508,
                  "startBeam": true,
                  "currentTrackMilliseconds": 34785.71428571429,
                  "currentTrackWholeNotes": 30.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 95,
                      "start": 30.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 507,
                      "endChar": 508,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 7,
                      "name": "c",
                      "verticalPos": 7
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 508,
                  "endChar": 509,
                  "currentTrackMilliseconds": 34928.57142857143,
                  "currentTrackWholeNotes": 30.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 73,
                      "volume": 85,
                      "start": 30.5625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 508,
                      "endChar": 509,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 8,
                      "name": "d",
                      "verticalPos": 8
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 509,
                  "endChar": 510,
                  "currentTrackMilliseconds": 35071.42857142858,
                  "currentTrackWholeNotes": 30.6875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 74,
                      "volume": 95,
                      "start": 30.6875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 509,
                      "endChar": 510,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 6,
                      "name": "B",
                      "verticalPos": 6
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 510,
                  "endChar": 511,
                  "endBeam": true,
                  "currentTrackMilliseconds": 35214.28571428572,
                  "currentTrackWholeNotes": 30.8125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 71,
                      "volume": 85,
                      "start": 30.8125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 510,
                      "endChar": 511,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin",
                  "el_type": "bar",
                  "startChar": 511,
                  "endChar": 512
                },
                {
                  "pitches": [
                    {
                      "pitch": 5,
                      "name": "A",
                      "verticalPos": 5
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 512,
                  "endChar": 513,
                  "startBeam": true,
                  "currentTrackMilliseconds": 35357.14285714286,
                  "currentTrackWholeNotes": 30.9375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 69,
                      "volume": 105,
                      "start": 30.9375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 512,
                      "endChar": 513,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 513,
                  "endChar": 514,
                  "currentTrackMilliseconds": 35500,
                  "currentTrackWholeNotes": 31.0625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 85,
                      "start": 31.0625,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 513,
                      "endChar": 514,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 2,
                      "name": "E",
                      "verticalPos": 2
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 514,
                  "endChar": 515,
                  "currentTrackMilliseconds": 35642.857142857145,
                  "currentTrackWholeNotes": 31.1875,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 64,
                      "volume": 95,
                      "start": 31.1875,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 514,
                      "endChar": 515,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 4,
                      "name": "G",
                      "verticalPos": 4
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 515,
                  "endChar": 517,
                  "endBeam": true,
                  "currentTrackMilliseconds": 35785.71428571428,
                  "currentTrackWholeNotes": 31.3125,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 67,
                      "volume": 85,
                      "start": 31.3125,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 515,
                      "endChar": 517,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "chord": [
                    {
                      "name": "D",
                      "position": "default"
                    }
                  ],
                  "pitches": [
                    {
                      "pitch": 3,
                      "name": "F",
                      "verticalPos": 3
                    }
                  ],
                  "duration": 0.125,
                  "el_type": "note",
                  "startChar": 517,
                  "endChar": 521,
                  "currentTrackMilliseconds": 35928.57142857143,
                  "currentTrackWholeNotes": 31.4375,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 66,
                      "volume": 95,
                      "start": 31.4375,
                      "duration": 0.125,
                      "instrument": 0,
                      "startChar": 517,
                      "endChar": 521,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "pitches": [
                    {
                      "pitch": 1,
                      "name": "D",
                      "verticalPos": 1
                    }
                  ],
                  "duration": 0.375,
                  "el_type": "note",
                  "startChar": 521,
                  "endChar": 523,
                  "currentTrackMilliseconds": 36071.42857142857,
                  "currentTrackWholeNotes": 31.5625,
                  "midiPitches": [
                    {
                      "cmd": "note",
                      "pitch": 62,
                      "volume": 85,
                      "start": 31.5625,
                      "duration": 0.375,
                      "instrument": 0,
                      "startChar": 521,
                      "endChar": 523,
                      "endType": "tenuto",
                      "gap": -0.001
                    }
                  ]
                },
                {
                  "type": "bar_thin_thin",
                  "el_type": "bar",
                  "startChar": 523,
                  "endChar": 525
                }
              ]
            ],
            "clef": {
              "type": "treble",
              "verticalPos": 0,
              "clefPos": 4
            },
            "key": {
              "accidentals": [
                {
                  "acc": "sharp",
                  "note": "f",
                  "verticalPos": 10
                },
                {
                  "acc": "sharp",
                  "note": "c",
                  "verticalPos": 7
                }
              ],
              "root": "D",
              "acc": "",
              "mode": ""
            }
          }
        ]
      }
    ],
    "midiEvents": [
      [
        {
          "cmd": "program",
          "channel": 0,
          "instrument": 0
        },
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null
      ],
      [
        {
          "cmd": "program",
          "channel": 1,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 0.25,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 0.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 0.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 0.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 0.75,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 1,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 1,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 1,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 1.25,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 1.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 1.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 1.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 1.75,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 2,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 2,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 2,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 35,
          "volume": 64,
          "start": 2.25,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 47,
          "volume": 48,
          "start": 2.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 2.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 2.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 30,
          "volume": 64,
          "start": 2.75,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 47,
          "volume": 48,
          "start": 3,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 3,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 3,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 35,
          "volume": 64,
          "start": 3.25,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 47,
          "volume": 48,
          "start": 3.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 3.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 3.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 30,
          "volume": 64,
          "start": 3.75,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 47,
          "volume": 48,
          "start": 4,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 4,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 4,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 4.25,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 4.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 4.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 4.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 4.75,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 43,
          "volume": 64,
          "start": 5.25,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 5.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 59,
          "volume": 48,
          "start": 5.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 62,
          "volume": 48,
          "start": 5.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 5.75,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 6,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 59,
          "volume": 48,
          "start": 6,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 62,
          "volume": 48,
          "start": 6,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 6.25,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 6.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 6.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 6.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 6.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 28,
          "volume": 64,
          "start": 6.75,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 7,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 7,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 7,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 7,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 7.25,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 7.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 7.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 7.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 7.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 7.75,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 8,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 8,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 8,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 8.25,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 8.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 8.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 8.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 8.75,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 9,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 9,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 9,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 9.25,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 9.25,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 9.25,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 9.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 9.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 9.5,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 47,
          "volume": 48,
          "start": 10.0625,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 10.0625,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 10.0625,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 47,
          "volume": 48,
          "start": 10.3125,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 10.3125,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 10.3125,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 35,
          "volume": 64,
          "start": 10.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 47,
          "volume": 48,
          "start": 11.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 11.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 11.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 30,
          "volume": 64,
          "start": 11.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 47,
          "volume": 48,
          "start": 11.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 11.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 11.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 11.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 12.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 12.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 12.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 12.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 12.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 12.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 12.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 43,
          "volume": 64,
          "start": 12.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 13.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 59,
          "volume": 48,
          "start": 13.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 62,
          "volume": 48,
          "start": 13.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 13.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 13.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 59,
          "volume": 48,
          "start": 13.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 62,
          "volume": 48,
          "start": 13.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 13.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 14.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 14.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 14.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 14.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 28,
          "volume": 64,
          "start": 14.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 14.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 14.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 14.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 14.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 14.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 15.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 15.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 15.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 15.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 15.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 15.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 15.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 15.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 15.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 16.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 16.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 16.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 16.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 16.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 16.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 16.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 16.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 17.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 17.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 17.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 17.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 17.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 17.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 17.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 17.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 18.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 18.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 18.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 18.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 18.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 18.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 18.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 18.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 19.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 19.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 19.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 19.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 28,
          "volume": 64,
          "start": 19.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 19.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 19.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 19.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 19.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 19.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 20.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 20.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 20.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 20.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 20.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 20.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 20.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 43,
          "volume": 64,
          "start": 20.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 21.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 59,
          "volume": 48,
          "start": 21.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 62,
          "volume": 48,
          "start": 21.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 21.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 21.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 59,
          "volume": 48,
          "start": 21.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 62,
          "volume": 48,
          "start": 21.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 21.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 22.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 22.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 22.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 22.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 28,
          "volume": 64,
          "start": 22.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 22.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 22.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 22.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 22.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 22.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 23.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 23.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 23.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 23.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 23.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 23.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 23.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 23.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 23.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 24.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 24.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 24.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 24.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 24.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 24.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 24.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 24.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 25.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 25.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 25.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 25.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 25.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 25.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 25.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 25.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 26.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 26.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 26.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 26.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 26.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 26.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 26.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 26.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 27.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 27.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 27.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 27.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 28,
          "volume": 64,
          "start": 27.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 27.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 27.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 27.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 27.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 27.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 28.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 28.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 28.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 28.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 28.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 28.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 28.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 43,
          "volume": 64,
          "start": 28.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 29.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 59,
          "volume": 48,
          "start": 29.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 62,
          "volume": 48,
          "start": 29.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 29.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 29.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 59,
          "volume": 48,
          "start": 29.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 62,
          "volume": 48,
          "start": 29.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 29.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 30.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 30.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 30.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 30.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 28,
          "volume": 64,
          "start": 30.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 30.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 30.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 30.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 30.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 33,
          "volume": 64,
          "start": 30.9375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 45,
          "volume": 48,
          "start": 31.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 49,
          "volume": 48,
          "start": 31.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 52,
          "volume": 48,
          "start": 31.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 55,
          "volume": 48,
          "start": 31.1875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 38,
          "volume": 64,
          "start": 31.4375,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 50,
          "volume": 48,
          "start": 31.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 54,
          "volume": 48,
          "start": 31.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        },
        {
          "cmd": "note",
          "pitch": 57,
          "volume": 48,
          "start": 31.6875,
          "duration": 0.125,
          "gap": 0,
          "instrument": 0
        }
      ]
    ]
  }
]
</file>

<file path="abc-parser-antlr/src/main/antlr4/io/github/ryangardner/abc/antlr/ABCLexer.g4">
lexer grammar ABCLexer;

tokens {
    STYLESHEET,
    NEWLINE,
    EOL_MUSIC,
    SPACE
}

// ============================================================================
// DEFAULT MODE: File Start / Between Tunes
// ============================================================================

// X: Reference number line.
// Transition: Default -> Header
X_REF_START : 'X:' -> pushMode(HEADER_MODE), pushMode(FIELD_VALUE_MODE);

// Comments/Stylesheets valid between tunes
TEXT_BLOCK_START : '%%begintext' -> pushMode(TEXT_BLOCK_MODE) ;
DEFAULT_STYLESHEET_DIRECTIVE : '%%' ~[\r\n]* ([\r\n]+ | EOF) -> type(STYLESHEET) ;
DEFAULT_COMMENT : '%' ~[\r\n]* -> skip ;

// Skip whitespace between tunes
WS_DEFAULT : [ \t\r\n]+ -> skip ;

// Free text check - more permissive
FREE_TEXT : ~[X%]+ -> skip ;

// Catch-all for anything else in default mode to avoid errors
ANY_DEFAULT : . -> skip ;

// ============================================================================
// HEADER MODE (Inside Tune Header)
// ============================================================================
mode HEADER_MODE;

    // Key Field ends the header
    // Key Field must start at the beginning of the line
    KEY_FIELD : { getCharPositionInLine() == 0 }? 'K:' -> pushMode(KEY_VALUE_MODE);
    
    // Lyrics Field transitions to LYRICS_MODE
    LYRICS_FIELD : 'w:' -> pushMode(LYRICS_MODE);

    // Standard Fields (Allow multi-char e.g. notC: Composer:)
    // Fields must start at the beginning of the line
    FIELD_ID : { getCharPositionInLine() == 0 }? [A-Za-z]+ ':' -> pushMode(FIELD_VALUE_MODE);

    // Stylesheets in header
    HEADER_TEXT_BLOCK_START : '%%begintext' -> pushMode(TEXT_BLOCK_MODE) ;
    HEADER_STYLESHEET : '%%' ~[\r\n]* ([\r\n]+ | EOF) -> type(STYLESHEET);

    // Capture everything else in header to avoid errors. Single char to avoid swallowing fields.
    HEADER_TEXT : . ; 

    // Newlines are significant: they separate fields
    HEADER_NEWLINE : [\r\n]+ -> type(NEWLINE);

    // Skip indentation/spaces before fields
    HEADER_WS : [ \t]+ -> skip;

    // Comments allowed in header
    HEADER_COMMENT : '%' ~[\r\n]* -> skip ;

// ============================================================================
// LYRICS MODE (Reading content of w:)
// ============================================================================
mode LYRICS_MODE;

    // Capture everything except newline as content
    LYRIC_CONTENT : ~[\r\n]+ ;
    
    // End of lyrics line
    LYRIC_EOL : [\r\n]+ -> type(NEWLINE), popMode;

// ============================================================================
// FIELD VALUE MODE (Reading content of T:, M:, etc)
// ============================================================================
mode FIELD_VALUE_MODE;

    // Consume content up to newline, but handle continuation
    FIELD_CONTENT : (~[\r\n\\])+ ;
    FIELD_CONTINUATION : '\\' [ \t]* [\r\n]+ -> skip ;
    FIELD_BACKSLASH : '\\' ; 
    
    // Newline ends the value and returns to HEADER_MODE
    FIELD_VALUE_END : [\r\n]+ -> type(NEWLINE), popMode;

// ============================================================================
// KEY VALUE MODE (Reading content of K:, transitions to Music)
// ============================================================================
mode KEY_VALUE_MODE;

    // Content: Emit FIELD_CONTENT token
    KEY_CONTENT : ~[\r\n]+ -> type(FIELD_CONTENT) ;
    
    // End of Key Line: Emit NEWLINE, transition to MUSIC
    // Pop KEY_VALUE_MODE, Pop HEADER_MODE, Push MUSIC_MODE
    KEY_END : [\r\n]+ -> type(NEWLINE), popMode, popMode, pushMode(MUSIC_MODE);

// ============================================================================
// MUSIC MODE
// ============================================================================
mode MUSIC_MODE;

    // Transition back to DEFAULT if we see X: at the start of a line
    // (We use a predicate to check column position)
    X_REF_RESTART : { getCharPositionInLine() == 0 }? 'X:' -> type(X_REF_START), popMode, pushMode(HEADER_MODE), pushMode(FIELD_VALUE_MODE);

    // End of Tune via blank line
    TUNE_BODY_END : ([\r\n] [ \t]* [\r\n]+) -> type(EOL_MUSIC), popMode ; 

    // Fields inside Music (e.g. V:1, K:D, M:4/4 changed mid-tune)
    // Only at start of line
    MUSIC_KEY : { getCharPositionInLine() == 0 }? 'K:' -> type(KEY_FIELD), pushMode(KEY_VALUE_MODE);
    MUSIC_SYMBOL_LINE : { getCharPositionInLine() == 0 }? 's:' -> pushMode(SYMBOL_LINE_MODE);
    MUSIC_FIELD : { getCharPositionInLine() == 0 }? [A-Za-z] ':' -> type(FIELD_ID), pushMode(FIELD_VALUE_MODE);
    
    // Directives and Comments in Music
    MUSIC_TEXT_BLOCK_START : '%%begintext' -> pushMode(TEXT_BLOCK_MODE) ;
    MUSIC_STYLESHEET_DIRECTIVE : '%%' ~[\r\n]* -> type(STYLESHEET) ;
    MUSIC_COMMENT : '%' ~[\r\n]* -> skip ;
    
    // Inline Fields
    INLINE_FIELD_START : '[' [A-Za-z] ':' -> pushMode(INLINE_FIELD_MODE) ;
    
    CHORD_START : '"' -> pushMode(CHORD_MODE);
    DECORATION_START : '!' -> pushMode(BANG_DECO_MODE);
    PLUS_DECORATION  : '+' -> pushMode(PLUS_DECO_MODE);

    BRACKET_START : '[' ;
    BRACKET_END   : ']' ;

    // ... Musical Tokens ...
    
    BAR_REP_END_TUNE : ':|]' ;
    BAR_REP_END_ALT  : ':]' ;
    BAR_REP_END      : ':|' ;
    BAR_REP_DBL_ALT  : ':|:' ;
    BAR_REP_DBL_TUNE : '::|]' ;
    BAR_REP_DBL      : '::' ;
    BAR_THICK_THICK  : '[|]' ;
    BAR_THIN_DOUBLE : '||' ;
    BAR_THIN_THICK  : '|]' ;
    BAR_THICK_THIN  : '[|' ;
    BAR_REP_START   : '|:' ;
    BAR_SINGLE      : '|' ;

    TUPLET_START : '(' [0-9]+ (':' [0-9]* (':' [0-9]*)?)? ;
    SLUR_START   : '(' ;
    SLUR_END     : ')' ;
    
    NOTE_PITCH : [A-Ga-g] ;
    REST : [zZxX] ;
    SPACER : 'y' ;
    
    // 4.14 Decorations / 4.16 Redefinable Symbols
    ROLL : '~' ;
    UPBOW : 'u' ;
    DOWNBOW : 'v' ;
    USER_DEF_SYMBOL : [H-Wh-w] ;
    
    ACC_SHARP_DBL_HALF : '^^/' ;
    ACC_SHARP_DBL      : '^^' ;
    ACC_SHARP_QUART_3  : '^3/2' ;
    ACC_SHARP_HALF     : '^/' ;
    ACC_SHARP          : '^' ;
    ACC_FLAT_DBL_HALF  : '__/' ;
    ACC_FLAT_DBL       : '__' ;
    ACC_FLAT_QUART_3   : '_3/2' ;
    ACC_FLAT_HALF      : '_/' ;
    ACC_FLAT           : '_' ;
    ACC_NATURAL        : '=' ;
    
    STACCATO : '.' ;
    BACKTICK : '`' ;
    DOLLAR   : '$' ;
    PLUS     : '+' ;
    COLON    : ':' ;

    OCTAVE_UP   : '\'' ;
    OCTAVE_DOWN : ',' ;

    DIGIT : [0-9] ;
    SLASH : '/' ;
    BROKEN_RHYTHM_LEFT : '<'+ ;
    BROKEN_RHYTHM_RIGHT : '>'+ ;
    
    PREFIX_GRACE : '{' ;
    SUFFIX_GRACE : '}' ;
    
    HYPHEN : '-' ;
    OVERLAY : '&' ;
    
    WS_MUSIC : [ \t]+ -> type(SPACE) ;
    LINE_CONTINUATION : '\\' [ \t]* [\r\n]+ -> skip ;
    MUSIC_BACKSLASH : '\\' ;
    EOL_MUSIC : [\r\n]+ -> type(NEWLINE);
    
    // Catch-all
    MUSIC_TEXT : . ;

// ============================================================================
// HELPER MODES
// ============================================================================
mode INLINE_FIELD_MODE;
    INLINE_FIELD_END : ']' -> popMode ;
    INLINE_FIELD_CONTENT : ~']'+ ;

mode CHORD_MODE;
    CHORD_END : '"' -> popMode ;
    CHORD_CONTENT : ~'"'+ ;

mode BANG_DECO_MODE;
    DECORATION_END : '!' -> popMode ;
    BANG_DECO_CONTENT : (~[\r\n! ])+ ;
    BANG_DECO_SPACE : [ \t]+ -> type(SPACE) ;
    BANG_DECO_NEWLINE : [\r\n]+ -> type(NEWLINE), popMode ;

mode PLUS_DECO_MODE;
    PLUS_DECORATION_END : '+' -> popMode ;
    PLUS_DECO_CONTENT : (~[\r\n+ ])+ ;
    PLUS_DECO_SPACE : [ \t]+ -> type(SPACE) ;
    PLUS_DECO_NEWLINE : [\r\n]+ -> type(NEWLINE), popMode ;

// ============================================================================
// SYMBOL LINE MODE (Reading content of s:)
// ============================================================================
mode SYMBOL_LINE_MODE;
    
    // Symbol Tokens
    SYMBOL_CHORD : '"' ~'"'* '"' ;
    SYMBOL_DECO : '!' ~'!'* '!' ;
    SYMBOL_SKIP : '*' ;
    
    // Separators
    SYMBOL_BAR : '|' ;
    
    // Whitespace
    SYMBOL_WS : [ \t]+ -> skip ;
    
    // End of line
    SYMBOL_EOL : [\r\n]+ -> type(NEWLINE), popMode ;
    
    // Catch deviations (or should we allow generic text?)
    // Spec says "symbol line contains only !...! ... "..." ... *
    // But practically, maybe we should skip garbage?
    SYMBOL_GARBAGE : . -> skip ;

// ============================================================================
// TEXT BLOCK MODE (%%begintext ... %%endtext)
// ============================================================================
mode TEXT_BLOCK_MODE;

    TEXT_BLOCK_END : '%%endtext' -> popMode ;
    
    // Capture content until endtext. Non-greedy.
    // Note: We need to handle newlines within content.
    // Ideally we want to capture everything as one token or line by line.
    // Let's capture generic text.
    TEXT_BLOCK_CONTENT : ~'%' + ; 
    // If we hit %, check if it is part of %%endtext.
    // If not, consume %.
    TEXT_BLOCK_PERCENT : '%' ;
</file>

<file path="abc-parser-antlr/src/main/antlr4/io/github/ryangardner/abc/antlr/ABCParser.g4">
parser grammar ABCParser;

options { tokenVocab=ABCLexer; }

tunebook
    : tune_preamble tune* EOF
    ;

tune
    : tune_header tune_body EOL_MUSIC*
    ;
    
x_ref
    : X_REF_START (FIELD_CONTENT | FIELD_BACKSLASH)* (NEWLINE | EOF)
    ;
    
key_field
    : KEY_FIELD (FIELD_CONTENT | FIELD_BACKSLASH)* (NEWLINE | EOF)
    ;

field
    : FIELD_ID (FIELD_CONTENT | FIELD_BACKSLASH)* (NEWLINE | EOF)
    ;

field_in_body
    : (FIELD_ID | KEY_FIELD) (FIELD_CONTENT | FIELD_BACKSLASH)* (NEWLINE | EOL_MUSIC | EOF)
    | STYLESHEET (NEWLINE | EOL_MUSIC | EOF)?
    ;

symbol_line
    : MUSIC_SYMBOL_LINE (SYMBOL_CHORD | SYMBOL_DECO | SYMBOL_SKIP | SYMBOL_BAR)*
    ;

music_line
    : (measure | field_in_body | lyrics_line)+ (NEWLINE | EOF)?
    | (EOL_MUSIC | NEWLINE)
    ;

measure
    : (variant | element)* barline
    | (variant | element)+ 
    ;

element
    : note_element
    | rest_element
    | tuplet_element
    | chord
    | annotation
    | decoration
    | inline_field
    | stylesheet_directive
    | overlay
    | grace_group
    | slur_start
    | slur_end
    | broken_rhythm
    | space
    | OCTAVE_UP
    | OCTAVE_DOWN
    | DIGIT
    | BRACKET_START
    | BRACKET_END
    | PLUS
    | COLON
    | MUSIC_TEXT
    | MUSIC_BACKSLASH
    | SPACER
    | BACKTICK
    | DOLLAR
    | HYPHEN
    ;

chord_element
    : note_element
    | rest_element
    | decoration
    | annotation
    | space
    | OCTAVE_UP
    | OCTAVE_DOWN
    | DIGIT
    | MUSIC_TEXT
    | MUSIC_BACKSLASH
    | SPACER
    | BACKTICK
    | DOLLAR
    ;

note_element
    : decoration* accidental? note_pitch octave_modifier? note_length? tie?
    ;

rest_element
    : decoration* REST note_length?
    ;

note_pitch
    : NOTE_PITCH
    ;

accidental
    : ACC_SHARP_HALF | ACC_SHARP | ACC_SHARP_QUART_3 | ACC_SHARP_DBL_HALF | ACC_SHARP_DBL | ACC_FLAT_HALF | ACC_FLAT | ACC_FLAT_QUART_3 | ACC_FLAT_DBL_HALF | ACC_FLAT_DBL | ACC_NATURAL
    ;

octave_modifier
    : OCTAVE_UP+
    | OCTAVE_DOWN+
    ;

note_length
    : DIGIT+ (SLASH+ DIGIT*)?
    | SLASH+ DIGIT*
    ;

broken_rhythm
    : BROKEN_RHYTHM_LEFT | BROKEN_RHYTHM_RIGHT
    ;

tie : HYPHEN ;

tuplet_element
    : TUPLET_START
    ;
    
chord
    : decoration* BRACKET_START chord_element* BRACKET_END note_length?
    ;

annotation
    : CHORD_START CHORD_CONTENT? CHORD_END
    ;

decoration
    : DECORATION_START (BANG_DECO_CONTENT | SPACE)* DECORATION_END
    | DECORATION_START (BANG_DECO_CONTENT | SPACE)* (NEWLINE | EOF)
    | PLUS_DECORATION (PLUS_DECO_CONTENT | SPACE)* PLUS_DECORATION_END
    | ROLL | UPBOW | DOWNBOW | PLUS | STACCATO | USER_DEF_SYMBOL
    ;
    
inline_field
    : INLINE_FIELD_START INLINE_FIELD_CONTENT INLINE_FIELD_END
    ;
    
overlay
    : OVERLAY
    ;
    
grace_group
    : PREFIX_GRACE SLASH? (note_element | chord | rest_element | tuplet_element | annotation | decoration | inline_field | stylesheet_directive | overlay | slur_start | slur_end | broken_rhythm | space | OCTAVE_UP | OCTAVE_DOWN | DIGIT | BRACKET_START | BRACKET_END | PLUS | COLON | MUSIC_TEXT | MUSIC_BACKSLASH | SPACER | BACKTICK | DOLLAR | HYPHEN)* SUFFIX_GRACE
    ;
    
slur_start : SLUR_START ;
slur_end : SLUR_END ;

barline
    : BAR_THIN_DOUBLE | BAR_THIN_THICK | BAR_THICK_THIN | BAR_THICK_THICK | BAR_REP_START | BAR_REP_END | BAR_REP_END_ALT | BAR_REP_END_TUNE | BAR_REP_DBL | BAR_REP_DBL_ALT | BAR_REP_DBL_TUNE | BAR_SINGLE | variant
    ;

variant
    : BRACKET_START DIGIT+
    | BAR_SINGLE DIGIT+
    ;
    

tune_preamble
    : (field | STYLESHEET | text_block_default | HEADER_TEXT | NEWLINE)*
    ;

tune_header
    : x_ref (field | STYLESHEET | text_block_header | HEADER_TEXT | NEWLINE)* key_field
    ;

tune_body
    : (music_line | field_in_body | symbol_line | lyrics_line | text_block_music | NEWLINE)*
    ;

lyrics_line
    : LYRICS_FIELD (LYRIC_CONTENT | NEWLINE)
    ;

text_block_default
    : TEXT_BLOCK_START (TEXT_BLOCK_CONTENT | TEXT_BLOCK_PERCENT)* TEXT_BLOCK_END
    ;

text_block_header
    : HEADER_TEXT_BLOCK_START (TEXT_BLOCK_CONTENT | TEXT_BLOCK_PERCENT)* TEXT_BLOCK_END
    ;

text_block_music
    : MUSIC_TEXT_BLOCK_START (TEXT_BLOCK_CONTENT | TEXT_BLOCK_PERCENT)* TEXT_BLOCK_END
    ;
    
stylesheet_directive
    : STYLESHEET
    ;

space : SPACE ;
</file>

<file path="abc-parser-antlr/src/main/kotlin/io/github/ryangardner/abc/antlr/AntlrAbcParser.kt">
package io.github.ryangardner.abc.antlr

import org.antlr.v4.runtime.ANTLRErrorListener
import org.antlr.v4.runtime.CharStreams
import org.antlr.v4.runtime.CommonTokenStream
import org.antlr.v4.runtime.ConsoleErrorListener
import org.antlr.v4.runtime.tree.ParseTree

public class AntlrAbcParser {

    public fun parse(input: String, errorListener: ANTLRErrorListener? = null): ParseTree {
        val charStream = CharStreams.fromString(input)
        val lexer = ABCLexer(charStream)
        
        lexer.removeErrorListeners()
        if (errorListener != null) {
            lexer.addErrorListener(errorListener)
        } else {
            lexer.addErrorListener(ConsoleErrorListener.INSTANCE)
        }

        val tokenStream = CommonTokenStream(lexer)
        val parser = ABCParser(tokenStream)
        
        parser.removeErrorListeners()
        if (errorListener != null) {
            parser.addErrorListener(errorListener)
        } else {
            parser.addErrorListener(ConsoleErrorListener.INSTANCE)
        }

        return parser.tunebook()
    }
}
</file>

<file path="abc-parser-antlr/src/test/kotlin/io/github/ryangardner/abc/antlr/TortureTest.kt">
package io.github.ryangardner.abc.antlr

import org.antlr.v4.runtime.BaseErrorListener
import org.antlr.v4.runtime.RecognitionException
import org.antlr.v4.runtime.Recognizer
import org.junit.jupiter.api.Test
import java.io.File
import kotlin.test.assertTrue

public class TortureTest {

    public class TrackingErrorListener : BaseErrorListener() {
        public var hasErrors: Boolean = false
        public val errors: MutableList<String> = mutableListOf()

        override fun syntaxError(
            recognizer: Recognizer<*, *>?,
            offendingSymbol: Any?,
            line: Int,
            charPositionInLine: Int,
            msg: String?,
            e: RecognitionException?
        ) {
            hasErrors = true
            errors.add("line $line:$charPositionInLine $msg")
        }
    }

    @Test
    public fun `torture test with all sample abc files`() {
        val parser = AntlrAbcParser()
        // Locate abc-test resources relative to module root
        val projectRoot = File("..").absoluteFile.normalize()
        val abcTestResources = File(projectRoot, "abc-test/src/test/resources")
        
        println("Searching for ABC files in: ${abcTestResources.absolutePath}")
        
        if (!abcTestResources.exists()) {
            println("WARNING: abc-test resources not found. Skipping torture test.")
            // Fail if we expect them to be there, but maybe specific env doesn't have them?
            // User context says abc-test has 36 children so it should exist.
            return
        }

        val abcFiles = abcTestResources.walkTopDown()
            .filter { it.extension == "abc" }
            .toList()

        println("Found ${abcFiles.size} ABC files.")
        
        var passed = 0
        var failed = 0
        val failedFiles = mutableListOf<String>()

        abcFiles.forEach { file ->
            val errorListener = TrackingErrorListener()
            try {
                val content = file.readText()
                parser.parse(content, errorListener)
                
                if (errorListener.hasErrors) {
                    failed++
                    val errorMsg = errorListener.errors.take(5).joinToString("; ")
                    failedFiles.add("${file.name}: $errorMsg")
                } else {
                    passed++
                }
            } catch (e: Exception) {
                failed++
                failedFiles.add("${file.name}: Exception ${e.message}")
            }
        }

        println("==================================================")
        println("Torture Test Results:")
        println("Total Files: ${abcFiles.size}")
        println("Passed: $passed")
        println("Failed: $failed")
        println("Success Rate: ${if (abcFiles.isNotEmpty()) (passed.toDouble() / abcFiles.size) * 100 else 0.0}%")
        println("==================================================")
        
        if (failed > 0) {
           println("Failed Files (Sample):")
           failedFiles.take(20).forEach { failure ->
               val (filename, error) = failure.split(": ", limit = 2)
               val file = abcFiles.find { it.name == filename }
               val versionTag = file?.readLines()?.find { it.startsWith("%abc-") } ?: "No version"
               println("File: $filename | Version: $versionTag | Error: $error")
           }
           if (failedFiles.size > 20) println("... and ${failedFiles.size - 20} more.")
        }
        
        assertTrue(abcFiles.isNotEmpty(), "Should have found some ABC files to test")
    }
}
</file>

<file path="abc-parser-antlr/pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>io.github.ryangardner</groupId>
        <artifactId>abc-jvm-parent</artifactId>
        <version>0.1.0-SNAPSHOT</version>
    </parent>

    <artifactId>abc-parser-antlr</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <antlr.version>4.13.1</antlr.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.antlr</groupId>
            <artifactId>antlr4-runtime</artifactId>
            <version>${antlr.version}</version>
        </dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-stdlib</artifactId>
        </dependency>
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter-api</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter-engine</artifactId>
            <scope>test</scope>
        </dependency>
         <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-test-junit5</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.antlr</groupId>
                <artifactId>antlr4-maven-plugin</artifactId>
                <version>${antlr.version}</version>
                <executions>
                    <execution>
                        <id>antlr</id>
                        <goals>
                            <goal>antlr4</goal>
                        </goals>
                        <configuration>
                            <listener>true</listener>
                            <visitor>true</visitor>
                            <arguments>
                                <argument>-package</argument>
                                <argument>io.github.ryangardner.abc.antlr</argument>
                            </arguments>
                            <outputDirectory>${project.build.directory}/generated-sources/antlr4</outputDirectory>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                 <groupId>org.codehaus.mojo</groupId>
                 <artifactId>build-helper-maven-plugin</artifactId>
                 <version>3.5.0</version>
                 <executions>
                     <execution>
                         <id>add-source</id>
                         <phase>generate-sources</phase>
                         <goals>
                             <goal>add-source</goal>
                         </goals>
                         <configuration>
                             <sources>
                                 <source>${project.build.directory}/generated-sources/antlr4</source>
                             </sources>
                         </configuration>
                     </execution>
                 </executions>
             </plugin>
        </plugins>
    </build>

</project>
</file>

<file path="abc-parser-v2/src/main/kotlin/io/github/ryangardner/abc/parser/v2/AntlrAbcParser.kt">
package io.github.ryangardner.abc.parser.v2

import io.github.ryangardner.abc.antlr.ABCLexer
import io.github.ryangardner.abc.antlr.ABCParser
import io.github.ryangardner.abc.antlr.ABCParserBaseVisitor
import io.github.ryangardner.abc.core.model.*
import io.github.ryangardner.abc.theory.util.KeyParserUtil
import org.antlr.v4.runtime.*
import org.antlr.v4.runtime.misc.ParseCancellationException
import org.antlr.v4.runtime.tree.TerminalNode
import org.slf4j.Logger
import org.slf4j.LoggerFactory

private val logger: Logger = LoggerFactory.getLogger(AntlrAbcParser::class.java)

public class AntlrAbcParser {

    public fun parse(input: String): AbcTune {
        return parseBook(input).firstOrNull() ?: throw IllegalArgumentException("No tunes found in input")
    }

    public fun parseBook(input: String): List<AbcTune> {
        val lexer = ABCLexer(CharStreams.fromString(input))
        val tokens = CommonTokenStream(lexer)
        val parser = ABCParser(tokens)
        
        val errorListener = object : BaseErrorListener() {
            override fun syntaxError(recognizer: Recognizer<*, *>?, offendingSymbol: Any?, line: Int, charPositionInLine: Int, msg: String?, e: RecognitionException?) {
                throw ParseCancellationException("line $line:$charPositionInLine $msg")
            }
        }
        lexer.removeErrorListeners()
        lexer.addErrorListener(errorListener)
        parser.removeErrorListeners()
        parser.addErrorListener(errorListener)

        val tunebookContext = parser.tunebook()
        val visitor = AbcTunebookVisitor()
        return visitor.visitTunebook(tunebookContext)
    }
}

private class AbcTunebookVisitor : ABCParserBaseVisitor<List<AbcTune>>() {
    override fun visitTunebook(ctx: ABCParser.TunebookContext): List<AbcTune> {
        return ctx.tune().map { buildTune(it) }
    }

    override fun visitTune(ctx: ABCParser.TuneContext): List<AbcTune> {
        return listOf(buildTune(ctx))
    }

    private fun buildTune(ctx: ABCParser.TuneContext): AbcTune {
        val header = buildTuneHeader(ctx.tune_header())
        
        val bodyVisitor = AbcTuneBodyVisitor(header)
        ctx.tune_body().accept(bodyVisitor)
        
        return AbcTune(
            header = header,
            body = TuneBody(bodyVisitor.elements),
            metadata = TuneMetadata()
        )
    }

    private fun buildTuneHeader(ctx: ABCParser.Tune_headerContext): TuneHeader {
        val xRef = ctx.x_ref().children
            .filter { it is TerminalNode && (it.symbol.type == ABCLexer.FIELD_CONTENT || it.symbol.type == ABCLexer.FIELD_BACKSLASH) }
            .joinToString("") { it.text }.trim().toIntOrNull() ?: 1
        val titles = mutableListOf<String>()
        var key: KeySignature? = null
        var meter: TimeSignature? = null
        var length: NoteDuration? = null
        var playingOrder: String? = null
        val unknownHeaders = mutableMapOf<String, String>()
        val allHeaders = mutableListOf<Pair<String, String>>()
        var version = "2.0"
        ctx.children.forEach { child ->
            when (child) {
                is ABCParser.FieldContext -> {
                    if (child.FIELD_ID() != null) {
                        val id = child.FIELD_ID().text.removeSuffix(":")
                        val value = child.children
                            .filter { it is TerminalNode && (it.symbol.type == ABCLexer.FIELD_CONTENT || it.symbol.type == ABCLexer.FIELD_BACKSLASH) }
                            .joinToString("") { it.text }.trim()
                        allHeaders.add(id to value)
                        when (id) {
                            "T" -> titles.add(value)
                            "M" -> meter = parseMeter(value)
                            "L" -> length = parseLength(value)
                            "P" -> playingOrder = value
                            else -> unknownHeaders[id] = value
                        }
                    }
                }
                is TerminalNode -> {
                    if (child.symbol.type == ABCLexer.STYLESHEET) {
                        val content = child.text.trim().removePrefix("%%")
                        allHeaders.add("%%" to content)
                        if (content.startsWith("abc-version", ignoreCase = true)) {
                            version = content.substringAfter("abc-version").trim()
                        }
                    }
                }
            }
        }

        val actualMeter = meter ?: TimeSignature(4, 4)
        val actualLength = length ?: run {
            val ratio = actualMeter.numerator.toDouble() / actualMeter.denominator.toDouble()
            if (ratio < 0.75) NoteDuration(1, 16) else NoteDuration(1, 8)
        }

        val keyValue = ctx.key_field().children
            .filter { it is TerminalNode && (it.symbol.type == ABCLexer.FIELD_CONTENT || it.symbol.type == ABCLexer.FIELD_BACKSLASH) }
            .joinToString("") { it.text }.trim()
        allHeaders.add("K" to keyValue)
        key = KeyParserUtil.parse(keyValue)

        return TuneHeader(
            reference = xRef,
            title = titles.ifEmpty { listOf("Unknown") },
            key = key,
            meter = actualMeter,
            length = actualLength,
            headers = allHeaders,
            unknownHeaders = unknownHeaders,
            version = version,
            playingOrder = playingOrder
        )
    }
}

private fun parseMeter(text: String): TimeSignature {
    val cleanText = text.substringBefore("%").trim()
    return when (cleanText) {
        "C" -> TimeSignature(4, 4, "C")
        "C|" -> TimeSignature(2, 2, "C|")
        "none" -> TimeSignature(4, 4) // Common in some ABCs
        else -> {
            val parts = cleanText.split("/")
            if (parts.size >= 2) {
                TimeSignature(parts[0].trim().toIntOrNull() ?: 4, parts[1].trim().toIntOrNull() ?: 4)
            } else TimeSignature(4, 4)
        }
    }
}

private fun parseLength(text: String): NoteDuration {
    val cleanText = text.substringBefore("%").trim()
    val parts = cleanText.split("/")
    return if (parts.size == 2) {
        NoteDuration(parts[0].trim().toIntOrNull() ?: 1, parts[1].trim().toIntOrNull() ?: 8)
    } else NoteDuration(1, 8)
}

    private class AbcTuneBodyVisitor(val header: TuneHeader) : ABCParserBaseVisitor<Unit>() {
    val elements = mutableListOf<MusicElement>()
    private var currentDefaultLength = header.length
    private var currentMeter = header.meter
    private val isStrict: Boolean = try {
        val vNum = header.version.toDouble()
        vNum >= 2.1
    } catch (e: Exception) {
        false
    }
    private var lastNoteStep: NoteStep? = null
    private var lastNoteOctave: Int? = null
    private var pendingAnnotation: String? = null
    private var pendingBrokenRhythmMultiplier: Double? = null

    override fun visitMeasure(ctx: ABCParser.MeasureContext): Unit {
        for (i in 0 until ctx.childCount) {
             val child = ctx.getChild(i)
             if (child is ABCParser.ElementContext) {
                 visitElement(child)
             } else if (child is ABCParser.VariantContext) {
                 visitVariant(child)
             }
        }
        ctx.barline()?.let { visitBarline(it) }
    }

    override fun visitMusic_line(ctx: ABCParser.Music_lineContext): Unit {
        super.visitMusic_line(ctx)
        if (ctx.EOL_MUSIC() != null || ctx.NEWLINE() != null) {
            elements.add(SpacerElement("\n"))
        }
    }

    override fun visitField_in_body(ctx: ABCParser.Field_in_bodyContext): Unit {
        if (ctx.FIELD_ID() != null || ctx.KEY_FIELD() != null) {
            val id = if (ctx.FIELD_ID() != null) ctx.FIELD_ID().text.removeSuffix(":") else "K"
            val value = ctx.children
                .filter { it is TerminalNode && (it.symbol.type == ABCLexer.FIELD_CONTENT || it.symbol.type == ABCLexer.FIELD_BACKSLASH) }
                .joinToString("") { it.text }.trim()
            
            when (id) {
                "L" -> currentDefaultLength = parseLength(value)
                "M" -> {
                    val newMeter = parseMeter(value)
                    currentMeter = newMeter
                    // Per ABC 2.1 spec (4.4), M: only sets the default L: when in the header.
                    // If M: appears in the body, it does NOT change L:.
                    // This aligns with abcjs behavior even for unversioned tunes.
                }
                "P" -> {
                    elements.add(PartElement(value))
                    return // Don't add BodyHeaderElement for P: if we already added PartElement?
                    // Actually, keeping BodyHeaderElement for compatibility might be safer, 
                    // but PartElement is what the RepeatExpander will use.
                }
            }
            elements.add(BodyHeaderElement(id, value))
        }
    }

    override fun visitNote_element(ctx: ABCParser.Note_elementContext): Unit {
        var note = buildNote(ctx)
        if (pendingBrokenRhythmMultiplier != null) {
            note = note.copy(length = note.length.scale(pendingBrokenRhythmMultiplier!!))
            pendingBrokenRhythmMultiplier = null
        }
        elements.add(note)
    }

    override fun visitElement(ctx: ABCParser.ElementContext): Unit {
        if (ctx.MUSIC_BACKSLASH() != null) {
            elements.add(SpacerElement("\\"))
            return
        }
        if (ctx.SPACER() != null) {
            elements.add(SpacerElement(ctx.SPACER().text))
            return
        }
        if (ctx.BACKTICK() != null) {
            elements.add(SpacerElement("`"))
            return
        }
        if (ctx.DOLLAR() != null) {
            elements.add(SpacerElement("$"))
            return
        }
        if (ctx.PLUS() != null) {
            elements.add(SpacerElement("+"))
            return
        }
        if (ctx.COLON() != null) {
            elements.add(SpacerElement(":"))
            return
        }
        if (ctx.BRACKET_START() != null) {
            elements.add(SpacerElement("["))
            return
        }
        if (ctx.BRACKET_END() != null) {
            elements.add(SpacerElement("]"))
            return
        }
        if (ctx.HYPHEN() != null) {
            // Standalone hyphen might be a tie separated by a space from the note.
            // ABC 2.1 says "A tie is indicated by a hyphen (-) immediately following the note"
            // So if isStrict (2.1+), we should probably NOT search backwards if there was a space.
            // However, even in 2.1, some tools are lenient.
            // We follow the user preference: strict is only enabled when version >= 2.1.
            if (!isStrict) {
                // Search backwards for the last NoteElement to attach the tie to.
                for (i in elements.indices.reversed()) {
                    val el = elements[i]
                    if (el is NoteElement) {
                        if (el.ties == TieType.NONE) {
                            elements[i] = el.copy(ties = TieType.START)
                        }
                        return
                    } else if (el is SpacerElement) {
                        continue
                    } else {
                        break
                    }
                }
            }
            elements.add(SpacerElement("-"))
            return
        }
        if (ctx.DIGIT() != null) {
            elements.add(SpacerElement(ctx.DIGIT().text))
            return
        }
        if (ctx.OCTAVE_UP() != null) {
            elements.add(SpacerElement("'"))
            return
        }
        if (ctx.OCTAVE_DOWN() != null) {
            elements.add(SpacerElement(","))
            return
        }
        if (ctx.MUSIC_TEXT() != null) {
            elements.add(SpacerElement(ctx.MUSIC_TEXT().text))
            return
        }
        super.visitElement(ctx)
    }

    override fun visitDecoration(ctx: ABCParser.DecorationContext): Unit {
        // Standalone decorations are ignored for now to avoid model mismatch, 
        // as they are typically attached to notes/chords via buildNote
    }

    private fun buildNote(ctx: ABCParser.Note_elementContext): NoteElement {
        val pitchText = ctx.note_pitch()?.text ?: ""
        
        val step: NoteStep
        var octave: Int

        if (pitchText.isNotEmpty()) {
            val stepChar = pitchText[0]
            step = when (stepChar.uppercaseChar()) {
                'C' -> NoteStep.C
                'D' -> NoteStep.D
                'E' -> NoteStep.E
                'F' -> NoteStep.F
                'G' -> NoteStep.G
                'A' -> NoteStep.A
                'B' -> NoteStep.B
                else -> NoteStep.C
            }
            octave = if (stepChar.isLowerCase()) 5 else 4
            
            // Handle octave modifiers by iterating tokens
            ctx.octave_modifier()?.children?.forEach { child ->
                if (child is TerminalNode) {
                    when (child.symbol.type) {
                        ABCLexer.OCTAVE_UP -> octave++
                        ABCLexer.OCTAVE_DOWN -> octave--
                    }
                }
            }
            
            lastNoteStep = step
            lastNoteOctave = octave
        } else {
            step = lastNoteStep ?: NoteStep.C
            octave = lastNoteOctave ?: 4
            
            ctx.octave_modifier()?.children?.forEach { child ->
                if (child is TerminalNode) {
                    when (child.symbol.type) {
                        ABCLexer.OCTAVE_UP -> octave++
                        ABCLexer.OCTAVE_DOWN -> octave--
                    }
                }
            }
        }

        val accidental = ctx.accidental()?.let { 
            val child = it.getChild(0)
            if (child is TerminalNode) {
               parseAccidental(child.symbol.type)
            } else null
        }
        val noteLength = ctx.note_length()
        val duration = noteLength?.let { 
            calculateDuration(it.text, currentDefaultLength)
        } ?: currentDefaultLength
        val tie = if (ctx.tie() != null) TieType.START else TieType.NONE
        
        val decorations = ctx.decoration().mapNotNull { parseDecoration(it) }

        return NoteElement(Pitch(step, octave, accidental), duration, tie, decorations = decorations, accidental = accidental)
    }

    override fun visitBroken_rhythm(ctx: ABCParser.Broken_rhythmContext): Unit {
        val lastElement = elements.findLast { it is NoteElement || it is ChordElement || it is RestElement }
        if (lastElement != null) {
            val dots = ctx.text.length
            val multiplier = if (ctx.text.startsWith(">")) {
                (Math.pow(2.0, dots.toDouble() + 1) - 1) / Math.pow(2.0, dots.toDouble())
            } else {
                1.0 / Math.pow(2.0, dots.toDouble())
            }
            
            val nextMultiplier = 2.0 - multiplier
            
            val lastIdx = elements.lastIndexOf(lastElement)
            elements[lastIdx] = when (lastElement) {
                is NoteElement -> lastElement.copy(length = lastElement.length.scale(multiplier))
                is RestElement -> lastElement.copy(duration = lastElement.duration.scale(multiplier))
                is ChordElement -> lastElement.copy(duration = lastElement.duration.scale(multiplier))
                else -> lastElement
            }
            
            pendingBrokenRhythmMultiplier = nextMultiplier
        }
    }

    override fun visitRest_element(ctx: ABCParser.Rest_elementContext): Unit {
        var rest = buildRest(ctx)
        if (pendingBrokenRhythmMultiplier != null) {
            rest = rest.copy(duration = rest.duration.scale(pendingBrokenRhythmMultiplier!!))
            pendingBrokenRhythmMultiplier = null
        }
        elements.add(rest)
    }

    private fun buildRest(ctx: ABCParser.Rest_elementContext): RestElement {
        val restChar = ctx.REST().text
        val duration = if (restChar.equals("Z", ignoreCase = false)) {
            // Z indicates a rest of one measure length.
            val measureDuration = NoteDuration.simplify(currentMeter.numerator, currentMeter.denominator)
            ctx.note_length()?.let { 
                // Multi-measure rest multiplier (e.g. Z2)
                val multiplier = calculateDuration(it.text, NoteDuration(1, 1))
                measureDuration * multiplier
            } ?: measureDuration
        } else {
            ctx.note_length()?.let { calculateDuration(it.text, currentDefaultLength) } ?: currentDefaultLength
        }
        val isHidden = restChar.equals("x", ignoreCase = true)
        val decorations = ctx.decoration().mapNotNull { parseDecoration(it) }
        return RestElement(duration, isHidden, decorations)
    }

    override fun visitChord(ctx: ABCParser.ChordContext): Unit {
        val explicitLengthCtx = ctx.note_length()
        var explicitChordMultiplier: NoteDuration? = null
        if (explicitLengthCtx != null) {
            // Note: calculateDuration returns (num/den) * defaultLength.
            // For a chord multiplier, we just want the multiplier part, or we divide by defaultLength.
            // Actually, calculateDuration(text, 1/1) gives us the multiplier as a NoteDuration.
            explicitChordMultiplier = calculateDuration(explicitLengthCtx.text, NoteDuration(1, 1))
        }

        val notes = mutableListOf<NoteElement>()
        val chordVisitor = object : ABCParserBaseVisitor<Unit>() {
            override fun visitNote_element(noteCtx: ABCParser.Note_elementContext) {
                var note = buildNote(noteCtx)
                if (explicitChordMultiplier != null) {
                    note = note.copy(length = note.length * explicitChordMultiplier!!)
                }
                notes.add(note)
            }
        }
        ctx.chord_element().forEach { it.accept(chordVisitor) }
        
        // ABC 2.1: "If the chord has no duration modifier, its duration is the same as that of the first note in the chord."
        // "If a chord has a duration modifier, the duration of each note in the chord is multiplied by that modifier."
        var duration = if (explicitChordMultiplier != null) {
            // If explicit length is present on the chord, the chord's duration is determined by that.
            // But wait, the notes inside already had durations.
            // [G2B2]3 -> G6 B6. Duration 6.
            // calculateDuration(explicitLengthCtx.text, currentDefaultLength) correctly scales the default length.
            // But if notes inside have multipliers... 
            // The first note's duration (after scaling) should represent the chord's duration.
            notes.firstOrNull()?.length ?: currentDefaultLength
        } else {
            // No explicit length on chord. Use first note.
            notes.firstOrNull()?.length ?: currentDefaultLength
        }
        if (pendingBrokenRhythmMultiplier != null) {
            duration = duration.scale(pendingBrokenRhythmMultiplier!!)
            pendingBrokenRhythmMultiplier = null
        }
        
        val decorations = ctx.decoration().mapNotNull { parseDecoration(it) }
        
        elements.add(ChordElement(notes, duration, annotation = pendingAnnotation, decorations = decorations))
        pendingAnnotation = null
    }

    override fun visitAnnotation(ctx: ABCParser.AnnotationContext): Unit {
        pendingAnnotation = ctx.CHORD_CONTENT()?.text ?: ""
    }

    override fun visitGrace_group(ctx: ABCParser.Grace_groupContext): Unit {
        val notes = ctx.note_element().map { buildNote(it) }
        val isAcciaccatura = ctx.SLASH() != null
        elements.add(GraceNoteElement(notes, isAcciaccatura))
    }

    override fun visitSlur_start(ctx: ABCParser.Slur_startContext): Unit {
        elements.add(SlurElement(true))
    }

    override fun visitSlur_end(ctx: ABCParser.Slur_endContext): Unit {
        elements.add(SlurElement(false))
    }

    override fun visitInline_field(ctx: ABCParser.Inline_fieldContext): Unit {
        val fullText = ctx.text.removePrefix("[").removeSuffix("]")
        val colonIdx = fullText.indexOf(':')
        if (colonIdx != -1) {
            val key = fullText.substring(0, colonIdx).trim()
            val value = fullText.substring(colonIdx + 1).trim()
            val type = HeaderType.entries.find { it.key == key } ?: HeaderType.UNKNOWN
            
            if (type == HeaderType.LENGTH) {
                currentDefaultLength = parseLength(value)
            }
            
            elements.add(InlineFieldElement(type, value))
        }
    }

    override fun visitBarline(ctx: ABCParser.BarlineContext): Unit {
        val firstChild = ctx.getChild(0)
        if (firstChild is TerminalNode) {
            val tokenType = firstChild.symbol.type
            val type = parseBarLineType(tokenType)
            elements.add(BarLineElement(type))
        } else if (firstChild is ABCParser.VariantContext) {
            visitVariant(firstChild)
        }
    }

    override fun visitVariant(ctx: ABCParser.VariantContext): Unit {
        val variants = ctx.DIGIT().mapNotNull { it.text.toIntOrNull() }
        elements.add(VariantElement(variants))
    }

    override fun visitOverlay(ctx: ABCParser.OverlayContext): Unit {
        elements.add(OverlayElement)
    }

    override fun visitLyrics_line(ctx: ABCParser.Lyrics_lineContext): Unit {
        val content = if (ctx.LYRIC_CONTENT() != null) ctx.LYRIC_CONTENT().text else ""
        elements.add(LyricElement(content.trim()))
    }

    override fun visitTuplet_element(ctx: ABCParser.Tuplet_elementContext): Unit {
        val text = ctx.TUPLET_START().text.substring(1) // remove (
        val parts = text.split(":")
        val p = parts.getOrNull(0)?.toIntOrNull() ?: 3
        val q = parts.getOrNull(1)?.toIntOrNull()
        val r = parts.getOrNull(2)?.toIntOrNull()
        elements.add(TupletElement(p, q, r))
    }

    override fun visitSpace(ctx: ABCParser.SpaceContext): Unit {
        elements.add(SpacerElement(ctx.text))
    }

    override fun visitStylesheet_directive(ctx: ABCParser.Stylesheet_directiveContext): Unit {
        elements.add(DirectiveElement(ctx.text.removePrefix("%%")))
    }
    
    override fun visitSymbol_line(ctx: ABCParser.Symbol_lineContext): Unit {
        val items = mutableListOf<SymbolItem>()
        for (i in 0 until ctx.childCount) {
            val child = ctx.getChild(i)
            if (child is TerminalNode) {
                when (child.symbol.type) {
                    ABCLexer.SYMBOL_CHORD -> items.add(SymbolChord(child.text.removeSurrounding("\"")))
                    ABCLexer.SYMBOL_DECO -> items.add(SymbolDecoration(child.text.removeSurrounding("!")))
                    ABCLexer.SYMBOL_SKIP -> items.add(SymbolSkip)
                    ABCLexer.SYMBOL_BAR -> items.add(SymbolBar)
                    // Ignore others like MUSIC_SYMBOL_LINE ("s:") and SYMBOL_EOL
                }
            }
        }
        elements.add(SymbolLineElement(items))
    }


    private fun extractTextBlock(children: List<org.antlr.v4.runtime.tree.ParseTree>): TextBlockElement {
        val sb = StringBuilder()
        children.forEach { child ->
            if (child is TerminalNode) {
                val text = child.text
                if (!text.startsWith("%%begintext") && !text.startsWith("%%endtext")) {
                     sb.append(text)
                }
            }
        }
        return TextBlockElement(sb.toString().lines())
    }

    override fun visitText_block_default(ctx: ABCParser.Text_block_defaultContext) {
        // Ignored for now as we only collect body elements
    }
    
    override fun visitText_block_music(ctx: ABCParser.Text_block_musicContext) {
        val children = (0 until ctx.childCount).map { ctx.getChild(it) }
        elements.add(extractTextBlock(children))
    }
    
    override fun visitText_block_header(ctx: ABCParser.Text_block_headerContext) {
        // Ignored for now
    }

    private fun parseAccidental(tokenType: Int): Accidental? = when (tokenType) {
        ABCLexer.ACC_SHARP -> Accidental.SHARP
        ABCLexer.ACC_SHARP_DBL -> Accidental.DOUBLE_SHARP
        ABCLexer.ACC_SHARP_HALF -> Accidental.QUARTER_SHARP
        ABCLexer.ACC_SHARP_DBL_HALF -> Accidental.THREE_QUARTER_SHARP
        ABCLexer.ACC_SHARP_QUART_3 -> Accidental.THREE_QUARTER_SHARP
        ABCLexer.ACC_FLAT -> Accidental.FLAT
        ABCLexer.ACC_FLAT_DBL -> Accidental.DOUBLE_FLAT
        ABCLexer.ACC_FLAT_HALF -> Accidental.QUARTER_FLAT
        ABCLexer.ACC_FLAT_DBL_HALF -> Accidental.THREE_QUARTER_FLAT
        ABCLexer.ACC_FLAT_QUART_3 -> Accidental.THREE_QUARTER_FLAT
        ABCLexer.ACC_NATURAL -> Accidental.NATURAL
        else -> null
    }

    private fun parseBarLineType(tokenType: Int): BarLineType = when (tokenType) {
        ABCLexer.BAR_SINGLE -> BarLineType.SINGLE
        ABCLexer.BAR_THIN_DOUBLE -> BarLineType.DOUBLE
        ABCLexer.BAR_THIN_THICK -> BarLineType.FINAL
        ABCLexer.BAR_THICK_THIN -> BarLineType.DOUBLE
        ABCLexer.BAR_REP_START -> BarLineType.REPEAT_START
        ABCLexer.BAR_REP_END -> BarLineType.REPEAT_END
        ABCLexer.BAR_REP_END_ALT -> BarLineType.REPEAT_END
        ABCLexer.BAR_REP_END_TUNE -> BarLineType.REPEAT_END
        ABCLexer.BAR_REP_DBL_ALT -> BarLineType.REPEAT_BOTH
        ABCLexer.BAR_REP_DBL -> BarLineType.REPEAT_BOTH
        ABCLexer.BAR_REP_DBL_TUNE -> BarLineType.REPEAT_BOTH
        ABCLexer.BAR_THICK_THICK -> BarLineType.DOUBLE
        else -> BarLineType.SINGLE
    }


    private fun calculateDuration(text: String, defaultLength: NoteDuration): NoteDuration {
        if (logger.isDebugEnabled) {
            logger.debug("calculateDuration text='$text' default=$defaultLength")
        }
        val num: Int
        val den: Int
        val slashCount = text.count { it == '/' }
        if (slashCount > 0) {
            val parts = text.split("/")
            num = if (parts[0].isEmpty()) 1 else parts[0].toIntOrNull() ?: 1
            // Handle multiple slashes like d// (slashCount=2, parts=["d", "", ""]) or d/2/ (slashCount=2, parts=["d", "2", ""])
            val explicitDen = if (parts.size > 1 && parts[1].isNotEmpty()) parts[1].toIntOrNull() else null
            
            den = if (explicitDen != null) {
                explicitDen * Math.pow(2.0, (slashCount - 1).toDouble()).toInt()
            } else {
                Math.pow(2.0, slashCount.toDouble()).toInt()
            }
        } else {
            num = text.toIntOrNull() ?: 1
            den = 1
        }
        val result = NoteDuration.simplify(num * defaultLength.numerator, den * defaultLength.denominator)
        if (logger.isDebugEnabled) {
            logger.debug("calculateDuration text='$text' default=$defaultLength -> $result ($num/$den)")
        }
        return result
    }

    private fun parseDecoration(ctx: ABCParser.DecorationContext): Decoration? {
        val child = ctx.getChild(0)
        if (child is TerminalNode) {
            return when (child.symbol.type) {
                ABCLexer.ROLL -> Decoration("~")
                ABCLexer.PLUS -> Decoration("+")
                ABCLexer.UPBOW -> Decoration("u")
                ABCLexer.DOWNBOW -> Decoration("v")
                ABCLexer.USER_DEF_SYMBOL -> Decoration(child.text)
                ABCLexer.STACCATO -> Decoration(".")
                else -> null
            }
        }
        
        val content = ctx.children
            .filter { it is TerminalNode && (it.symbol.type == ABCLexer.BANG_DECO_CONTENT || it.symbol.type == ABCLexer.PLUS_DECO_CONTENT || it.symbol.type == ABCLexer.SPACE) }
            .joinToString("") { it.text }.trim()
        
        if (content.isNotEmpty()) {
            return Decoration(content)
        }
        return null
    }
}
</file>

<file path="abc-parser-v2/pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>io.github.ryangardner</groupId>
        <artifactId>abc-jvm-parent</artifactId>
        <version>0.1.0-SNAPSHOT</version>
    </parent>

    <artifactId>abc-parser-v2</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
        </dependency>
        <dependency>
            <groupId>io.github.ryangardner</groupId>
            <artifactId>abc-core</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>io.github.ryangardner</groupId>
            <artifactId>abc-theory</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>io.github.ryangardner</groupId>
            <artifactId>abc-parser-antlr</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>org.antlr</groupId>
            <artifactId>antlr4-runtime</artifactId>
            <version>4.13.1</version>
        </dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-stdlib</artifactId>
        </dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-test-junit5</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
</project>
</file>

<file path="abc-test/src/main/kotlin/io/github/ryangardner/abc/test/DatasetDownloader.kt">
package io.github.ryangardner.abc.test

import java.io.BufferedInputStream
import java.io.File
import java.io.FileOutputStream
import java.net.URL
import java.util.zip.ZipInputStream

public object DatasetDownloader {
    private const val BASE_URL: String = "https://zenodo.org/records/17694747/files/"
    private const val DATASET_DIR: String = "target/abc-dataset"

    @JvmStatic
    public fun main(args: Array<String>): Unit {
        if (args.isEmpty()) {
            downloadAndExtract(1)
            downloadAndExtract(2)
        } else {
            args.forEach { arg ->
                arg.toIntOrNull()?.let { downloadAndExtract(it) }
            }
        }
    }

    public fun downloadAndExtract(batchNumber: Int): File {
        val batchName = "abc_notation_batch_%03d".format(batchNumber)
        val zipFileName = "$batchName.zip"
        val url = URL("$BASE_URL$zipFileName")
        val outputDir = File(DATASET_DIR, batchName)
        
        if (outputDir.exists() && outputDir.list()?.isNotEmpty() == true) {
            println("Dataset $batchName already exists. Skipping download.")
            return outputDir
        }

        outputDir.mkdirs()
        println("Downloading $url ...")
        
        val connection = url.openConnection()
        connection.connect()
        
        ZipInputStream(BufferedInputStream(connection.getInputStream())).use { zis ->
            var entry = zis.nextEntry
            while (entry != null) {
                val newFile = File(outputDir, entry.name)
                if (entry.isDirectory) {
                    newFile.mkdirs()
                } else {
                    newFile.parentFile.mkdirs()
                    FileOutputStream(newFile).use { fos ->
                        zis.copyTo(fos)
                    }
                }
                zis.closeEntry()
                entry = zis.nextEntry
            }
        }
        println("Extracted to ${outputDir.absolutePath}")
        return outputDir
    }
}
</file>

<file path="abc-test/src/test/kotlin/io/github/ryangardner/abc/test/RegressionHeavyTest.kt">
package io.github.ryangardner.abc.test

import io.github.ryangardner.abc.core.model.AbcTune
import io.github.ryangardner.abc.parser.AbcSerializer
import io.github.ryangardner.abc.parser.v2.AntlrAbcParser
import io.github.ryangardner.abc.theory.PitchInterpreter
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.params.ParameterizedTest
import org.junit.jupiter.params.provider.MethodSource
import java.io.File

public class RegressionHeavyTest {

    @ParameterizedTest(name = "Regression trip: {0}")
    @MethodSource("regressionFiles")
    public fun `test regression tunes fidelity`(file: File): Unit {
        val parser = AntlrAbcParser()
        val serializer = AbcSerializer()

        val originalAbc = file.readText()
        val originalTunes = parser.parseBook(originalAbc)
        
        val serializedBook = originalTunes.joinToString("") { serializer.serialize(it) }
        val roundTrippedTunes = parser.parseBook(serializedBook)
        
        assertEquals(originalTunes.size, roundTrippedTunes.size, "[${file.name}] Tune count mismatch")

        originalTunes.forEachIndexed { tuneIndex, originalTune ->
            val roundTrippedTune = roundTrippedTunes[tuneIndex]
            
            val originalInterpreted = PitchInterpreter.interpret(originalTune)
            val roundTrippedInterpreted = PitchInterpreter.interpret(roundTrippedTune)
            
            assertEquals(originalInterpreted.voices.size, roundTrippedInterpreted.voices.size, "[${file.name}] Tune $tuneIndex Voice count mismatch")
            
            originalInterpreted.voices.forEach { (voiceId, originalNotes) ->
                val roundTrippedNotes = roundTrippedInterpreted.voices[voiceId] ?: throw AssertionError("Voice $voiceId missing")
                if (originalNotes.size != roundTrippedNotes.size) {
                    println("--- SERIALIZED BOOK FOR ${file.name} ---")
                    println(serializedBook)
                    println("-----------------------------------------")
                }
                assertEquals(originalNotes.size, roundTrippedNotes.size, "[${file.name}] Tune $tuneIndex Voice $voiceId element count mismatch")
                
                originalNotes.forEachIndexed { noteIndex, originalNote ->
                    val roundTrippedNote = roundTrippedNotes[noteIndex]
                    assertEquals(originalNote.pitches.map { it.midiNoteNumber }.sorted(), roundTrippedNote.pitches.map { it.midiNoteNumber }.sorted(), "[${file.name}] Tune $tuneIndex Voice $voiceId Note $noteIndex pitch mismatch")
                    assertEquals(originalNote.duration.toDouble(), roundTrippedNote.duration.toDouble(), 0.001, "[${file.name}] Tune $tuneIndex Voice $voiceId Note $noteIndex duration mismatch")
                }
            }
        }
    }

    public companion object {
        @JvmStatic
        public fun regressionFiles(): List<File> {
            val paths = listOf(
                "abc-test/src/test/resources/regression-samples",
                "src/test/resources/regression-samples"
            )
            for (path in paths) {
                val dir = File(path)
                if (dir.exists() && dir.isDirectory) {
                    val files = dir.listFiles { f -> f.extension == "abc" }?.toList()
                    if (files != null && files.isNotEmpty()) return files
                }
            }
            return emptyList()
        }
    }
}
</file>

<file path="abc-test/src/test/kotlin/io/github/ryangardner/abc/test/RoundTripAntlrTest.kt">
package io.github.ryangardner.abc.test

import io.github.ryangardner.abc.core.model.AbcTune
import io.github.ryangardner.abc.parser.AbcSerializer
import io.github.ryangardner.abc.parser.v2.AntlrAbcParser
import io.github.ryangardner.abc.theory.MeasureValidator
import io.github.ryangardner.abc.theory.PitchInterpreter
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.params.ParameterizedTest
import org.junit.jupiter.params.provider.MethodSource
import java.io.File
import java.util.stream.Stream
import java.util.zip.ZipFile
import kotlin.streams.asStream

public class RoundTripAntlrTest {

    public data class AbcSource(val name: String, val content: String) {
        override fun toString(): String = name
    }

    @ParameterizedTest(name = "ANTLR Round trip: {0}")
    @MethodSource("abcSources")
    public fun `test antlr parser fidelity`(source: AbcSource): Unit {
        val parser = AntlrAbcParser()
        val serializer = AbcSerializer()

        val originalAbc = source.content
        val originalTunes: List<AbcTune> = try {
            parser.parseBook(originalAbc)
        } catch (e: Exception) {
            println("ANTLR PARSE FAILED for ${source.name}: ${e.message}")
            throw e // Fail the test
        }
        
        val serializedBook: String = originalTunes.joinToString("") { serializer.serialize(it) }
        
        val roundTrippedTunes: List<AbcTune> = try {
            parser.parseBook(serializedBook)
        } catch (e: Exception) {
            println("FAILED TO RE-PARSE SERIALIZED BOOK (ANTLR) for ${source.name}: ${e.message}")
            println("SERIALIZED CONTENT:\n$serializedBook")
            throw e
        }
        
        assertEquals(originalTunes.size, roundTrippedTunes.size, "[${source.name}] Tune count mismatch")

        originalTunes.forEachIndexed { tuneIndex: Int, originalTune: AbcTune ->
            val roundTrippedTune = roundTrippedTunes[tuneIndex]
            
            // Semantic Validation
            val originalInterpreted = PitchInterpreter.interpret(originalTune)
            val roundTrippedInterpreted = PitchInterpreter.interpret(roundTrippedTune)
            
            assertEquals(originalInterpreted.voices.size, roundTrippedInterpreted.voices.size, "[${source.name}] Tune $tuneIndex Interpreted voice count mismatch")
            
            originalInterpreted.voices.forEach { (voiceId, originalNotes) ->
                val roundTrippedNotes = roundTrippedInterpreted.voices[voiceId] ?: throw AssertionError("Voice $voiceId missing in round-tripped tune")
                assertEquals(originalNotes.size, roundTrippedNotes.size, "[${source.name}] Tune $tuneIndex Voice $voiceId element count mismatch")
                
                originalNotes.forEachIndexed { noteIndex, originalNote ->
                    val roundTrippedNote = roundTrippedNotes[noteIndex]
                    assertEquals(originalNote.pitches.map { it.midiNoteNumber }.sorted(), roundTrippedNote.pitches.map { it.midiNoteNumber }.sorted(), "[${source.name}] Tune $tuneIndex Voice $voiceId Note $noteIndex pitch mismatch")
                    assertEquals(originalNote.duration.toDouble(), roundTrippedNote.duration.toDouble(), 0.001, "[${source.name}] Tune $tuneIndex Voice $voiceId Note $noteIndex duration mismatch")
                }
            }
            
            // Measure Validation
            try {
                MeasureValidator.validate(originalTune)
                MeasureValidator.validate(roundTrippedTune)
            } catch (e: Exception) {
                // println("Measure validation failed for ${source.name}: ${e.message}")
            }
        }
    }

    public companion object {
        private val isHeavy: Boolean = System.getProperty("test.profile") == "heavy"

        @JvmStatic
        public fun abcSources(): Stream<AbcSource> {
            val home = System.getProperty("user.home")
            val downloads = File(home, "Downloads")
            
            if (!isHeavy) {
                val dir = File("abc-test/src/test/resources/sanity-samples")
                return (dir.listFiles { f -> f.extension == "abc" }?.map { 
                    AbcSource(it.name, it.readText()) 
                }?.asSequence() ?: emptySequence()).asStream()
            }

            val zipFiles = downloads.listFiles { f -> f.name.startsWith("abc_notation_batch_") && f.extension == "zip" } ?: emptyArray()
            val unzippedDirs = downloads.listFiles { f -> f.isDirectory && f.name.startsWith("abc_notation_batch_") } ?: emptyArray()

            val dirNames = unzippedDirs.map { it.name }.toSet()
            val filteredZips = zipFiles.filter { it.name.substringBeforeLast(".") !in dirNames }

            val sequence = sequence {
                unzippedDirs.sortedBy { it.name }.forEach { dir ->
                    dir.walkTopDown()
                        .filter { it.extension == "abc" }
                        .sortedBy { it.name }
                        .forEach { file ->
                            yield(AbcSource("${dir.name}/${file.name}", file.readText()))
                        }
                }
                filteredZips.sortedBy { it.name }.forEach { zipFile ->
                    ZipFile(zipFile).use { zip ->
                        zip.entries().asSequence()
                            .filter { !it.isDirectory && it.name.endsWith(".abc") }
                            .sortedBy { it.name }
                            .forEach { entry ->
                                val content = zip.getInputStream(entry).bufferedReader().readText()
                                yield(AbcSource("${zipFile.name}/${entry.name}", content))
                            }
                    }
                }
            }

            return sequence.take(10000).asStream()
        }
    }
}
</file>

<file path="abc-test/src/test/kotlin/io/github/ryangardner/abc/test/RoundTripTest.kt">
package io.github.ryangardner.abc.test

import io.github.ryangardner.abc.core.model.AbcTune
import io.github.ryangardner.abc.parser.AbcParser
import io.github.ryangardner.abc.parser.AbcSerializer
import io.github.ryangardner.abc.theory.MeasureValidator
import io.github.ryangardner.abc.theory.PitchInterpreter
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.BeforeAll
import org.junit.jupiter.params.ParameterizedTest
import org.junit.jupiter.params.provider.MethodSource
import java.io.File

public class RoundTripTest {

    @ParameterizedTest(name = "Round trip: {0}")
    @MethodSource("abcFiles")
    public fun `test round trip fidelity`(file: File): Unit {
        val parser = AbcParser()
        val serializer = AbcSerializer()

        val originalAbc = file.readText()
        val originalTunes: List<AbcTune> = try {
            parser.parseBook(originalAbc)
        } catch (e: Exception) {
            println("PARSE FAILED for ${file.name}: ${e.message}")
            // e.printStackTrace()
            return // Skip for now if it can't even parse once
        }
        
        val serializedBook: String = originalTunes.joinToString("") { serializer.serialize(it) }
        
        // Bit-perfect check (only for single-tune files for now, as we don't preserve inter-tune whitespace yet)
        if (originalTunes.size == 1 && !originalAbc.contains("V:")) {
             // assertEquals(originalAbc.trim(), serializedBook.trim(), "Bit-perfect round trip failed for ${file.name}")
        }

        val roundTrippedTunes: List<AbcTune> = try {
            parser.parseBook(serializedBook)
        } catch (e: Exception) {
            println("FAILED TO RE-PARSE SERIALIZED BOOK for ${file.name}: ${e.message}")
            println("SERIALIZED CONTENT:\n$serializedBook")
            throw e
        }
        
        assertEquals(originalTunes.size, roundTrippedTunes.size, "[${file.name}] Tune count mismatch")

        originalTunes.forEachIndexed { tuneIndex: Int, originalTune: AbcTune ->
            val roundTrippedTune = roundTrippedTunes[tuneIndex]
            try {
                assertEquals(originalTune.header.reference, roundTrippedTune.header.reference, "[${file.name}] Tune $tuneIndex Reference mismatch")
                assertEquals(originalTune.header.title, roundTrippedTune.header.title, "[${file.name}] Tune $tuneIndex Title mismatch")
                assertEquals(originalTune.header.key, roundTrippedTune.header.key, "[${file.name}] Tune $tuneIndex Key mismatch")
                assertEquals(originalTune.header.meter, roundTrippedTune.header.meter, "[${file.name}] Tune $tuneIndex Meter mismatch")
                assertEquals(originalTune.header.length, roundTrippedTune.header.length, "[${file.name}] Tune $tuneIndex Length mismatch")
                assertEquals(originalTune.body.elements.size, roundTrippedTune.body.elements.size, "[${file.name}] Tune $tuneIndex Body size mismatch")
                
                // Semantic Validation
                val originalInterpreted = PitchInterpreter.interpret(originalTune)
                val roundTrippedInterpreted = PitchInterpreter.interpret(roundTrippedTune)
                
                assertEquals(originalInterpreted.voices.size, roundTrippedInterpreted.voices.size, "[${file.name}] Tune $tuneIndex Interpreted voice count mismatch")
                
                originalInterpreted.voices.forEach { (voiceId, originalNotes) ->
                    val roundTrippedNotes = roundTrippedInterpreted.voices[voiceId] ?: throw AssertionError("Voice $voiceId missing in round-tripped tune")
                    assertEquals(originalNotes.size, roundTrippedNotes.size, "[${file.name}] Tune $tuneIndex Voice $voiceId element count mismatch")
                    
                    originalNotes.forEachIndexed { noteIndex, originalNote ->
                        val roundTrippedNote = roundTrippedNotes[noteIndex]
                        assertEquals(originalNote.pitches.map { it.midiNoteNumber }.sorted(), roundTrippedNote.pitches.map { it.midiNoteNumber }.sorted(), "[${file.name}] Tune $tuneIndex Voice $voiceId Note $noteIndex pitch mismatch")
                        assertEquals(originalNote.duration.toDouble(), roundTrippedNote.duration.toDouble(), 0.001, "[${file.name}] Tune $tuneIndex Voice $voiceId Note $noteIndex duration mismatch")
                    }
                }
                
                // Measure Validation
                MeasureValidator.validate(originalTune)
                MeasureValidator.validate(roundTrippedTune)
            } catch (e: Throwable) {
                println("FIDELITY FAILURE for ${file.name} at Tune $tuneIndex")
                // Find first diff in body
                val size = minOf(originalTune.body.elements.size, roundTrippedTune.body.elements.size)
                for (i in 0 until size) {
                    if (originalTune.body.elements[i] != roundTrippedTune.body.elements[i]) {
                        println("First diff in Tune $tuneIndex at element index $i:")
                        println("  Expected: ${originalTune.body.elements[i]}")
                        println("  Actual:   ${roundTrippedTune.body.elements[i]}")
                        break
                    }
                }
                throw e
            }
        }
    }

    public companion object {
        private var datasetDir: File? = null
        private val isHeavy: Boolean = System.getProperty("test.profile") == "heavy"

        @JvmStatic
        @BeforeAll
        public fun setup(): Unit {
            if (isHeavy) {
                datasetDir = DatasetDownloader.downloadAndExtract(1)
                if (!datasetDir!!.exists() || datasetDir!!.list()?.isEmpty() == true) {
                    // Try fallback if running from root
                    val rootDatasetDir = File("abc-test/target/abc-dataset/abc_notation_batch_001")
                    if (rootDatasetDir.exists()) {
                        datasetDir = rootDatasetDir
                    }
                }
            }
        }

        @JvmStatic
        public fun abcFiles(): List<File> {
            if (isHeavy && datasetDir == null) {
                setup()
            }
            return if (isHeavy) {
                datasetDir?.walkTopDown()
                    ?.filter { it.extension == "abc" }
                    ?.take(1000)
                    ?.toList() ?: emptyList()
            } else {
                val dir = File("src/test/resources/sanity-samples")
                val fallbackDir = File("abc-test/src/test/resources/sanity-samples")
                val activeDir = if (dir.exists()) dir else fallbackDir
                
                activeDir.listFiles { f -> f.extension == "abc" }?.toList() ?: emptyList()
            }
        }
    }
}
</file>

<file path="abc-test/src/test/kotlin/io/github/ryangardner/abc/test/SemanticFidelityTest.kt">
package io.github.ryangardner.abc.test

import io.github.ryangardner.abc.parser.AbcParser
import io.github.ryangardner.abc.theory.MeasureValidator
import org.junit.jupiter.api.BeforeAll
import org.junit.jupiter.params.ParameterizedTest
import org.junit.jupiter.params.provider.MethodSource
import java.io.File
import org.junit.jupiter.api.Assertions.assertTrue

public class SemanticFidelityTest {

    public companion object {
        private var datasetDir: File? = null
        private val isHeavy: Boolean = System.getProperty("test.profile") == "heavy"

        @JvmStatic
        @BeforeAll
        public fun setup(): Unit {
            if (isHeavy) {
                datasetDir = DatasetDownloader.downloadAndExtract(1)
            }
        }

        @JvmStatic
        public fun abcFiles(): List<File> {
            return if (isHeavy) {
                val allFiles = mutableListOf<File>()
                datasetDir?.walkTopDown()?.forEach {
                    if (it.extension == "abc") {
                        allFiles.add(it)
                    }
                }
                allFiles.take(1000)
            } else {
                val sanityDir = File("src/test/resources/sanity-samples")
                if (sanityDir.exists()) {
                    sanityDir.listFiles { f -> f.extension == "abc" }?.toList() ?: emptyList()
                } else {
                    val resource = SemanticFidelityTest::class.java.classLoader.getResource("sanity-samples")
                    if (resource != null) {
                        File(resource.toURI()).listFiles { f -> f.extension == "abc" }?.toList() ?: emptyList()
                    } else {
                        emptyList()
                    }
                }
            }
        }
    }

    @ParameterizedTest(name = "Semantic validation: {0}")
    @MethodSource("abcFiles")
    public fun `test measure durations`(file: File): Unit {
        val parser = AbcParser()
        val originalAbc = file.readText()
        val tunes = try {
            parser.parseBook(originalAbc)
        } catch (e: Exception) {
            // Ignore tunes we can't even parse for now
            return
        }

        tunes.forEachIndexed { tuneIndex, tune ->
            val errors = MeasureValidator.validate(tune)
            // Some tunes might have pickup measures or intentionally weird bars, 
            // but if more than half the measures are wrong, something is likely semantically broken in our parser.
            // For now, let's just log them and see what happens.
            if (errors.isNotEmpty()) {
                println("Semantic warnings for ${file.name} (Tune $tuneIndex): ${errors.size} measures with duration mismatch.")
                errors.take(3).forEach { error ->
                    println("  Measure ${error.measureIndex}: Got ${error.actualDuration}, expected ${error.expectedDuration}")
                }
            }
            
            // To make the test fail if we are totally wrong:
            // assertTrue(errors.size < 5, "Too many duration errors in ${file.name}")
        }
    }
}
</file>

<file path="abc-test/src/test/kotlin/io/github/ryangardner/abc/test/SymbolLineParserTest.kt">
package io.github.ryangardner.abc.test

import io.github.ryangardner.abc.core.model.*
import io.github.ryangardner.abc.parser.v2.AntlrAbcParser
import org.junit.jupiter.api.Assertions.*
import org.junit.jupiter.api.Test

public class SymbolLineParserTest {
    @Test
    public fun `parses symbol line correctly`() {
        val abc = """
            X:1
            T:Symbol Line Test
            K:C
            C D E F |
            s: "Cm" * !trill! * |
        """.trimIndent()
        
        val parser = AntlrAbcParser()
        val tune = parser.parse(abc)
        
        val elements = tune.body.elements
        val symbolLine = elements.filterIsInstance<SymbolLineElement>().firstOrNull()
        
        assertNotNull(symbolLine, "Should find a SymbolLineElement")
        
        val items = symbolLine!!.items
        assertEquals(5, items.size, "Should match item count") 
        
        val item0 = items[0]
        assertTrue(item0 is SymbolChord, "Item 0 should be SymbolChord")
        assertEquals("Cm", (item0 as SymbolChord).name)
        
        assertTrue(items[1] is SymbolSkip, "Item 1 should be SymbolSkip")
        
        val item2 = items[2]
        assertTrue(item2 is SymbolDecoration, "Item 2 should be SymbolDecoration")
        assertEquals("trill", (item2 as SymbolDecoration).name)
        
        assertTrue(items[3] is SymbolSkip, "Item 3 should be SymbolSkip")
        
        assertTrue(items[4] is SymbolBar, "Item 4 should be SymbolBar")
    }
}
</file>

<file path="abc-test/src/test/kotlin/io/github/ryangardner/abc/test/TextBlockParserTest.kt">
package io.github.ryangardner.abc.test

import io.github.ryangardner.abc.core.model.*
import io.github.ryangardner.abc.parser.v2.AntlrAbcParser
import org.junit.jupiter.api.Assertions.*
import org.junit.jupiter.api.Test

public class TextBlockParserTest {
    @Test
    public fun `parses text block correctly`() {
        val abc = """
            X:1
            T:Text Block Test
            K:C
            %%begintext
            This is a text block.
            It has multiple lines.
            %%endtext
            C D E F |
        """.trimIndent()
        
        val parser = AntlrAbcParser()
        val tune = parser.parse(abc)
        
        val elements = tune.body.elements
        val textBlock = elements.filterIsInstance<TextBlockElement>().firstOrNull()
        
        assertNotNull(textBlock, "Should find a TextBlockElement")
        
        val content = textBlock!!.content
        // Content lines should match lines inside
        assertTrue(content.any { it.contains("This is a text block.") }, "Content should contain line 1")
        assertTrue(content.any { it.contains("It has multiple lines.") }, "Content should contain line 2")
    }
}
</file>

<file path="abc-test/pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>io.github.ryangardner</groupId>
        <artifactId>abc-jvm-parent</artifactId>
        <version>0.1.0-SNAPSHOT</version>
    </parent>

    <artifactId>abc-test</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-simple</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>io.github.ryangardner</groupId>
            <artifactId>abc-core</artifactId>
        </dependency>
        <dependency>
            <groupId>io.github.ryangardner</groupId>
            <artifactId>abc-parser</artifactId>
        </dependency>
        <dependency>
            <groupId>io.github.ryangardner</groupId>
            <artifactId>abc-parser-v2</artifactId>
            <version>${project.version}</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>io.github.ryangardner</groupId>
            <artifactId>abc-theory</artifactId>
        </dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-stdlib</artifactId>
        </dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-test-junit5</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter-params</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>com.google.code.gson</groupId>
            <artifactId>gson</artifactId>
            <version>2.10.1</version>
            <scope>test</scope>
        </dependency>
    </dependencies>
</project>
</file>

<file path="abc-theory/src/main/kotlin/io/github/ryangardner/abc/theory/util/KeyParserUtil.kt">
package io.github.ryangardner.abc.theory.util

import io.github.ryangardner.abc.core.model.*

public object KeyParserUtil {

    private val RECOGNIZED_MODES = setOf(
        "m", "min", "minor", "aeolian",
        "maj", "major", "ion", "ionian",
        "dor", "dorian",
        "phr", "phrygian",
        "lyd", "lydian",
        "mix", "mixolydian",
        "loc", "locrian"
    )

    private val RESERVED_CLEF_NAMES = setOf(
        "treble", "bass", "alto", "tenor", "perc", "none", "mezzosoprano", "soprano", "baritone", "subbass"
    )

    public fun parse(keyText: String): KeySignature {
        val trimmed = keyText.substringBefore("%").trim()
        if (trimmed.isEmpty()) {
            return KeySignature(KeyRoot(NoteStep.C, Accidental.NATURAL), KeyMode.IONIAN)
        }
        val parts = trimmed.split("\\s+".toRegex())
        var firstWord = parts[0]
        
        // If the first word is a known clef name, the key is implicitly C Major
        val lowerFirst = firstWord.lowercase()
        if (RESERVED_CLEF_NAMES.any { lowerFirst.startsWith(it) }) {
             return KeySignature(KeyRoot(NoteStep.C, Accidental.NATURAL), KeyMode.IONIAN)
        }

        if (firstWord.isEmpty()) {
             return KeySignature(KeyRoot(NoteStep.C, Accidental.NATURAL), KeyMode.IONIAN)
        }

        // 0. Handle Highland Bagpipe special keys
        if (firstWord == "HP" || firstWord == "Hp") {
            // HP/Hp implies a specific set of sharps (F#, C#) and Gn. 
            // In MIDI terms, this is typically represented as D Major (F#, C#) or A Mixolydian.
            // Many implementations use D Major as the baseline for HP.
            return KeySignature(KeyRoot(NoteStep.D, Accidental.NATURAL), KeyMode.IONIAN)
        }

        // 1. Identify tonic step
        val step = when (firstWord[0].uppercaseChar()) {
            'C' -> NoteStep.C
            'D' -> NoteStep.D
            'E' -> NoteStep.E
            'F' -> NoteStep.F
            'G' -> NoteStep.G
            'A' -> NoteStep.A
            'B' -> NoteStep.B
            else -> NoteStep.C
        }

        // 2. Identify tonic accidental
        var accidental = Accidental.NATURAL
        var offset = 1
        if (firstWord.length > 1) {
            if (firstWord[1] == '#') {
                accidental = Accidental.SHARP
                offset = 2
                if (firstWord.length > 2 && firstWord[2] == '#') {
                    accidental = Accidental.DOUBLE_SHARP
                    offset = 3
                }
            } else if (firstWord[1] == 'b') {
                accidental = Accidental.FLAT
                offset = 2
                if (firstWord.length > 2 && firstWord[2] == 'b') {
                    accidental = Accidental.DOUBLE_FLAT
                    offset = 3
                }
            }
        }

        // 3. Identify mode
        val remainder = if (firstWord.length > offset) firstWord.substring(offset) else null
        val secondWord = if (parts.size > 1) parts[1] else null
        
        val modeStr = when {
            remainder != null && isRecognized(remainder) -> remainder
            secondWord != null && isRecognized(secondWord) -> secondWord
            // If neither is "recognized", but remainder exists, it might be the mode (e.g. "m")
            remainder != null -> remainder
            else -> secondWord
        }

        return KeySignature(KeyRoot(step, accidental), KeyMode.fromString(modeStr))
    }

    private fun isRecognized(s: String): Boolean {
        val mode = s.lowercase().takeWhile { it.isLetter() }
        return RECOGNIZED_MODES.contains(mode)
    }
}
</file>

<file path="abc-theory/src/main/kotlin/io/github/ryangardner/abc/theory/MeasureValidator.kt">
package io.github.ryangardner.abc.theory

import io.github.ryangardner.abc.core.model.*
import kotlin.math.abs

public object MeasureValidator {

    /**
     * Validates that all measures in the tune (except possibly the first and last)
     * sum up to the expected duration defined by the time signature.
     * 
     * @return A list of validation errors. If empty, the tune is semantically valid for rhythm.
     */
    public fun validate(tune: AbcTune): List<MeasureError> {
        val errors = mutableListOf<MeasureError>()
        var currentMeter = tune.header.meter
        var targetValue = currentMeter.toDouble()
        var currentDefaultLength = tune.header.length

        // Track state per voice
        val voiceSums = mutableMapOf<String, Double>()
        val voiceMeasureIndices = mutableMapOf<String, Int>()
        
        var currentVoice = "default"
        var inTupletRemainingNotes = 0
        var tupletMultiplier = 1.0

        tune.body.elements.forEach { element ->
            when (element) {
                is NoteElement -> {
                    val duration = element.length.toDouble()
                    val scaled = if (inTupletRemainingNotes > 0) {
                        inTupletRemainingNotes--
                        duration * tupletMultiplier
                    } else duration
                    voiceSums[currentVoice] = (voiceSums[currentVoice] ?: 0.0) + scaled
                }
                is RestElement -> {
                    val duration = element.duration.toDouble()
                    val scaled = if (inTupletRemainingNotes > 0) {
                        inTupletRemainingNotes--
                        duration * tupletMultiplier
                    } else duration
                    voiceSums[currentVoice] = (voiceSums[currentVoice] ?: 0.0) + scaled
                }
                is ChordElement -> {
                    val duration = element.duration.toDouble()
                    val scaled = if (inTupletRemainingNotes > 0) {
                        inTupletRemainingNotes--
                        duration * tupletMultiplier
                    } else duration
                    voiceSums[currentVoice] = (voiceSums[currentVoice] ?: 0.0) + scaled
                }
                is TupletElement -> {
                    val r = element.r ?: element.p
                    val q = element.q ?: calculateDefaultQ(element.p)
                    tupletMultiplier = q.toDouble() / element.p.toDouble()
                    inTupletRemainingNotes = r
                }
                is InlineFieldElement -> {
                    val cleanValue = element.value.split(" ", "%").first().trim()
                    when (element.fieldType) {
                        HeaderType.METER -> {
                            val parts = cleanValue.split("/")
                            if (parts.size == 2) {
                                currentMeter = TimeSignature(parts[0].toIntOrNull() ?: 4, parts[1].toIntOrNull() ?: 4)
                                targetValue = currentMeter.toDouble()
                            }
                        }
                        HeaderType.VOICE -> {
                            currentVoice = cleanValue
                        }
                        HeaderType.LENGTH -> {
                            val parts = cleanValue.split("/")
                            if (parts.size == 2) {
                                currentDefaultLength = NoteDuration(parts[0].toIntOrNull() ?: 1, parts[1].toIntOrNull() ?: 8)
                            }
                        }
                        else -> {}
                    }
                }
                is BodyHeaderElement -> {
                    val cleanValue = element.value.split(" ", "%").first().trim()
                    if (element.key == "V") {
                        currentVoice = cleanValue
                    } else if (element.key == "M") {
                        val parts = cleanValue.split("/")
                        if (parts.size == 2) {
                            currentMeter = TimeSignature(parts[0].toIntOrNull() ?: 4, parts[1].toIntOrNull() ?: 4)
                            targetValue = currentMeter.toDouble()
                        }
                    } else if (element.key == "L") {
                        val parts = cleanValue.split("/")
                        if (parts.size == 2) {
                            currentDefaultLength = NoteDuration(parts[0].toIntOrNull() ?: 1, parts[1].toIntOrNull() ?: 8)
                        }
                    }
                }
                is BarLineElement -> {
                    val currentMeasureIdx = voiceMeasureIndices[currentVoice] ?: 0
                    val sum = voiceSums[currentVoice] ?: 0.0
                    
                    if (currentMeasureIdx > 0 && sum > 0.0) {
                        if (abs(sum - targetValue) > 0.0001) {
                            errors.add(MeasureError(currentMeasureIdx, sum, targetValue, currentVoice))
                        }
                    }
                    
                    voiceSums[currentVoice] = 0.0
                    voiceMeasureIndices[currentVoice] = currentMeasureIdx + 1
                }
                else -> {}
            }
        }

        return errors
    }

    private fun calculateDefaultQ(p: Int): Int {
        return when (p) {
            2 -> 3
            3 -> 2
            4 -> 3
            5 -> 2
            6 -> 2
            7 -> 3
            8 -> 3
            9 -> 2
            else -> 2
        }
    }
}

public data class MeasureError(
    val measureIndex: Int,
    val actualDuration: Double,
    val expectedDuration: Double,
    val voice: String
)
</file>

<file path="abc-theory/src/main/kotlin/io/github/ryangardner/abc/theory/PitchInterpreter.kt">
package io.github.ryangardner.abc.theory

import io.github.ryangardner.abc.core.model.*
import io.github.ryangardner.abc.theory.util.KeyParserUtil
import org.slf4j.Logger
import org.slf4j.LoggerFactory

public data class InterpretedNote(
    public val pitches: List<Pitch>,
    public val midiPitches: List<Int>, // Absolute MIDI pitches (after transpositions)
    /**
     * The written duration as indicated by the score's notation (e.g., a quarter note).
     * This value corresponds to the visual length of the note symbol on the staff.
     * In ABC, this is the note length multiplied by the default unit length (L:).
     * (Matches abcjs's "duration" property in notation JSON).
     */
    public val duration: NoteDuration,
    /**
     * The nominal musical duration of the note within the rhythmic grid.
     * This accounts for tuplets (e.g. 3 notes in the time of 2) to maintain proper 
     * measure alignment, but provides the "clean" theoretical value before any 
     * performative interpretation (like grace notes stealing time) is applied.
     * (Matches music21's scaled length).
     */
    public val semanticDuration: NoteDuration,
    /**
     * The performative duration of the note as it would be heard.
     * This includes both tuplet scaling and "duration stealing" from embellishments 
     * like grace notes. Different playback engines may have different opinions 
     * on how much time an embellishment "steals" from its neighbor.
     * (Matches the duration found in abcjs MIDI tracks).
     */
    public val playedDuration: NoteDuration,
    /**
     * Indicates the event is a rest (silence) rather than a pitched note.
     */
    public val isRest: Boolean = false,
    /**
     * Indicates the note is a grace note (embellishment) which has no nominal 
     * duration in the rhythmic grid, but may "steal" performative time (playedDuration) 
     * from the following main note.
     */
    public val isGrace: Boolean = false,
    /**
     * Indicates that this note is a continuation of a tie from a previous note.
     * Tied notes represent a single sustained sound across rhythmic boundaries 
     * rather than separate articulations.
     */
    public val isTieContinued: Boolean = false
)

public data class InterpretedTune(
    public val voices: Map<String, List<InterpretedNote>>,
    public val validationErrors: List<String> = emptyList()
)

public object PitchInterpreter {
    private val logger: Logger = LoggerFactory.getLogger(PitchInterpreter::class.java)

    public fun interpret(tune: AbcTune): InterpretedTune {
        // abcjs MIDI output expands repeats, so we must expand them to achieve bit-perfect parity.
        val expandedElements = RepeatExpander.expand(tune)
        return interpretElements(tune, expandedElements)
    }

    public fun interpretUnexpanded(tune: AbcTune): InterpretedTune {
        return interpretElements(tune, tune.body.elements)
    }

    private fun interpretElements(tune: AbcTune, elements: List<MusicElement>): InterpretedTune {
        val validationErrors = mutableListOf<String>()
        val voices = mutableMapOf<String, MutableList<InterpretedNote>>()
        var currentVoiceId = "1"
        
        data class TupletState(val q: Int, val p: Int, var remainingNotes: Int)

        class VoiceState(
            var currentKey: KeySignature,
            var currentMeter: TimeSignature,
            val activeAccidentals: MutableMap<Pair<NoteStep, Int>, Accidental> = mutableMapOf(),
            var midiTranspose: Int = 0,
            var activeTuplet: TupletState? = null,
            val pendingGraceNotes: MutableList<InterpretedNote> = mutableListOf(),
            var measureDuration: NoteDuration = NoteDuration(0, 1),
            var measureCount: Int = 0
        )

        val voiceStates = mutableMapOf<String, VoiceState>()
        
        var globalMidiTranspose = 0

        fun getVoiceState(id: String): VoiceState {
            return voiceStates.getOrPut(id) {
                VoiceState(
                    currentKey = tune.header.key,
                    currentMeter = tune.header.meter,
                    midiTranspose = globalMidiTranspose
                )
            }
        }
        
        // Initialize from header voices and other fields
        tune.header.headers.forEach { (id, value) ->
            when (id) {
                "V" -> {
                    val voiceId = value.split(" ", "\t").first()
                    val vState = getVoiceState(voiceId)
                    parseCombinedTransposition(value)?.let { vState.midiTranspose = it }
                }
                "K" -> {
                    // Default voice (1) should pick up transposition from primary K: if not already set by V:
                    val vState = getVoiceState("1")
                    parseCombinedTransposition(value)?.let { vState.midiTranspose = it }
                }
                "%%" -> {
                    if (value.startsWith("MIDI transpose", ignoreCase = true)) {
                        val transpose = value.split("\\s+".toRegex()).last().toIntOrNull() ?: 0
                        globalMidiTranspose = transpose
                        voiceStates.values.forEach { it.midiTranspose = transpose }
                    }
                }
            }
        }

        // Initialize first voice
        getVoiceState(currentVoiceId)

        // Tie tracking: (voice, List<MIDI pitches>) to (voice, noteIndex)
        val openTies = mutableMapOf<Pair<String, List<Int>>, Pair<String, Int>>()

        elements.forEach { element ->
            val vState = getVoiceState(currentVoiceId)
            
            when (element) {
                is BodyHeaderElement -> {
                    when (element.key) {
                        "V" -> {
                            currentVoiceId = element.value.split(" ", "\t").first()
                            val newState = getVoiceState(currentVoiceId)
                            parseCombinedTransposition(element.value)?.let { newState.midiTranspose = it }
                        }
                        "K" -> {
                            vState.currentKey = KeyParserUtil.parse(element.value)
                            parseCombinedTransposition(element.value)?.let { vState.midiTranspose = it }
                        }
                        "M" -> {
                            vState.currentMeter = parseMeter(element.value)
                        }
                    }
                }
                is InlineFieldElement -> {
                    when (element.fieldType) {
                        HeaderType.KEY -> {
                            vState.currentKey = KeyParserUtil.parse(element.value)
                            parseCombinedTransposition(element.value)?.let { vState.midiTranspose = it }
                        }
                        HeaderType.VOICE -> {
                            currentVoiceId = element.value.split(" ", "\t").first()
                            val newState = getVoiceState(currentVoiceId)
                            parseCombinedTransposition(element.value)?.let { newState.midiTranspose = it }
                        }
                        HeaderType.METER -> {
                            vState.currentMeter = parseMeter(element.value)
                        }
                        else -> {}
                    }
                }
                is DirectiveElement -> {
                    if (element.content.startsWith("MIDI transpose", ignoreCase = true)) {
                        vState.midiTranspose = element.content.split("\\s+".toRegex()).last().toIntOrNull() ?: 0
                    }
                }
                is TupletElement -> {
                    val p = element.p
                    val isCompound = (vState.currentMeter.numerator % 3 == 0 && vState.currentMeter.numerator > 3)
                    
                    val q = element.q ?: when (p) {
                        2 -> 3
                        3 -> 2
                        4 -> 3
                        5 -> if (isCompound) 3 else 2
                        6 -> 2
                        7 -> if (isCompound) 3 else 2
                        8 -> 3
                        9 -> 2
                        else -> 2
                    }
                    val r = element.r ?: p
                    vState.activeTuplet = TupletState(q, p, r)
                }
                is GraceNoteElement -> {
                    element.notes.forEach { note ->
                        val interpretedPitch = interpret(note, vState.currentKey, vState.activeAccidentals)
                        val midiPitch = interpretedPitch.midiNoteNumber + vState.midiTranspose
                        vState.pendingGraceNotes.add(InterpretedNote(
                            pitches = listOf(interpretedPitch), 
                            midiPitches = listOf(midiPitch),
                            duration = note.length, 
                            semanticDuration = NoteDuration(0, 1),
                            playedDuration = note.length,
                            isGrace = true
                        ))
                        
                        val explicitAccidental = note.pitch.accidental ?: note.accidental
                        if (explicitAccidental != null) {
                            vState.activeAccidentals[note.pitch.step to note.pitch.octave] = explicitAccidental
                        }
                    }
                }
                is NoteElement -> {
                    if (logger.isDebugEnabled) {
                        logger.debug("Interpreting pitch for note ${element.pitch.step.name} octave ${element.pitch.octave}")
                    }
                    val interpretedPitch = interpret(element, vState.currentKey, vState.activeAccidentals)
                    // Apply combined transposition (chromatic + octave + clef)
                    val midiPitch = interpretedPitch.midiNoteNumber + vState.midiTranspose
                    
                    val explicitAccidental = element.pitch.accidental ?: element.accidental
                    if (explicitAccidental != null) {
                        vState.activeAccidentals[element.pitch.step to element.pitch.octave] = explicitAccidental
                    }
                    
                    val tuplet = vState.activeTuplet
                    var duration = element.length
                    var playedDuration = duration
                    if (tuplet != null && tuplet.remainingNotes > 0) {
                        playedDuration = playedDuration.multiply(tuplet.q, tuplet.p)
                        tuplet.remainingNotes--
                        if (tuplet.remainingNotes == 0) vState.activeTuplet = null
                    }
                    val semanticDuration = playedDuration
                    vState.measureDuration += semanticDuration

                    // Grace note duration stealing
                    val rawGraceNotes = vState.pendingGraceNotes
                    if (rawGraceNotes.isNotEmpty()) {
                        val stolenTotal = playedDuration.multiply(1, 2)
                        val perGraceNodeStolen = stolenTotal.multiply(1, rawGraceNotes.size)
                        val scaledGraceNotes = rawGraceNotes.map { it.copy(playedDuration = perGraceNodeStolen) }
                        playedDuration = addDurations(playedDuration, stolenTotal.multiply(-1, 1))
                        
                        val voiceList = voices.getOrPut(currentVoiceId) { mutableListOf() }
                        voiceList.addAll(scaledGraceNotes)
                        rawGraceNotes.clear()
                    }

                    val voiceList = voices.getOrPut(currentVoiceId) { mutableListOf() }
                    
                    val midiPitches = listOf(midiPitch)
                    val tieKey = currentVoiceId to midiPitches
                    
                    // Fuzzy tie matching: if no explicit accidental, allow matching a tie with different accidental but same base pitch
                    var tiedFrom = openTies[tieKey]
                    var adjustedMidiPitch = midiPitch
                    
                    if (tiedFrom == null && element.pitch.accidental == null && element.accidental == null) {
                        // Check for open ties in this voice with the same (Step, Octave)
                        val potentialTie = openTies.entries.find { (key, _) -> 
                            key.first == currentVoiceId && key.second.size == 1 && (key.second[0] % 12 == midiPitch % 12) && Math.abs(key.second[0] - midiPitch) < 12
                        }
                        
                        val heuristicMatch = openTies.entries.find { (key, _) ->
                            key.first == currentVoiceId && key.second.size == 1 && Math.abs(key.second[0] - midiPitch) <= 2
                        }
                        if (heuristicMatch != null) {
                            tiedFrom = heuristicMatch.value
                            adjustedMidiPitch = heuristicMatch.key.second[0]
                        }
                    }

                    if (tiedFrom != null) {
                        val originalList = voices[tiedFrom.first]!!
                        val originalNote = originalList[tiedFrom.second]
                        originalList[tiedFrom.second] = originalNote.copy(
                            playedDuration = addDurations(originalNote.playedDuration, playedDuration),
                            semanticDuration = addDurations(originalNote.semanticDuration, semanticDuration)
                        )
                        voiceList.add(InterpretedNote(pitches = emptyList(), midiPitches = emptyList(), duration = duration, semanticDuration = semanticDuration, playedDuration = playedDuration, isTieContinued = true))
                        
                        // Use the tieKey associated with the ACTUAL pitch we tied to
                        val actualTieKey = currentVoiceId to listOf(adjustedMidiPitch)
                        if (element.ties == TieType.START || element.ties == TieType.BOTH) {
                            openTies[actualTieKey] = tiedFrom
                        } else {
                            openTies.remove(actualTieKey)
                        }
                    } else {
                        val newNoteIndex = voiceList.size
                        voiceList.add(InterpretedNote(pitches = listOf(interpretedPitch), midiPitches = midiPitches, duration = duration, semanticDuration = semanticDuration, playedDuration = playedDuration))
                        if (element.ties == TieType.START || element.ties == TieType.BOTH) {
                            openTies[tieKey] = currentVoiceId to newNoteIndex
                        }
                    }
                }
                is ChordElement -> {
                    val interpretedPitches = element.notes.map { note ->
                        val interpretedPitch = interpret(note, vState.currentKey, vState.activeAccidentals)
                        val explicitAccidental = note.pitch.accidental ?: note.accidental
                        if (explicitAccidental != null) {
                            vState.activeAccidentals[note.pitch.step to note.pitch.octave] = explicitAccidental
                        }
                        interpretedPitch
                    }
                    // Apply combined transposition
                    val midiPitches = interpretedPitches.map { it.midiNoteNumber + vState.midiTranspose }

                    val tuplet = vState.activeTuplet
                    var duration = element.duration
                    var playedDuration = duration
                    if (tuplet != null && tuplet.remainingNotes > 0) {
                        playedDuration = playedDuration.multiply(tuplet.q, tuplet.p)
                        tuplet.remainingNotes--
                        if (tuplet.remainingNotes == 0) vState.activeTuplet = null
                    }
                    val semanticDuration = playedDuration

                    // Grace note duration stealing
                    val rawGraceNotes = vState.pendingGraceNotes
                    if (rawGraceNotes.isNotEmpty()) {
                        val stolenTotal = playedDuration.multiply(1, 2)
                        val perGraceNodeStolen = stolenTotal.multiply(1, rawGraceNotes.size)
                        val scaledGraceNotes = rawGraceNotes.map { it.copy(playedDuration = perGraceNodeStolen) }
                        playedDuration = addDurations(playedDuration, stolenTotal.multiply(-1, 1))
                        
                        val voiceList = voices.getOrPut(currentVoiceId) { mutableListOf() }
                        voiceList.addAll(scaledGraceNotes)
                        rawGraceNotes.clear()
                    }

                    val voiceList = voices.getOrPut(currentVoiceId) { mutableListOf() }

                    val sortedMidi = midiPitches.sorted()
                    val tieKey = currentVoiceId to sortedMidi
                    val tiedFrom = openTies[tieKey]
                    
                    if (tiedFrom != null) {
                        val originalList = voices[tiedFrom.first]!!
                        val originalNote = originalList[tiedFrom.second]
                        originalList[tiedFrom.second] = originalNote.copy(
                            playedDuration = addDurations(originalNote.playedDuration, playedDuration),
                            semanticDuration = addDurations(originalNote.semanticDuration, semanticDuration)
                        )
                        voiceList.add(InterpretedNote(pitches = emptyList(), midiPitches = emptyList(), duration = duration, semanticDuration = semanticDuration, playedDuration = playedDuration))
                        
                        val hasTieOut = element.notes.firstOrNull()?.ties?.let { it == TieType.START || it == TieType.BOTH } ?: false
                        if (hasTieOut) {
                            openTies[tieKey] = tiedFrom
                        } else {
                            openTies.remove(tieKey)
                        }
                    } else {
                        val newNoteIndex = voiceList.size
                        voiceList.add(InterpretedNote(pitches = interpretedPitches, midiPitches = midiPitches, duration = duration, semanticDuration = semanticDuration, playedDuration = playedDuration))
                        val hasTieOut = element.notes.firstOrNull()?.ties?.let { it == TieType.START || it == TieType.BOTH } ?: false
                        if (hasTieOut) {
                            openTies[tieKey] = currentVoiceId to newNoteIndex
                        }
                    }
                }
                is RestElement -> {
                    val tuplet = vState.activeTuplet
                    var duration = element.duration
                    var playedDuration = duration
                    if (tuplet != null && tuplet.remainingNotes > 0) {
                        playedDuration = playedDuration.multiply(tuplet.q, tuplet.p)
                        tuplet.remainingNotes--
                        if (tuplet.remainingNotes == 0) vState.activeTuplet = null
                    }
                    val semanticDuration = playedDuration

                    voices.getOrPut(currentVoiceId) { mutableListOf() }.add(
                        InterpretedNote(pitches = emptyList(), midiPitches = emptyList(), duration = duration, semanticDuration = semanticDuration, playedDuration = playedDuration, isRest = true)
                    )
                }
                is BarLineElement -> {
                    vState.activeAccidentals.clear()
                    
                    val expectedTotal = NoteDuration(vState.currentMeter.numerator, vState.currentMeter.denominator)
                    if (vState.measureDuration.numerator != 0 && vState.measureDuration != expectedTotal) {
                        // Accept pickups (first bar shorter) or incomplete complements
                        if (vState.measureCount == 0 && vState.measureDuration.toDouble() < expectedTotal.toDouble()) {
                             // OK
                        } else {
                            validationErrors.add("Voice $currentVoiceId Measure ${vState.measureCount + 1}: Rhythmic mismatch. Expected $expectedTotal, found ${vState.measureDuration}")
                        }
                    }
                    vState.measureCount++
                    vState.measureDuration = NoteDuration(0, 1)
                }
                is VariantElement -> {
                    // Variants are handled by the RepeatExpander, no state change needed here.
                }
                else -> {}
            }
        }
        
        return InterpretedTune(voices, validationErrors)
    }

    private fun parseCombinedTransposition(text: String): Int? {
        val lower = text.lowercase()
        var totalShift = 0
        var foundAny = false
        
        // 1. Check for clef-based octave modifiers
        val clefShift = when {
            lower.contains("treble-8") || lower.contains("treble8vb") -> -12
            lower.contains("bass+8") || lower.contains("bass8va") -> 12
            lower.contains("-8va") || lower.contains("8vb") || lower.contains("-8") || lower.contains("8-") -> -12
            lower.contains("+8va") || lower.contains("8va") || lower.contains("+8") || lower.contains(" treble8") -> 12
            lower.contains("clef=bass") -> -24 // Standard bass clef shift from treble baseline
            lower.contains("clef=alto") -> -12 // Standard alto clef shift
            else -> null
        }
        if (clefShift != null) {
            totalShift += clefShift
            foundAny = true
        }
        
        // 2. Check for transpose=N
        val transposeRegex = "transpose=([-]?\\d+)".toRegex()
        transposeRegex.find(text)?.let {
            totalShift += it.groupValues[1].toIntOrNull() ?: 0
            foundAny = true
        }
        
        // 3. Check for octave=N
        val octaveRegex = "octave=([-]?\\d+)".toRegex()
        octaveRegex.find(text)?.let {
            totalShift += (it.groupValues[1].toIntOrNull() ?: 0) * 12
            foundAny = true
        }
        
        return if (foundAny) totalShift else null
    }

    private fun addDurations(d1: NoteDuration, d2: NoteDuration): NoteDuration {
        val commonDenom = d1.denominator.toLong() * d2.denominator.toLong()
        val newNum = d1.numerator.toLong() * d2.denominator + d2.numerator.toLong() * d1.denominator
        return NoteDuration.simplify(newNum.toInt(), commonDenom.toInt())
    }

    private fun NoteDuration.multiply(p: Int, q: Int): NoteDuration {
        return NoteDuration.simplify(this.numerator * p, this.denominator * q)
    }

    private fun NoteDuration.multiply(multiplier: Double): NoteDuration {
        // Fallback for non-simple multipliers
        val newNumerator = (this.numerator * multiplier * 1000).toInt()
        val newDenominator = this.denominator * 1000
        return NoteDuration.simplify(newNumerator, newDenominator)
    }

    private fun parseMeter(text: String): TimeSignature {
        return when (text) {
            "C" -> TimeSignature(4, 4, "C")
            "C|" -> TimeSignature(2, 2, "C|")
            "none" -> TimeSignature(4, 4) // Default
            else -> {
                val parts = text.split("/")
                if (parts.size == 2) {
                    TimeSignature(parts[0].trim().toIntOrNull() ?: 4, parts[1].trim().toIntOrNull() ?: 4)
                } else TimeSignature(4, 4)
            }
        }
    }

    /**
     * Interprets a literal note based on the current key signature and any active accidentals in the measure.
     * 
     * @param note The literal note parsed from ABC (may have explicit accidental or not)
     * @param key The current key signature
     * @param activeAccidentals A map of step to accidental active in the current measure
     * @return The absolute pitch
     */
    public fun interpret(note: NoteElement, key: KeySignature, activeAccidentals: Map<Pair<NoteStep, Int>, Accidental>): Pitch {
        val step = note.pitch.step
        val octave = note.pitch.octave
        val explicitAccidental = note.pitch.accidental ?: note.accidental

        val interpretedAccidental = if (explicitAccidental != null) {
            explicitAccidental
        } else if (activeAccidentals.containsKey(step to octave)) {
            activeAccidentals[step to octave]
        } else {
            val fromKey = getAccidentalFromKey(step, key)
            if (logger.isDebugEnabled) {
                logger.debug("Pitch $step at octave $octave using accidental from key: $fromKey")
            }
            fromKey
        }
        
        if (logger.isDebugEnabled) {
            logger.debug("Pitch $step at octave $octave interpreted accidental: $interpretedAccidental")
        }

        return note.pitch.copy(accidental = interpretedAccidental)
    }

    private fun getAccidentalFromKey(step: NoteStep, key: KeySignature): Accidental? {
        val candidate = CircleOfFifths.getBestKey(key)
        val k = candidate.accidentalsCount
        
        val accidentalValue = CircleOfFifths.getAccidentalForStep(step, k)
        return CircleOfFifths.semitonesToAccidental(accidentalValue)
    }
}
</file>

<file path="abc-theory/src/main/kotlin/io/github/ryangardner/abc/theory/RepeatExpander.kt">
package io.github.ryangardner.abc.theory

import io.github.ryangardner.abc.core.model.*

/**
 * Expands repeats and variants in an ABC tune to produce a linear sequence of elements.
 * This is necessary for MIDI generation to match abcjs's output.
 */
public object RepeatExpander {

    public fun expand(tune: AbcTune): List<MusicElement> {
        val elements = tune.body.elements
        val playingOrder = tune.header.playingOrder
        
        if (playingOrder != null && playingOrder.isNotEmpty()) {
            return expandWithParts(tune, playingOrder)
        }

        // Expand voices individually
        val voiceElements = mutableMapOf<String, MutableList<MusicElement>>()
        var currentVoice = "1"
        elements.forEach { element ->
            if (element is BodyHeaderElement && element.key == "V") {
                currentVoice = element.value.split(" ", "\t").first()
            }
            voiceElements.getOrPut(currentVoice) { mutableListOf() }.add(element)
        }

        val expandedVoices = voiceElements.mapValues { (id, vElements) -> 
            val expanded = expandSingleVoice(vElements)
            expanded
        }
        
        // Re-interleave for PitchInterpreter
        val result = mutableListOf<MusicElement>()
        expandedVoices.forEach { (voiceId, vElements) ->
            result.add(BodyHeaderElement("V", voiceId))
            result.addAll(vElements)
        }
        return result
    }

    private fun expandWithParts(tune: AbcTune, playingOrder: String): List<MusicElement> {
        val bodyElements = tune.body.elements
        
        // 1. Segment body into parts
        val partMap = mutableMapOf<String, MutableList<MusicElement>>()
        var currentPartName = "START" // Elements before the first P:
        
        bodyElements.forEach { el ->
            if (el is PartElement) {
                currentPartName = el.name
            }
            partMap.getOrPut(currentPartName) { mutableListOf() }.add(el)
        }
        
        // 2. Parse playing order
        val sequence = parsePlayingOrder(playingOrder)
        
        // 3. Assemble full sequence
    val assembled = mutableListOf<MusicElement>()
    sequence.forEach { partName ->
        val partElements = partMap[partName]
        if (partElements != null) {
            assembled.addAll(partElements)
        } else if (partMap.size == 1 && partMap.containsKey("START")) {
            // If No parts are defined, but a sequence is given, maybe it's just repeating the whole thing?
            // But if the name is descriptive (like "piffero"), this is dangerous.
            // Requirement for P: parts is usually they match labels.
            // Let's be conservative: if not found, don't add.
        }
    }
    
    // If we assembled nothing (e.g. P: header was just descriptive text), return original body
    if (assembled.isEmpty()) {
        return expand(tune.copy(header = tune.header.copy(playingOrder = null)))
    }

    // 4. Expand repeats within the assembled stream
    // Note: we need to handle voices too. 
    // For simplicity, let's just use the same expand logic on the assembled stream.
    // We'll wrap it in a dummy tune to reuse the existing expand() logic's voice splitting.
    val dummyTune = tune.copy(body = TuneBody(assembled), header = tune.header.copy(playingOrder = null))
    return expand(dummyTune)
}

private fun parsePlayingOrder(order: String): List<String> {
    var i = 0
    
    fun parseInternal(): List<String> {
        val local = mutableListOf<String>()
        while (i < order.length && order[i] != ')') {
            if (order[i] == '(') {
                i++
                val group = parseInternal()
                if (i < order.length && order[i] == ')') i++
                
                if (i < order.length && order[i].isDigit()) {
                    val numStr = StringBuilder()
                    while (i < order.length && order[i].isDigit()) {
                        numStr.append(order[i])
                        i++
                    }
                    val count = numStr.toString().toInt().coerceAtMost(24) // Sanity limit for repeats
                    repeat(count) { local.addAll(group) }
                } else {
                    local.addAll(group)
                }
            } else if (order[i].isLetter()) {
                val part = order[i].toString()
                i++
                if (i < order.length && order[i].isDigit()) {
                    val numStr = StringBuilder()
                    while (i < order.length && order[i].isDigit()) {
                        numStr.append(order[i])
                        i++
                    }
                    val count = numStr.toString().toInt().coerceAtMost(24) // Sanity limit
                    repeat(count) { local.add(part) }
                } else {
                    local.add(part)
                }
            } else {
                i++ // Skip spaces, dots, etc.
            }
        }
        return local
    }
    
    return parseInternal()
}

    private fun expandSingleVoice(elements: List<MusicElement>): List<MusicElement> {
        val output = mutableListOf<MusicElement>()
        var windowStart = 0
        var i = 0
        
        while (i < elements.size) {
            val el = elements[i]
            
            if (el is BarLineElement && (el.type == BarLineType.REPEAT_END || el.type == BarLineType.REPEAT_BOTH)) {
                val block = elements.subList(windowStart, i + 1)
                val passes = if (el.repeatCount > 0) el.repeatCount.coerceAtMost(24) else 2
                
                for (p in 1..passes) {
                    var active = true
                    block.forEach { bEl ->
                        if (bEl is VariantElement) {
                            active = bEl.variants.contains(p)
                        }
                        
                        if (active) {
                            // Don't add structural repeat bars in middle passes
                            if (bEl === el && p < passes) {
                                output.add(BarLineElement(BarLineType.SINGLE))
                            } else {
                                output.add(bEl)
                            }
                        }
                    }
                }
                
                if (el.type == BarLineType.REPEAT_BOTH) {
                    windowStart = i // Section after :|: starts with this shared bar
                } else {
                    windowStart = i + 1
                }
            } else if (el is BarLineElement && el.type == BarLineType.REPEAT_START) {
                // Elements before the |: are added directly
                if (windowStart < i) {
                    output.addAll(elements.subList(windowStart, i))
                }
                windowStart = i
            }
            
            if (output.size > 20000) {
                println("ERROR: Expansion runaway detected! elements.size=${elements.size}, output.size=${output.size} at i=$i")
                break
            }
            
            i++
        }
        
        // Add remaining elements after last repeat
        if (windowStart < elements.size) {
            output.addAll(elements.subList(windowStart, elements.size))
        }
        
        return output
    }
}
</file>

<file path="abc-theory/src/test/kotlin/io/github/ryangardner/abc/theory/PitchInterpretationTest.kt">
package io.github.ryangardner.abc.theory

import io.github.ryangardner.abc.core.model.*
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Test

public class PitchInterpretationTest {

    @Test
    public fun `test G Major F is interpreted as F sharp`() {
        val key = KeySignature(KeyRoot(NoteStep.G, Accidental.NATURAL), KeyMode.MAJOR)
        val note = NoteElement(Pitch(NoteStep.F, 4, null), NoteDuration(1, 8))
        
        val interpreted = PitchInterpreter.interpret(note, key, emptyMap())
        assertEquals(Accidental.SHARP, interpreted.accidental)
    }

    @Test
    public fun `test G Major F with natural is interpreted as F natural`() {
        val key = KeySignature(KeyRoot(NoteStep.G, Accidental.NATURAL), KeyMode.MAJOR)
        val note = NoteElement(Pitch(NoteStep.F, 4, Accidental.NATURAL), NoteDuration(1, 8))
        
        val interpreted = PitchInterpreter.interpret(note, key, emptyMap())
        assertEquals(Accidental.NATURAL, interpreted.accidental)
    }

    @Test
    public fun `test F Major B is interpreted as B flat`() {
        val key = KeySignature(KeyRoot(NoteStep.F, Accidental.NATURAL), KeyMode.MAJOR)
        val note = NoteElement(Pitch(NoteStep.B, 4, null), NoteDuration(1, 8))
        
        val interpreted = PitchInterpreter.interpret(note, key, emptyMap())
        assertEquals(Accidental.FLAT, interpreted.accidental)
    }

    @Test
    public fun `test D Minor F is natural`() {
        val key = KeySignature(KeyRoot(NoteStep.D, Accidental.NATURAL), KeyMode.MINOR)
        val note = NoteElement(Pitch(NoteStep.F, 4, null), NoteDuration(1, 8))
        
        val interpreted = PitchInterpreter.interpret(note, key, emptyMap())
        assertEquals(null, interpreted.accidental) // D Minor has B flat, but F is natural
    }

    @Test
    public fun `test D Minor B is interpreted as B flat`() {
        val key = KeySignature(KeyRoot(NoteStep.D, Accidental.NATURAL), KeyMode.MINOR)
        val note = NoteElement(Pitch(NoteStep.B, 4, null), NoteDuration(1, 8))
        
        val interpreted = PitchInterpreter.interpret(note, key, emptyMap())
        assertEquals(Accidental.FLAT, interpreted.accidental)
    }
}
</file>

<file path="abc-theory/src/test/kotlin/io/github/ryangardner/abc/theory/RepeatExpanderTest.kt">
package io.github.ryangardner.abc.theory

import io.github.ryangardner.abc.core.model.*
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Test

class RepeatExpanderTest {

    @Test
    fun testSimpleRepeat() {
        // C D E F |: G A B c :| C4 |]
        val elements = listOf(
            NoteElement(Pitch(NoteStep.C, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.D, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.E, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.F, 4), NoteDuration(1, 4)),
            BarLineElement(BarLineType.REPEAT_START),
            NoteElement(Pitch(NoteStep.G, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.A, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.B, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.C, 5), NoteDuration(1, 4)),
            BarLineElement(BarLineType.REPEAT_END),
            NoteElement(Pitch(NoteStep.C, 4), NoteDuration(1, 1)),
            BarLineElement(BarLineType.FINAL)
        )
        
        val tune = AbcTune(
            header = TuneHeader(1, listOf("Test"), KeySignature(KeyRoot(NoteStep.C, Accidental.NATURAL), KeyMode.IONIAN), TimeSignature(4, 4), NoteDuration(1, 4), null, emptyList(), emptyMap(), "2.1"),
            body = TuneBody(elements),
            metadata = TuneMetadata()
        )
        
        val expanded = RepeatExpander.expand(tune)
        
        val noteCount = expanded.filterIsInstance<NoteElement>().size
        // Original: 4 (before repeat) + 4 (inside repeat) + 1 (after repeat) = 9
        // Expanded: 4 + 4 + 4 + 1 = 13 notes
        assertEquals(13, noteCount, "Note count mismatch after expansion")
    }

    @Test
    fun testRepeatFromBeginning() {
        // C D E F | G A B c :|
        val elements = listOf(
            NoteElement(Pitch(NoteStep.C, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.D, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.E, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.F, 4), NoteDuration(1, 4)),
            BarLineElement(BarLineType.SINGLE),
            NoteElement(Pitch(NoteStep.G, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.A, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.B, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.C, 5), NoteDuration(1, 4)),
            BarLineElement(BarLineType.REPEAT_END)
        )
        
        val tune = AbcTune(
            header = TuneHeader(1, listOf("Test"), KeySignature(KeyRoot(NoteStep.C, Accidental.NATURAL), KeyMode.IONIAN), TimeSignature(4, 4), NoteDuration(1, 4), null, emptyList(), emptyMap(), "2.1"),
            body = TuneBody(elements),
            metadata = TuneMetadata()
        )
        
        val expanded = RepeatExpander.expand(tune)
        
        val noteCount = expanded.filterIsInstance<NoteElement>().size
        // Original: 8. Expanded: 16.
        assertEquals(16, noteCount, "Note count mismatch after expansion from beginning")
    }

    @Test
    fun testPartsExpansion() {
        // P:AAB
        // [P:A] C D E F | [P:B] G A B c |
        val header = TuneHeader(1, listOf("Parts Test"), KeySignature(KeyRoot(NoteStep.C, Accidental.NATURAL), KeyMode.IONIAN), TimeSignature(4, 4), NoteDuration(1, 4), null, emptyList(), emptyMap(), "2.1", "AAB")
        val A = listOf(
            PartElement("A"),
            NoteElement(Pitch(NoteStep.C, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.D, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.E, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.F, 4), NoteDuration(1, 4)),
            BarLineElement(BarLineType.SINGLE)
        )
        val B = listOf(
            PartElement("B"),
            NoteElement(Pitch(NoteStep.G, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.A, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.B, 4), NoteDuration(1, 4)),
            NoteElement(Pitch(NoteStep.C, 5), NoteDuration(1, 4)),
            BarLineElement(BarLineType.SINGLE)
        )
        val tune = AbcTune(header, TuneBody(A + B), TuneMetadata())
        
        val expanded = RepeatExpander.expand(tune)
        
        val notes = expanded.filterIsInstance<NoteElement>()
        assertEquals(12, notes.size, "P:AAB should produce 12 notes (4+4+4)")
        assertEquals(NoteStep.C, notes[0].pitch.step)
        assertEquals(NoteStep.C, notes[4].pitch.step)
        assertEquals(NoteStep.G, notes[8].pitch.step)
    }

    @Test
    fun testNestedPartsExpansion() {
        // P:(AB)2C
        val header = TuneHeader(1, listOf("Nested Parts"), KeySignature(KeyRoot(NoteStep.C, Accidental.NATURAL), KeyMode.IONIAN), TimeSignature(4, 4), NoteDuration(1, 4), null, emptyList(), emptyMap(), "2.1", "(AB)2C")
        val A = listOf(PartElement("A"), NoteElement(Pitch(NoteStep.C, 4), NoteDuration(1, 4)))
        val B = listOf(PartElement("B"), NoteElement(Pitch(NoteStep.D, 4), NoteDuration(1, 4)))
        val C = listOf(PartElement("C"), NoteElement(Pitch(NoteStep.E, 4), NoteDuration(1, 4)))
        
        val tune = AbcTune(header, TuneBody(A + B + C), TuneMetadata())
        val expanded = RepeatExpander.expand(tune)
        
        val notes = expanded.filterIsInstance<NoteElement>()
        // sequence: A B A B C -> 5 notes
        assertEquals(5, notes.size)
        assertEquals(NoteStep.C, notes[0].pitch.step)
        assertEquals(NoteStep.D, notes[1].pitch.step)
        assertEquals(NoteStep.C, notes[2].pitch.step)
        assertEquals(NoteStep.D, notes[3].pitch.step)
        assertEquals(NoteStep.E, notes[4].pitch.step)
    }
}
</file>

<file path="config/detekt/detekt.yml">
complexity:
  active: true
  CyclomaticComplexMethod:
    active: true
    threshold: 100
  TooManyFunctions:
    active: false
  NestedBlockDepth:
    active: true
    threshold: 10
  LongMethod:
    active: false

style:
  active: true
  MagicNumber:
    active: false
  WildcardImport:
    active: false
  NewLineAtEndOfFile:
    active: false
  ReturnCount:
    active: false
  MaxLineLength:
    active: false
</file>

<file path="docs/parser-gotchas.md">
# ABC v2.1 ANTLR Parser: Implementation Notes & Gotchas

This document summarizes the key technical hurdles and "gotchas" encountered while achieving 100% round-trip fidelity for the ABC v2.1 ANTLR parser. These notes serve as a guide for future maintainers and anyone implementing a similar state-sensitive musical parser.

## 1. Stateful Duration Logic (`M:` and `L:`)
**The Challenge**: In ABC 2.1, the meter (`M:`) field implicitly sets the default note length (`L:`) if no `L:` is provided.
- **Gotcha**: If you reset the meter mid-tune, you **must** reset the unit note length according to the formula: `ratio < 0.75 ? 1/16 : 1/8`.
- **Fidelity Impact**: Failure to synchronize this between the **Parser** and the **Serializer** leads to factor-of-2 or factor-of-4 duration mismatches during re-parsing.

## 2. Greedy Rule Prevention
**The Challenge**: ABC notation is a mix of structured fields (e.g., `K:D`) and free-form text/music.
- **Gotcha**: Using `.*` or `.+` for catch-all rules like `HEADER_TEXT` or `MUSIC_TEXT` is extremely dangerous. A greedy `HEADER_TEXT` rule can "swallow" the following `K:` field, causing the parser to fail the tune transition.
- **Solution**: 
  - Use single-character catch-alls (`HEADER_TEXT : . ;`) and prioritize specific tokens (like `KEY_FIELD`) in the lexer.
  - Never allow a text rule to consume `\r` or `\n` if those characters drive structural transitions (like `X:` at the start of a line).

## 3. Lexer Mode Management
**The Challenge**: Decorations (`!...!`), Chords (`"..."`), and Inline Fields (`[...]`) share similar delimiters.
- **Gotcha**: The "Bang Decoration" (`!`) is particularly problematic because it often goes unclosed in legacy files.
- **Persistence Error**: If a lexer mode does not pop on `NEWLINE` for line-based elements, one missing `!` will cause the entire rest of the tune (or file) to be consumed as a "decoration," leading to silent failure or massive element loss.
- **Solution**: Always add a fallback pop for `NEWLINE` in modes like `BANG_DECO_MODE` and `CHORD_MODE`.

## 4. Greedy Loop Consumption (Chord Merging)
**The Challenge**: A chord is defined as `BRACKET_START element* BRACKET_END`.
- **Gotcha**: If `BRACKET_END` (`]`) is itself a valid `element` (e.g., as a Spacer or unknown text), the `*` loop will greedily consume the terminating bracket of the *first* chord and continue into the *next* chord.
- **Fidelity Impact**: `[chord1][chord2]` becomes a single malformed `[chord1 chord2]`.
- **Solution**: Create a restricted `chord_element` rule that explicitly excludes `BRACKET_END`.

## 5. Blank Line Sensitivity
**The Challenge**: ABC 2.1 uses a blank line to terminate a tune body.
- **Gotcha**: The re-parser is hyper-sensitive to "aggregate" whitespace. If the `AbcSerializer` emits a newline for a `SpacerElement` and then adds its own structural newline (e.g., for `V:1`), a blank line is created.
- **Side Effect**: The re-parser sees this blank line as the end of the tune, truncating the element count and causing 0.1 fidelity failures on heavy datasets.

## 6. Microtonal Accidental Ordering
**The Challenge**: Supporting `^^/`, `^/`, `_/`, and `__`.
- **Lexer Trap**: Standard accidental tokens like `^^` and `^` are prefixes of microtonal variants.
- **Ordering**: In the lexer, the longest matches (e.g., `^^/`) must appear **above** shorter matches (`^^`) to avoid premature tokenization.

## 7. Inline Field Context (`[P:A]`)
**The Challenge**: Inline fields share the `[` delimiter with chords.
- **Gotcha**: The lexer often consumes the field ID and colon (e.g., `P:`) as part of the `INLINE_FIELD_START` token.
- **Visitor Trap**: `visitInline_field` cannot simply look for `INLINE_FIELD_CONTENT`. It must use `ctx.text` and manually strip the brackets/colons to distinguish between `[P:A]` and other bracketed content.
</file>

<file path="docs/parser.md">
# **Formal Specification and Implementation Strategy for an ANTLR4 Grammar Targeting the ABC Music Notation 2.1 Standard**

## **1\. Introduction**

The domain of computational musicology and digital score engraving has long grappled with the tension between human readability and machine parsability. While complex XML-based formats like MusicXML provide exhaustive descriptive capabilities, they often lack the conciseness required for rapid transcription or folk tradition preservation. Conversely, the **ABC Music Notation** system has established itself as the de facto standard for traditional music, owing to its ASCII-based compactness and intuitive syntax. Since its inception by Chris Walshaw and its subsequent evolution through versions 1.6, 2.0, and finally the **2.1 Standard (December 2011\)**, ABC has matured from a simple shorthand into a robust language capable of handling polyphony, complex lyrics alignment, and macro-based metaprogramming.1

However, the organic evolution of the ABC standard has resulted in a formal grammar that is notoriously difficult to specify for modern parser generators. Unlike languages designed with Look-Ahead Left-to-Right (LALR) or LL(\*) parsers in mind, ABC 2.1 relies heavily on context-sensitive interpretation, mode-switching syntax, and significant whitespace.3 A definitive, open-source **ANTLR4 (Another Tool for Language Recognition, Version 4\)** grammar for ABC 2.1 remains absent from major repositories.4 Existing solutions often rely on ad-hoc regex engines or legacy BNF definitions that fail to capture the "Strict" vs. "Loose" interpretation modes introduced in the latest standard.6

This report presents a comprehensive research analysis and architectural blueprint for constructing a fully compliant ANTLR4 specification for ABC 2.1. It dissects the standard's syntactical ambiguities, proposes a modal lexing strategy to handle the bipartite nature of tune headers and music bodies, and details the semantic analysis required to resolve context-dependent constructs like inline fields and transposing macros.

### **1.1 Historical Context and Standardization**

The trajectory of ABC notation parallels the rise of the internet as a medium for sharing folk music. Initially designed to encode single-voice Western European melodies, early versions were permissible and loosely defined. The release of ABC 2.1 marked a pivotal shift toward formalization, introducing strict rules for multi-voice synchronization and metadata handling to better compete with or complement formats like LilyPond and MusicXML.3

Understanding this history is crucial for the parser architect because ABC 2.1 requires backward compatibility. The standard explicitly defines two interpretation modes:

1. **Strict Interpretation:** Triggered by the presence of a version field %abc-2.1. In this mode, the parser must enforce rigour, rejecting malformed chords or undefined macros.  
2. **Loose Interpretation:** The default for files lacking a version identifier or labeled 2.0 and below. Here, the parser must be permissive, accepting legacy syntax such as the deprecated \+ decoration delimiters.1

This duality implies that an ANTLR4 grammar cannot be a rigid, static structure; it must be capable of runtime reconfiguration or possess a permissive superstructure that allows a post-parse semantic analyzer to enforce version-specific constraints.

### **1.2 The Parser Gap**

Current tooling for ABC notation is fragmented. Many popular tools, such as abcm2ps or abc2midi, utilize custom-written C parsers that have grown organically over decades.2 While performant, these are difficult to maintain or port to other environments (e.g., Java, Python, JavaScript). A formal ANTLR4 specification offers significant advantages:

* **Target Neutrality:** ANTLR4 can generate parsers for Java, C\#, Python, JavaScript, Go, and C++ from a single grammar file.  
* **Visual Debugging:** The ability to visualize the Parse Tree aids in resolving ambiguities in complex polyphonic scores.  
* **Error Recovery:** ANTLRs sophisticated error recovery mechanisms allow for "best-effort" parsing of malformed files, a common occurrence in user-generated tunebooks.

The objective of this report is to bridge the gap between the informal text of the ABC 2.1 standard and the formal requirements of an ANTLR4 grammar, providing a complete roadmap for implementation.

## **2\. Architectural Analysis of the ABC 2.1 Stream**

Before defining individual tokens, one must understand the high-level architecture of an ABC stream. An ABC file is not a singular entity but a containera "tunebook"comprising a sequence of independent musical works, potentially sharing a common global context.

### **2.1 File Structure and Scope Hierarchy**

The ABC 2.1 standard defines a hierarchical scope that the grammar must reflect. The parsing logic must strictly observe the boundaries defined by specific delimiters, creating a scope stack that influences how tokens are interpreted.

| Scope Level | Delimiter / Initiator | Termination Condition | Content |
| :---- | :---- | :---- | :---- |
| **File Scope** | Start of File / %abc-2.1 | End of File (EOF) | Global Header (Optional), Tune Blocks, Free Text |
| **Tune Scope** | X: (Reference Number) | Empty Line or Next X: | Tune Header, Tune Body |
| **Body Scope** | K: (Key) field | Empty Line or Next X: | Music Code, Inline Fields |
| **Overlay Scope** | & (Voice Overlay) | & or Barline | Parallel Music Code |

**Insight:** The standard notes that a file header (a block of information fields before the first X: field) sets default values for all subsequent tunes.1 However, extracting a tune from a file strips it of this context. Therefore, a robust parser must produce an Abstract Syntax Tree (AST) that "denormalizes" these defaults, injecting the file-level properties into each tune object during the semantic analysis phase.

### **2.2 Character Sets and Encoding**

Early ABC was strictly ASCII. ABC 2.1 formalizes support for strictly defined character sets, primarily utf-8 and the ISO-8859 family.8 This has profound implications for the Lexer.

*
### 7. User Defined and Reserved Symbols (Section 4.16)
*   **Current State**:
    *   Tokens like `~`, `u`, `v`, `H`, `L`, `M`, `O`, `P`, `S`, `T` are currently matched by the catch-all `MUSIC_TEXT` rule in `MUSIC_MODE`.
    *   `NOTE_PITCH` only covers `[A-Ga-g]`.
*   **Gap**:
    *   These characters have semantic meaning (e.g., `~` for roll, `u`/`v` for bows, capitals for user-defined decorations).
    *   Parsing them as generic text loses their identity as potential decorations or symbols.
    *   **Proposed**: Add specific tokens for `~`, `u`, `v`, and a `USER_DEFINED_SYMBOL` range (`[H-W]`, `[h-w]`).

### 8. Symbol Lines (`s:`) (Section 4.15)
*   **Current State**:
    *   Parsed as a standard field (`FIELD_ID`). Usage in the body is `field_in_body`.
    *   Content is consumed as a monolithic `FIELD_CONTENT` string.
*   **Gap**:
    *   `s:` lines function like lyrics (`w:`), requiring alignment with notes.
    *   They consist of distinct items (`"..."` chords, `!...!` decorations, `*` skips).
    *   **Proposed**: `s:` should trigger a mode similar to `LYRICS_MODE` (e.g., `SYMBOL_LINE_MODE`) to tokenize its content structure.

### 9. Voice Field Structure (`V:`) (Section 7.1)
*   **Current State**:
    *   Parsed as `FIELD_ID` + `FIELD_CONTENT`.
*   **Gap**:
    *   `V:` fields contain structured key-value pairs (e.g., `V:1 name="Violin" clef=treble`).
    *   Current grammar leaves parsing of these properties to post-processing.
    *   **Proposed**: While acceptable for a broad parser, a finer-grained grammar could parse `KEY=VALUE` pairs within voice definitions.

### 10. Macros (`m:`) (Section 9)
*   **Current State**: Parsed as generic field.
*   **Note**: The spec implies macros are expanded *before* parsing music. However, the presence of macro definitions (`m:`) needs to be captured. Currently handled by generic field parsing, which is likely sufficient, but the parser must be robust enough to handle unexpanded macro calls (e.g., `~G3`) if pre-processing is skipped. This reinforces needs in #7 (handling `~` and `[H-W]` tokens).
This instruction tells the parser how to interpret bytes. While ANTLR4 operates on Unicode streams, the grammar must define TEXT tokens broadly enough to accept accented characters in titles (T:Frre Jacques) and lyrics, while restricting musical symbols to the standard ASCII set (A-G, a-g, z, x).  
* **MIME Types:** The standard defines the MIME type as text/vnd.abc. While irrelevant to the grammar itself, this confirms the text-based nature of the input, validating the use of a character-stream based lexer.9

### **2.3 The Bipartite Syntax Problem**

The central challenge in parsing ABC is that it is essentially two languages in one container:

1. **Metadata Language:** Line-oriented, key-value pairs (Field: Value).  
2. **Music Notation Language:** Character-oriented, sequence of symbols (AB c/d/).

A naive grammar that attempts to define a single set of tokens for the entire file will encounter immediate collisions. For example, the character C is valid in both modes but has entirely different meanings:

* In a **Header**, C: denotes the "Composer" field.  
* In **Music**, C denotes the pitch "Middle C".  
* In a **Meter Field**, C denotes "Common Time" (4/4).

To resolve this, the ANTLR4 architecture must utilize **Lexical Modes**. The grammar will start in a DEFAULT\_MODE (expecting headers) and transition to a MUSIC\_MODE upon encountering the specific trigger field K: (Key), which strictly terminates the header.1

## **3\. Lexical Analysis: The Tokenization Strategy**

The Lexer is the gatekeeper of the parser. For ABC 2.1, it must be context-aware, handling the state transitions between metadata and music, and managing the unique whitespace rules that govern beaming.

### **3.1 Mode Transition Logic**

The transition logic is dictated by the standard's definition of a tune. "The tune header should start with an X: field... and finish with a K: field. The tune body... follows immediately after".1

#### **3.1.1 The Header State (Default Mode)**

The default mode scans for Information Fields. These are defined as a line starting with an uppercase letter, followed optionally by specific modifiers, and then a colon.

* **Strictness:** In strict mode, only valid field identifiers (X, T, C, M, L, etc.) should be recognized as fields. Lines starting with other characters in the file header or between tunes are treated as "Free Text" or "Typeset Text".1  
* **The Trigger:** The recognition of the K: field is the critical event. The Lexer rule for K: must include a command \-\> pushMode(MUSIC\_MODE).

#### **3.1.2 The Music State (Music Mode)**

Once in MUSIC\_MODE, the Lexer interprets characters as musical primitives (notes, bars, decorations).

* **Exit Strategy:** The music body is terminated by an empty line. The Lexer must define a rule for DOUBLE\_NEWLINE or EMPTY\_LINE that executes \-\> popMode.  
* **Inline Fields:** ABC 2.1 allows information fields to appear *inside* the music body if enclosed in brackets, e.g., \[M:6/8\]. This introduces a recursive need: the Lexer must recognize \[ followed by Letter \+ : as a temporary shift back to a header-like parsing logic, or define specific tokens for inline fields within the music mode.10

### **3.2 Whitespace and Beaming**

One of the most subtle aspects of ABC is the semantic significance of whitespace in the music body.

* **Beaming Rule:** A B C represents three distinct quarter notes (assuming L:1/4). ABC represents three notes beamed together.  
* **Implication:** Most ANTLR grammars skip whitespace. For ABC, this is incorrect in MUSIC\_MODE. The Lexer must emit WS (whitespace) tokens. The Parser then uses these tokens to distinguish between a beam\_group (notes with no intervening WS) and a phrase (groups separated by WS).8

### **3.3 Lexical Ambiguities and Resolution**

#### **3.3.1 The "Symbol" vs. "Field" Ambiguity**

Consider the input A:.

* In the Header, this is the (deprecated) Area field.  
* In the Body, A is a note, and : denotes a repeat bar line.  
* **Resolution:** Mode segregation handles this. In DEFAULT\_MODE, A: is tokenized as FIELD\_ID. In MUSIC\_MODE, A is NOTE and : is BAR\_COLON.

#### **3.3.2 The Quote Ambiguity**

* "Am" represents a Chord Symbol.  
* "Guitar" represents an Annotation (placed above the staff).  
* "Unknown" might be a text string in a header T:Unknown.  
* **Resolution:** In MUSIC\_MODE, quoted strings are generic STRING tokens. The Parser discriminates their function based on position (e.g., preceding a note vs. standalone) or content, although the standard defines specific placement characters (^, \_, \<) for annotations to distinguish them from chords.12

## **4\. Header Syntax: Metadata and Directives**

The Tune Header is an unordered collection of fields, bounded by mandatory start and end fields. While simple in appearance, the internal syntax of specific fields like V: (Voice) and Q: (Tempo) is highly structured.

### **4.1 Field Categorization**

The grammar should categorize fields to facilitate semantic validation.

| Field Type | Identifiers | Grammar Rule Characteristics |
| :---- | :---- | :---- |
| **Reference** | X: | Must be the first field. Value is Integer. |
| **Title** | T: | At least one required. String value. |
| **Musical** | M:, L:, K:, Q: | Structured syntax (fractions, keys, definitions). |
| **Metadata** | C:, R:, Z:, O: | Unstructured String values. |
| **Instruction** | I:, %% | Directives affecting playback/display. |
| **Macro** | m:, U: | definitions for substitution. |
| **Voice** | V: | Complex parameter list. |

### **4.2 The Key (K:) Field and Clefs**

The K: field is deceptive. While it primarily sets the key (e.g., K:G), in ABC 2.1 it serves as a container for global musical state, accepting clef and transposition modifiers.

* **Syntax:** K: \<tonic\> \<mode\> \[modifications\].  
* **Modifications:** The grammar must parse a sequence of unordered parameters: clef=..., octave=..., transpose=....  
* **Explicit Accidentals:** The exp keyword allows explicitly defining the key signature (e.g., K:D exp ^f \_b), requiring a specific sub-rule in the grammar to parse accidentals independent of a standard mode.13

### **4.3 The Voice (V:) Field Structure**

The V: field is the linchpin of polyphonic ABC. It defines properties for a specific voice and can appear in the header or inline.

* **Parameters:** The standard lists extensive parameters including clef, name, subname, stem, gstem, middle, scale, stafflines.12  
* **Grammar Logic:**  
  Code snippet  
  voice\_field : 'V:' voice\_identifier voice\_parameter\* NEWLINE ;  
  voice\_parameter  
      : 'clef=' clef\_def

| 'name=' string

| 'subname=' string

| 'stem=' ('up'|'down'|'auto')

| 'middle=' note\_pitch

//... additional parameters

;

\`\`\`

This granular parsing is superior to capturing the whole line as a string, as it allows the AST to validate values immediately (e.g., ensuring stem is only up/down/auto).

### **4.4 Macros and User-Defined Symbols**

ABC 2.1 supports two types of macros:

1. **Symbol Substitution (U:):** U: T \=\!trill\!. Maps a single character (H-W, h-w, \~) to a decoration.  
2. **Melodic Macros (m:):** m: \~G3 \= G{A}G{F}G. Defines complex expansion rules.

**Architectural Decision:** The ANTLR grammar should parse the *definition* of these macros but should **not** attempt to expand them. Macro expansion is a pre-lexical or stream-rewriting operation. If the parser attempts to expand \~G3 into notes during the parse, it violates the separation of concerns and complicates the grammar infinitely. The parser's job is to recognize m: fields as definitions and store them in the symbol table.15

## **5\. Music Body Syntax: The Core Grammar**

The tune\_body is a sequence of music lines. A music line is a sequence of measures, and a measure is a sequence of "elements" (notes, chords, rests, bars).

### **5.1 The Note Construct**

The representation of a note is the most heavily used rule in the grammar. The standard enforces a strict ordering of elements attached to a note.13

**Strict Ordering Rule:**

1. **Grace Notes:** {...} (enclosed in curly braces).  
2. **Chord Symbols:** "..." (enclosed in double quotes).  
3. **Decorations:** \!...\! or legacy symbols (., u, v).  
4. **Accidentals:** ^, \_, \=, etc.  
5. **Pitch:** The base letter (A-G, a-g).  
6. **Octave:** , or ' modifiers.  
7. **Length:** Number or fraction.

**ANTLR Implementation:**

Code snippet

note\_element  
    : grace\_phrase?         // (1)  
      chord\_symbol\*         // (2)  
      decoration\*           // (3)  
      accidental?           // (4)  
      NOTE\_LETTER           // (5)  
      octave\_modifier?      // (6)  
      note\_length?          // (7)  
      tie?                  // (Post-note tie)  
    ;

Deviating from this order (e.g., placing an accidental before a decoration) is technically invalid in strict mode, though common in loose interpretation. The grammar can enforce strictness by adhering to this sequence, forcing parsing errors on malformed notes.

### **5.2 Rhythms and Fractions**

Rhythm in ABC is relative. A note C2 means "C with duration 2 \* Unit Note Length".

* **Fractions:** 3/2, /2, /, //.  
  * *Parser Rule:* note\_length : digit+ ('/' digit\*)? | '/' digit\* ;  
  * This covers all permutations: explicit numerator/denominator, default numerator (1), and default denominator (2).16  
* **Broken Rhythm:** The operators \> (dotted) and \< (reverse dotted) interact between two notes.  
  * *Structure:* This is a binary operation. element BROKEN\_RHYTHM element.  
  * *Nesting:* \>\> and \>\>\> are distinct tokens representing greater dotting. The Lexer should tokenize \>\>\> as a single BROKEN\_RHYTHM\_3 token to avoid parser ambiguity.1

### **5.3 Tuplets: The (p:q:r Syntax**

Tuplets are one of the most complex parsing challenges due to the varied syntax (p:q:r.

* **The Problem:** The ( character also starts slurs.  
* **Lookahead Strategy:** The Lexer must distinguish ( followed by a digit (Tuplet) from ( followed by a non-digit (Slur).  
  * TUPLET\_START : '(' \[0-9\] ;  
* **Syntax Variations:**  
  * (3 : Simple triplet (p=3, q=default, r=p).  
  * (3:: : Triplet with defaults explicit.  
  * (3:2:3 : Full specification.  
* **Grammar Rule:**  
  Code snippet  
  tuplet\_element  
      : tuplet\_specifier music\_content  
      ;  
  tuplet\_specifier  
      : TUPLET\_START (':' digit\* (':' digit\*)?)?  
      ;

  *Semantic Note:* The grammar can parse the specifier, but it cannot structurally enforce that exactly r notes follow. The music\_content rule will match a sequence of notes. It is the responsibility of the AST walker to count r notes and group them logically into the tuplet.10

### **5.4 Chords and Clusters**

Chords are note clusters enclosed in \[ and \].

* **Internal Syntax:** Inside \`\`, notes are stacked. They can have individual decorations, accidentals, and lengths.  
* **Chord Length:** The chord itself can have a length: \[CEG\]2.  
* **Ambiguity:** As mentioned, \[M:6/8\] is an inline field.  
  * *Predicate Logic:* The parser can use a semantic predicate or a specific Lexer rule to check the content immediately following \[. If it matches \[A-Z\]:, it routes to inline\_field; otherwise, it routes to chord.  
  * *Alternative:* Define INLINE\_FIELD as a specific high-priority token in the Lexer.

### **5.5 Lyrics Alignment**

Lyrics are introduced by w: lines following a music line.

* **Alignment Logic:** Lyrics parsing is strictly token-based. The parser must isolate tokens separated by whitespace, hyphens, or underscores.  
* **Special Tokens:**  
  * \*: Skips a note.  
  * \-: Separates syllables (hyphenation).  
  * \_: Extends a syllable (melisma).  
  * |: Advances to the next bar.18  
* **Lexing Lyrics:** When the Lexer encounters w:, it should ideally switch to a LYRICS\_MODE where tokens like | and \* have specific lyric meanings, distinct from their musical meanings. This prevents | in lyrics from being misinterpreted as a barline that ends a measure.

## **6\. Advanced Contextual Features**

### **6.1 Inline Fields and Context Switching**

ABC 2.1 allows changing the Key, Meter, or Unit Length mid-stream.

* **Impact:** \[L:1/16\] changes the semantic value of all subsequent note lengths.  
* **Grammar Integration:** Inline fields are treated as "elements" within a measure.  
  element : note | chord | inline\_field |... ;  
  This allows them to appear anywhere a note could appear.

### **6.2 Voice Overlay (&)**

The & operator allows two musical phrases to occupy the same timeline within a measure.

* Example: A B C & c d e (Three notes overlaying three notes).  
* **Implementation:** The & acts as a measure-internal separator.  
  Code snippet  
  measure\_body : voice\_phrase ('&' voice\_phrase)\* ;

  This structure allows the AST to identify parallel tracks within a single measure, which is crucial for correct rendering and playback.19

### **6.3 Stylesheet Directives (%%)**

Stylesheet directives allow fine-grained control over printing (e.g., %%pagewidth). These are treated similarly to Information Fields but are identifiable by the double percent prefix.

* *Parsing:* They are generally line-oriented instructions. The grammar must parse them to preserve them in the AST, even if the parser itself doesn't "execute" the typesetting instruction.20

## **7\. ANTLR4 Implementation Strategy**

The following section translates the architectural and syntactic analysis into a concrete strategy for the .g4 grammar file.

### **7.1 Lexer Grammar Structure**

The Lexer should be split into modes to handle the header/body separation cleanly.

Code snippet

lexer grammar ABCLexer;

// Default Mode (Headers)  
X\_REF : 'X:' \-\> pushMode(HEADER\_MODE);  
PERCENT : '%' \-\> channel(HIDDEN); // Comments

mode HEADER\_MODE;  
  K\_KEY : 'K:' \-\> pushMode(MUSIC\_MODE); // The critical transition  
  FIELD\_ID : \[A-Z\] ':';  
  FIELD\_CONTENT : \~\[\\r\\n\]+ ;  
  NEWLINE : \[\\r\\n\]+ ;

mode MUSIC\_MODE;  
  // Inline Fields: Transient shift or self-contained token  
  INLINE\_FIELD : '\[' \[A-Z\] ':'.\*? '\]' ;  
    
  // Musical Tokens  
  NOTE\_PITCH : \[A-Ga-g\] ;  
  NUMBER : \[0-9\]+ ;  
  SLASH : '/' ;  
    
  // Structure  
  BARLINE : '|' | '||' | '\[|' | '|\]' | ':|' | '|:' | '::' ;  
    
  // Special  
  TUPLET\_START : '(' \[0-9\] ;  
  SLUR\_START : '(' ;  
    
  // Whitespace is significant for beaming  
  WS : \[ \\t\]+ ;  
    
  // Exit Strategy  
  EMPTY\_LINE : \[\\r\\n\]\[\\r\\n\] \-\> popMode ;

### **7.2 Parser Grammar Structure**

The Parser consumes the tokens to build the structural hierarchy.

Code snippet

parser grammar ABCParser;  
options { tokenVocab=ABCLexer; }

tunebook : file\_header? tune+ EOF ;

tune : tune\_header tune\_body ;

tune\_header : x\_ref (field | stylesheet\_directive)\* key\_field ;

tune\_body : music\_line+ ;

music\_line : measure+ EOL ;

measure : element\* barline ;

element   
    : note 

| chord   
| tuplet   
| inline\_field   
| broken\_rhythm   
    ;

### **7.3 Semantic Analysis and Validations**

Since ANTLR provides a structural parse, a subsequent **Visitor** pass is required to validate semantics that the grammar cannot enforce context-free.

1. **Key Signature Propagation:** The visitor must track the last seen K: field to assign precise pitches to notes (e.g., converting an F note to F\# if the key is D).  
2. **Rhythm Calculation:** The visitor must calculate the duration of every note based on the global L: and M: fields.  
3. **Macro Expansion:** Before the main analysis, a pass should collect all m: definitions. The post-parse traversal can then logically replace nodes matching the macro pattern, or the input stream can be pre-processed.  
4. **Tuplet Validation:** The visitor checks that the number of notes following a tuplet specifier matches the r value defined (or implied) by the specifier.

## **8\. Comparison with Other Formats**

To justify the complexity of this implementation, it is useful to compare ABC 2.1 with other standards.

| Feature | ABC 2.1 | MusicXML | LilyPond | Implications for Parsing |
| :---- | :---- | :---- | :---- | :---- |
| **Structure** | Character stream (ASCII) | Hierarchical XML DOM | TeX-like commands | ABC requires specific Lexer modes; XML relies on standard DOM parsers. |
| **Polyphony** | Voice ID (V:) and Overlay (&) | \<part\> and \<voice\> tags | \<\<... \>\> parallel blocks | ABC's voice interleaving requires the AST to de-interleave lines for processing. |
| **Lyrics** | Aligned text lines (w:) | Embedded \<lyric\> tags per note | \\addlyrics blocks | ABC lyrics require synchronization logic post-parse; MusicXML is pre-synchronized. |
| **Macros** | Built-in (m:) | Not supported native | Scheme functions | ABC parser needs macro-expansion logic; others do not. |

## **9\. Conclusion**

The construction of an ANTLR4 grammar for ABC 2.1 is a non-trivial undertaking that demands a deep understanding of the standard's history, its dual interpretation modes, and its context-sensitive syntax. By adopting a **Modal Lexing** strategy, the parser can cleanly separate the rigid structure of metadata headers from the fluid, character-based syntax of the music body. Furthermore, by defining granular rules for complex fields like V: and K:, the parser enables robust validation and semantic analysis.

This research establishes that a purely context-free grammar is insufficient for ABC 2.1. The solution requires a hybrid approach: a rigorous ANTLR4 syntactic layer to build a typed Parse Tree, coupled with a rich Semantic Analysis layer to handle the dynamic state changes (keys, meters, macros) that characterize the format. This architecture ensures strict compliance with the 2.1 standard while maintaining the flexibility to handle the legacy files that permeate the digital folk music landscape.

### **9.1 Recommended Next Steps for Implementation**

1. **Prototype the Lexer:** Focus immediately on the Mode transition logic (K: \-\> MUSIC\_MODE).  
2. **Unit Test with "Strict" Files:** Use the corpus of standard ABC 2.1 examples to validate the grammar's strictness.  
3. **Implement the AST Visitor:** Build the state machine that tracks Key and Meter changes to verify that the parser output is musically valid.

This specification provides the necessary theoretical and structural foundation to build a definitive, open-source parsing engine for the ABC 2.1 ecosystem.

#### **Works cited**

1. abc:standard:v2.1 \[abc wiki\] \- ABC Notation, accessed February 8, 2026, [https://abcnotation.com/wiki/abc:standard:v2.1](https://abcnotation.com/wiki/abc:standard:v2.1)  
2. ABC notation \- Wikipedia, accessed February 8, 2026, [https://en.wikipedia.org/wiki/ABC\_notation](https://en.wikipedia.org/wiki/ABC_notation)  
3. What are the limitations of the ABC notation format? \- Music, accessed February 8, 2026, [https://music.stackexchange.com/questions/23841/what-are-the-limitations-of-the-abc-notation-format](https://music.stackexchange.com/questions/23841/what-are-the-limitations-of-the-abc-notation-format)  
4. CodeLogicIncEngineering/grammars-v4-public-fork \- GitHub, accessed February 8, 2026, [https://github.com/CodeLogicIncEngineering/grammars-v4-public-fork](https://github.com/CodeLogicIncEngineering/grammars-v4-public-fork)  
5. antlr/grammars-v4 \- GitHub, accessed February 8, 2026, [https://github.com/antlr/grammars-v4](https://github.com/antlr/grammars-v4)  
6. ABC notation \- Wikiwand, accessed February 8, 2026, [https://www.wikiwand.com/en/articles/abc\_notation](https://www.wikiwand.com/en/articles/abc_notation)  
7. abc:standard:v2.0 \[abc wiki\] \- ABC Notation, accessed February 8, 2026, [https://abcnotation.com/wiki/abc:standard:v2.0](https://abcnotation.com/wiki/abc:standard:v2.0)  
8. ABC (musical notation) \- Just Solve the File Format Problem, accessed February 8, 2026, [http://justsolve.archiveteam.org/wiki/ABC\_(musical\_notation)](http://justsolve.archiveteam.org/wiki/ABC_\(musical_notation\))  
9. abc:standard:v2.2 \[abc wiki\] \- ABC Notation, accessed February 8, 2026, [https://abcnotation.com/wiki/abc:standard:v2.2](https://abcnotation.com/wiki/abc:standard:v2.2)  
10. ABC Music Notation \- MIT, accessed February 8, 2026, [https://trillian.mit.edu/\~jc/music/abc/doc/ABC.html](https://trillian.mit.edu/~jc/music/abc/doc/ABC.html)  
11. Beaming in Groups \- My Music Theory, accessed February 8, 2026, [https://mymusictheory.com/rhythm/beaming-in-groups/](https://mymusictheory.com/rhythm/beaming-in-groups/)  
12. ABC Quick Reference Card \- Michael Eskin, accessed February 8, 2026, [https://michaeleskin.com/documents/ABCquickRefv0\_6.pdf](https://michaeleskin.com/documents/ABCquickRefv0_6.pdf)  
13. abc:standard:v2.1 \[abc wiki\] \- ABC Notation, accessed February 8, 2026, [https://abcnotation.com/wiki/abc:standard:v2.1\#voices\_and\_staves](https://abcnotation.com/wiki/abc:standard:v2.1#voices_and_staves)  
14. abc:standard:v2.1:proposals:clefs\_voice\_parameters:v8, accessed February 8, 2026, [http://abcnotation.com/wiki/abc:standard:v2.1:proposals:clefs\_voice\_parameters:v8](http://abcnotation.com/wiki/abc:standard:v2.1:proposals:clefs_voice_parameters:v8)  
15. abc:standard:v2.1 \[abc wiki\] \- ABC notation, accessed February 8, 2026, [https://abcnotation.com/wiki/abc:standard:v2.1\#macros](https://abcnotation.com/wiki/abc:standard:v2.1#macros)  
16. ABC notation, the basics, accessed February 8, 2026, [https://notabc.app/abc/basics/](https://notabc.app/abc/basics/)  
17. abc:standard:v2.1 \[abc wiki\] \- ABC Notation, accessed February 8, 2026, [https://abcnotation.com/wiki/abc:standard:v2.1\#tuplets](https://abcnotation.com/wiki/abc:standard:v2.1#tuplets)  
18. abc:standard:v2.1 \[abc wiki\] \- ABC Notation, accessed February 8, 2026, [https://abcnotation.com/wiki/abc:standard:v2.1\#lyrics](https://abcnotation.com/wiki/abc:standard:v2.1#lyrics)  
19. The ABC Music Standard 2.1 (Dec 2011\) \- Michael Eskin, accessed February 8, 2026, [https://michaeleskin.com/abctools/abc\_standard\_v2.1.pdf](https://michaeleskin.com/abctools/abc_standard_v2.1.pdf)  
20. abc:standard:v2.1 \[abc wiki\] \- ABC notation, accessed February 8, 2026, [https://abcnotation.com/wiki/abc:standard:v2.1\#information\_fields](https://abcnotation.com/wiki/abc:standard:v2.1#information_fields)
## **10. Implementation Status (Feb 2026)**

Based on this specification, an experimental ANTLR4-based parser module `abc-parser-antlr` has been implemented.

### **10.1 Components**

1.  **Grammar Files**:
    *   `src/main/antlr4/.../ABCLexer.g4`: Implements the Modal Lexing strategy (Header vs Music modes).
    *   `src/main/antlr4/.../ABCParser.g4`: Defines the structural hierarchy (Tunebook -> Tune -> Body).

2.  **Wrapper**:
    *   `AntlrAbcParser.kt`: A Kotlin wrapper providing a simple API to parse strings into ANTLR ParseTrees.

3.  **Testing**:
    *   `TortureTest.kt`: A comprehensive test that scans the `abc-test` module for all `.abc` files and attempts to parse them, reporting success rates and specific failure modes.

### **10.2 Build Instructions**

To build the new module and generate the ANTLR sources:

```bash
mvn clean install -pl abc-parser-antlr
```

To run the torture test:

```bash
mvn test -pl abc-parser-antlr
```
</file>

<file path="tools/abcjs-exporter/export-abc.js">
const fs = require('fs');
const path = require('path');
const { JSDOM } = require("jsdom");

// Shim the DOM for abcjs
const { window } = new JSDOM("");
const { document } = window;
global.window = window;
global.document = document;
global.navigator = window.navigator;

const abcjs = require('abcjs');

function exportAbc(abcString) {
    // parseOnly returns an array of tunes with full semantic data (lines, etc.)
    // but skips the SVG/DOM generation path.
    const tunes = abcjs.parseOnly(abcString);
    const result = tunes.map(tune => {
        // setUpAudio returns absolute MIDI events (pitch, duration, start)
        const midiData = tune.setUpAudio ? tune.setUpAudio() : null;

        return {
            metaText: tune.metaText,
            formatting: tune.formatting,
            lines: tune.lines,
            midiEvents: midiData ? midiData.tracks : null
        };
    });

    if (result.length > 0) {
        console.error('Parsed tunes:', result.length);
    }

    // We want to avoid circular references in the JSON
    const cache = new Set();
    return JSON.stringify(result, (key, value) => {
        // High-level filter to keep the JSON manageable and avoid circularity
        if (key === 'abcregs' || key === 'svg' || key === 'engraver' || key === 'elem') return undefined;

        if (typeof value === 'object' && value !== null) {
            if (cache.has(value)) return;
            cache.add(value);
        }
        return value;
    }, 2);
}

const args = process.argv.slice(2);
if (args.length < 1) {
    console.error('Usage: node export-abc.js <abcfile_or_string>');
    process.exit(1);
}

let abcInput = args[0];
if (fs.existsSync(abcInput)) {
    abcInput = fs.readFileSync(abcInput, 'utf8');
}

try {
    const json = exportAbc(abcInput);
    console.log(json);
} catch (e) {
    console.error('Error parsing ABC:', e);
    process.exit(1);
}
</file>

<file path="tools/abcjs-exporter/export-batch.js">
const fs = require('fs');
const path = require('path');
const { JSDOM } = require("jsdom");

// Shim the DOM for abcjs
const { window } = new JSDOM("");
const { document } = window;
global.window = window;
global.document = document;
global.navigator = window.navigator;

const abcjs = require('abcjs');

function exportAbc(abcString) {
    const tunes = abcjs.parseOnly(abcString);
    const result = tunes.map(tune => {
        // Capture expanded events via TimingCallbacks
        const expandedEvents = [];
        // Note: TimingCallbacks needs a midiContext or just works in 6.x if we shim enough
        // If TimingCallbacks is not available or hard to use in JSDOM, 
        // we can use tune.setUpAudio() then iterate over tracks.
        const midiData = tune.setUpAudio ? tune.setUpAudio() : null;

        // We also want to capture the lines but in a way that allows us to find the notes
        // However, as identified, lines is unexpanded.

        return {
            metaText: tune.metaText,
            formatting: tune.formatting,
            lines: tune.lines,
            midiData: midiData, // Linear MIDI sequence (expanded)
            warnings: tune.warnings
        };
    });

    const cache = new Set();
    return JSON.stringify(result, (key, value) => {
        if (key === 'abcregs' || key === 'svg' || key === 'engraver' || key === 'elem' || key === 'parentStaff') return undefined;
        // Don't skip if it's a note or rest, even if we've seen it, to allow uncompressed linear sequences
        if (value && (value.el_type === 'note' || value.el_type === 'rest')) {
            // Deep clone without circular refs to break sharing
            return {
                el_type: value.el_type,
                duration: value.duration,
                pitches: value.pitches,
                midiPitches: value.midiPitches,
                rest: value.rest,
                currentTrackMilliseconds: value.currentTrackMilliseconds,
                currentTrackWholeNotes: value.currentTrackWholeNotes,
                startChar: value.startChar,
                endChar: value.endChar
            };
        }
        if (typeof value === 'object' && value !== null) {
            if (cache.has(value)) return;
            cache.add(value);
        }
        return value;
    }, 2);
}

const args = process.argv.slice(2);
if (args.length < 1) {
    console.error('Usage: node export-batch.js <batch_dir>');
    process.exit(1);
}

const batchDir = args[0];
const abcFilesDir = path.join(batchDir, 'abc_files');
const outputDir = path.join(batchDir, 'midi_json');

if (!fs.existsSync(abcFilesDir)) {
    console.error('Batch directory must contain abc_files/:', abcFilesDir);
    process.exit(1);
}

if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir);
}

const files = fs.readdirSync(abcFilesDir).filter(f => f.endsWith('.abc'));
console.log(`Processing ${files.length} files...`);

files.forEach((file, index) => {
    const filePath = path.join(abcFilesDir, file);
    const outputFilePath = path.join(outputDir, file.replace('.abc', '.json'));

    // Force re-process for debugging
    // if (fs.existsSync(outputFilePath)) return;

    try {
        const abcInput = fs.readFileSync(filePath, 'utf8');
        const json = exportAbc(abcInput);
        fs.writeFileSync(outputFilePath, json);
        if (index % 100 === 0) console.log(`Processed ${index}/${files.length}...`);
    } catch (e) {
        console.error(`Error processing ${file}:`, e);
    }
});

console.log('Batch processing complete.');
</file>

<file path="tools/abcjs-exporter/generate-baselines.sh">
#!/bin/bash
export PATH=$PATH:/opt/homebrew/bin
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
EXPORTER="$SCRIPT_DIR/export-abc.js"

DIRS=(
    "../../../../src/test/resources/sanity-samples"
    "../../../../src/test/resources/regression-samples"
)

for target_dir in "${DIRS[@]}"; do
    ABS_DIR="$(cd "$SCRIPT_DIR" && cd "$target_dir" && pwd)"
    echo "Processing $ABS_DIR..."
    for f in "$ABS_DIR"/*.abc; do
        if [ -f "$f" ]; then
            echo "  Exporting $(basename "$f")..."
            node "$EXPORTER" "$f" > "${f%.abc}.json"
        fi
    done
done
</file>

<file path="tools/abcjs-exporter/inspect-tune.js">
const fs = require('fs');
const { JSDOM } = require("jsdom");
const { window } = new JSDOM("");
const { document } = window;
global.window = window;
global.document = document;
global.navigator = window.navigator;
const abcjs = require('abcjs');

const abc = fs.readFileSync(process.argv[2], 'utf8');
const div = document.createElement("div");
abcjs.renderAbc(div, abc);
const tunes = abcjs.parseOnly(abc); // We might need the one from renderAbc?
// renderAbc returns an array of tune objects that have the engraver attached.
const renderedTunes = abcjs.renderAbc(div, abc);
const tune = renderedTunes[0];

const midiData = tune.setUpAudio ? tune.setUpAudio() : null;
console.log("MidiData tracking success:", !!midiData);

tune.lines.forEach((line, lIdx) => {
    if (!line.staff) return;
    line.staff.forEach((staff, sIdx) => {
        if (!staff.voices) return;
        staff.voices.forEach((voice, vIdx) => {
            voice.forEach(el => {
                if (el.el_type === 'note' && el.midiPitches) {
                    if (el.midiPitches.length > 1) {
                        console.log(`Note at char ${el.startChar} has ${el.midiPitches.length} midiPitches!`);
                    }
                }
            });
        });
    });
});
if (tune.makeVoicesArray) {
    const voices = tune.makeVoicesArray();
    console.log("Voices array length:", voices.length);
    if (voices.length > 0) {
        console.log("First voice length:", voices[0].length);
        voices[0].forEach((el, i) => {
            if (el.elem) {
                console.log(`Elem ${i} type: ${el.elem.type}, dur: ${el.elem.duration}`);
                if (el.elem.heads && el.elem.heads.length > 0) {
                    const pitch = el.elem.heads[0].pitch;
                    console.log(`  pitch: ${pitch}`);
                }
            }
        });
    }
}

// Look for anything that might be an expanded list
for (const key of Object.keys(tune)) {
    if (Array.isArray(tune[key]) && tune[key].length > 100) {
        console.log(`Potential expanded array: ${key}, length: ${tune[key].length}`);
    }
}
</file>

<file path="tools/abcjs-exporter/package.json">
{
  "name": "abcjs-exporter",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "type": "commonjs",
  "dependencies": {
    "abcjs": "^6.6.1",
    "jsdom": "^28.0.0"
  }
}
</file>

<file path="tools/abcjs-exporter/test_repeat.abc">
X:1
M:4/4
K:C
C D E F |: G A B c |1 d e f g :|2 d2 c2 |]
</file>

<file path="tools/music21-exporter/m21_validator.py">
import music21
import json
import sys
import os
import multiprocessing

def validate_abc(abc_file_path):
    try:
        # Load and parse the ABC file
        tune = music21.converter.parse(abc_file_path)
        
        # Expand repeats if any
        try:
            expanded_tune = tune.expandRepeats()
        except Exception as e:
            expanded_tune = tune

        results = []
        
        # Process parts/voices
        for part in expanded_tune.parts:
            voice_data = []
            for element in part.flatten().notesAndRests:
                is_grace = element.duration.isGrace
                if element.isNote:
                    voice_data.append({
                        "type": "note",
                        "pitch": element.pitch.midi,
                        "duration": float(element.duration.quarterLength),
                        "isGrace": is_grace
                    })
                elif element.isChord:
                    voice_data.append({
                        "type": "chord",
                        "pitches": [p.midi for p in element.pitches],
                        "duration": float(element.duration.quarterLength),
                        "isGrace": is_grace
                    })
                elif element.isRest:
                    voice_data.append({
                        "type": "rest",
                        "duration": float(element.duration.quarterLength)
                    })
            results.append(voice_data)
            
        return results
    except Exception as e:
        return {"error": str(e)}

def worker_task(abc_file_path, output_file):
    # This runs in a worker process
    result = validate_abc(abc_file_path)
    with open(output_file, 'w') as out:
        json.dump(result, out, indent=2)
    return True

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 m21_validator.py <abc_file_or_dir> [output_dir]")
        sys.exit(1)
        
    abc_path = sys.argv[1]
    output_dir = sys.argv[2] if len(sys.argv) > 2 else None

    if os.path.isdir(abc_path):
        if output_dir:
            if not os.path.exists(output_dir):
                os.makedirs(output_dir)
            
            abc_files = sorted([f for f in os.listdir(abc_path) if f.endswith(".abc")])
            print(f"Processing {len(abc_files)} files with fresh processes and 15s timeout...")
            
            # maxtasksperchild=1 ensures a new process for every file, avoiding music21 memory/state bloat
            with multiprocessing.Pool(processes=multiprocessing.cpu_count(), maxtasksperchild=1) as pool:
                results = []
                for f in abc_files:
                    abc_file_path = os.path.join(abc_path, f)
                    output_file = os.path.join(output_dir, f.replace(".abc", ".json"))
                    
                    if os.path.exists(output_file):
                        continue
                        
                    res = pool.apply_async(worker_task, (abc_file_path, output_file))
                    results.append((f, res, output_file))
                
                processed_count = 0
                for f, res, out_file in results:
                    try:
                        # Wait up to 15 seconds for each file
                        res.get(timeout=15)
                        processed_count += 1
                    except multiprocessing.TimeoutError:
                        print(f"TIMEOUT: {f} took too long to process. Marking as error.")
                        with open(out_file, 'w') as out:
                            json.dump({"error": "timeout"}, out)
                    except Exception as e:
                        print(f"ERROR: {f} failed with: {str(e)}")
                        with open(out_file, 'w') as out:
                            json.dump({"error": str(e)}, out)
                    
                    if (processed_count > 0 and processed_count % 10 == 0) or True: # Print every file for now to see progress
                         print(f"Progress: {processed_count + 790}/{len(abc_files)} ({f})")
                         sys.stdout.flush()
            
            print(f"Batch processing complete.")
        else:
            # Legacy batch mode (single object to stdout)
            batch_results = {}
            for f in os.listdir(abc_path):
                if f.endswith(".abc"):
                    batch_results[f] = validate_abc(os.path.join(abc_path, f))
            print(json.dumps(batch_results, indent=2))
    else:
        print(json.dumps(validate_abc(abc_path), indent=2))
</file>

<file path="tools/compare_durations.py">
import json
import re

def parse_frac(s):
    s = s.strip().strip('[]')
    if not s: return None
    if '/' in s:
        n, d = s.split('/')
        return float(n) / float(d)
    return float(s)

with open('debug_output.log', 'r') as f:
    lines = f.readlines()

abcjs_line = [l for l in lines if 'abcjs durations:' in l][0]
ours_line = [l for l in lines if 'ours durations:' in l][0]

# Extract content between [ ]
abcjs_str = re.search(r'\[(.*)\]', abcjs_line).group(1)
ours_str = re.search(r'\[(.*)\]', ours_line).group(1)

abcjs = [float(s) for s in abcjs_str.split(', ')]
ours = [parse_frac(s) for s in ours_str.split(', ')]
ours = [o for o in ours if o is not None]

print(f"abcjs size: {len(abcjs)}")
print(f"ours size: {len(ours)}")

limit = min(len(abcjs), len(ours))
for i in range(limit):
    if abs(abcjs[i] - ours[i]) > 0.0001:
        print(f"Divergence at index {i}: abcjs={abcjs[i]}, ours={ours[i]}")
        # Print a bit of context
        print(f"abcjs sequence: {abcjs[max(0, i-5):i+5]}")
        print(f"ours sequence: {ours[max(0, i-5):i+5]}")
        break
else:
    print(f"No divergence found up to index {limit}")
    if len(abcjs) != len(ours):
        print(f"Sequences have different lengths: abcjs={len(abcjs)}, ours={len(ours)}")
        if len(ours) > len(abcjs):
            print(f"Next ours duration: {ours[len(abcjs)]}")
</file>

<file path="tools/compare_ends.py">
import json
import re

def parse_frac(s):
    s = s.strip().strip('[]')
    if not s: return None
    if '/' in s:
        n, d = s.split('/')
        return float(n) / float(d)
    return float(s)

with open('debug_output.log', 'r') as f:
    lines = f.readlines()

abcjs_line = [l for l in lines if 'abcjs durations:' in l][0]
ours_line = [l for l in lines if 'ours durations:' in l][0]

abcjs_str = re.search(r'\[(.*)\]', abcjs_line).group(1)
ours_str = re.search(r'\[(.*)\]', ours_line).group(1)

abcjs = [float(s) for s in abcjs_str.split(', ')]
ours = [parse_frac(s) for s in ours_str.split(', ')]
ours = [o for o in ours if o is not None]

print(f"abcjs size: {len(abcjs)}")
print(f"ours size: {len(ours)}")

print("Last 20 abcjs durations:")
print(abcjs[-20:])
print("Last 20 ours durations:")
print(ours[-20:])
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/KeyMode.kt">
package io.github.ryangardner.abc.core.model

public enum class KeyMode {
    MAJOR, MINOR, IONIAN, DORIAN, PHRYGIAN, LYDIAN, MIXOLYDIAN, AEOLIAN, LOCRIAN;

    public companion object {
        public fun fromString(mode: String?): KeyMode {
            return when (mode?.lowercase()) {
                "m", "min", "minor", "aeolian" -> AEOLIAN
                "maj", "major", "ionian" -> IONIAN
                "dor", "dorian" -> DORIAN
                "phr", "phrygian" -> PHRYGIAN
                "lyd", "lydian" -> LYDIAN
                "mix", "mixolydian" -> MIXOLYDIAN
                "loc", "locrian" -> LOCRIAN
                else -> IONIAN
            }
        }
    }
}
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/KeyRoot.kt">
package io.github.ryangardner.abc.core.model

/**
 * Represents the pitch class of a key's root (tonic).
 */
public data class KeyRoot @JvmOverloads constructor(
    public val step: NoteStep,
    public val accidental: Accidental = Accidental.NATURAL
)
</file>

<file path="abc-core/pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>io.github.ryangardner</groupId>
        <artifactId>abc-jvm-parent</artifactId>
        <version>0.1.0-SNAPSHOT</version>
    </parent>

    <artifactId>abc-core</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-stdlib</artifactId>
        </dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-test-junit5</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
</project>
</file>

<file path="abc-interop/pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>io.github.ryangardner</groupId>
        <artifactId>abc-jvm-parent</artifactId>
        <version>0.1.0-SNAPSHOT</version>
    </parent>

    <artifactId>abc-interop</artifactId>

    <dependencies>
        <dependency>
            <groupId>io.github.ryangardner</groupId>
            <artifactId>abc-core</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-stdlib</artifactId>
        </dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-test-junit5</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
</project>
</file>

<file path="abc-test/src/test/kotlin/io/github/ryangardner/abc/test/AbcjsSemanticParityTest.kt">
package io.github.ryangardner.abc.test

import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import io.github.ryangardner.abc.core.model.*
import io.github.ryangardner.abc.parser.v2.AntlrAbcParser
import io.github.ryangardner.abc.theory.*
import io.github.ryangardner.abc.theory.PitchInterpreter
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Assumptions.assumeTrue
import org.junit.jupiter.api.Test
import org.junit.jupiter.params.ParameterizedTest
import org.junit.jupiter.params.provider.MethodSource
import org.opentest4j.AssertionFailedError
import java.io.File
import java.nio.file.Files
import java.nio.file.StandardOpenOption
import java.util.stream.Stream
import kotlin.streams.asStream

public class AbcjsSemanticParityTest {

    public data class AbcjsBaseline(val name: String, val abcContent: String, val jsonContent: String, val m21JsonContent: String?, val filePath: String) {
        override fun toString(): String = name
    }

    @ParameterizedTest(name = "abcjs parity: {0}")
    @MethodSource("baselineSources")
    public fun `test semantic parity with abcjs`(baseline: AbcjsBaseline) {
        val parser = AntlrAbcParser()
        val tunes = parser.parseBook(baseline.abcContent)
        
        val gson = Gson()
        val type = object : TypeToken<List<Map<String, Any>>>() {}.type
        val abcjsTunes: List<Map<String, Any>> = gson.fromJson(baseline.jsonContent, type)

        val m21FullResults: List<List<Map<String, Any>>>? = baseline.m21JsonContent?.let { 
            try { 
                if (it.trim().startsWith("{")) {
                    val errMap: Map<String, Any> = gson.fromJson(it, object : TypeToken<Map<String, Any>>() {}.type)
                    if (errMap.containsKey("error")) {
                        // println("DEBUG: [${baseline.name}] music21 reported error: ${errMap["error"]}")
                        return@let null
                    }
                }
                val m21Type = object : TypeToken<List<List<Map<String, Any>>>>() {}.type
                gson.fromJson<List<List<Map<String, Any>>>>(it, m21Type)
            } catch (e: Exception) { 
                // println("DEBUG: [${baseline.name}] Error parsing music21 JSON: ${e.message}")
                null 
            }
        }

        assertEquals(abcjsTunes.size, tunes.size, "Tune count mismatch")

        tunes.forEachIndexed { tuneIndex, tune ->
            val abcjsTune = abcjsTunes[tuneIndex]
            val interpreted = PitchInterpreter.interpret(tune)
            val unexpanded = PitchInterpreter.interpretUnexpanded(tune)

            @Suppress("UNCHECKED_CAST")
            val abcjsWarnings = abcjsTune["warnings"] as? List<String> ?: emptyList()
            if (abcjsWarnings.isNotEmpty()) {
                logDiscrepancy(baseline.name, abcjsWarnings)
                if (m21FullResults != null) {
                    if (compareWithMusic21(baseline.name, interpreted, m21FullResults)) {
                        return@forEachIndexed 
                    }
                }
                logTroublesome(baseline.name, "abcjs warnings: ${abcjsWarnings.firstOrNull()}")
                assumeTrue(false, "Skipping [${baseline.name}] due to abcjs warnings and no music21 match")
            }

            // TRY COMPARING WITH ABCJS
            val abcjsError = try {
                compareWithAbcjs(baseline.name, interpreted, unexpanded, abcjsTune)
                null
            } catch (e: AssertionFailedError) {
                if (System.getProperty("abc.test.debug") == "true") {
                    println("DEBUG: [${baseline.name}] abcjs mismatch: ${e.message}")
                }
                e
            }

            if (abcjsError == null) return@forEachIndexed // Success with abcjs

            // ABCJS MISMATCHED - TRY PRE-LOADED MUSIC21 AS SECOND OPINION
            if (m21FullResults != null) {
                // Try comparing music21 against BOTH expanded and unexpanded
                val m21MatchExpanded = compareWithMusic21(baseline.name, interpreted, m21FullResults)
                val m21MatchUnexpanded = compareWithMusic21(baseline.name, unexpanded, m21FullResults)
                
                if (m21MatchExpanded || m21MatchUnexpanded) {
                    // Success with music21! We matched one of the ground truths.
                    return@forEachIndexed 
                } else {
                    // Mismatched BOTH abcjs and music21. 
                    // Only fail if THEY agree with each other.
                    if (compareAbcjsWithMusic21(abcjsTune, m21FullResults)) {
                        // Systemic agreement between abcjs and music21 against us.
                        throw abcjsError
                    } else {
                        // All three disagree or music21/abcjs disagree with each other.
                        logTroublesome(baseline.name, abcjsError.message ?: "Unknown error")
                        assumeTrue(false, "Skipping [${baseline.name}] due to ground truth ambiguity")
                        return@forEachIndexed
                    }
                }
            } else {
                // music21 baseline missing or had an error.
                logTroublesome(baseline.name, "music21 missing/error AND abcjs mismatch: ${abcjsError.message}")
                assumeTrue(false, "Skipping [${baseline.name}] due to unreliable baselines")
            }
        }
    }

    private fun compareWithAbcjs(name: String, interpreted: InterpretedTune, unexpanded: InterpretedTune, abcjsTune: Map<String, Any>) {
        @Suppress("UNCHECKED_CAST")
        val abcjsLines = abcjsTune["lines"] as? List<Map<String, Any>> ?: emptyList()
        val coalescedAbcjsVoices = mutableMapOf<Pair<Int, Int>, MutableList<Map<String, Any>>>()
        
        abcjsLines.forEach { line ->
            @Suppress("UNCHECKED_CAST")
            val staffs = line["staff"] as? List<Map<String, Any>>
            staffs?.forEachIndexed { sIdx, staff ->
                @Suppress("UNCHECKED_CAST")
                val voices = staff["voices"] as? List<List<Map<String, Any>>>
                voices?.forEachIndexed { vIdx, voiceSegment ->
                    coalescedAbcjsVoices.getOrPut(sIdx to vIdx) { mutableListOf() }.addAll(voiceSegment)
                }
            }
        }
        val allAbcjsVoices = coalescedAbcjsVoices.entries
            .sortedWith(compareBy({ it.key.first }, { it.key.second }))
            .map { it.value }

        val sortedInterpretedVoices = interpreted.voices.entries.sortedBy { entry -> entry.key }
        val sortedUnexpandedVoices = unexpanded.voices.entries.sortedBy { entry -> entry.key }

        sortedInterpretedVoices.forEachIndexed { voiceIndex, (voiceId, expandedNotes) ->
            val abcjsEventsUnfiltered = if (allAbcjsVoices.size > voiceIndex) allAbcjsVoices[voiceIndex] else emptyList()
            
            @Suppress("UNCHECKED_CAST")
            val midiData = abcjsTune["midiData"] as? Map<String, Any>
            @Suppress("UNCHECKED_CAST")
            val midiTracks = (midiData?.get("tracks") as? List<List<Map<String, Any>?>>)
                ?: (abcjsTune["midiEvents"] as? List<List<Map<String, Any>?>>)
            
            if (System.getProperty("abc.test.debug") == "true") {
                println("DEBUG: [$name] midiData?=${midiData != null}, midiEvents?=${abcjsTune.containsKey("midiEvents")}, midiTracks size=${midiTracks?.size}")
            }
            
            if (System.getProperty("abc.test.debug") == "true") {
                midiTracks?.forEachIndexed { i, track ->
                    val noteCount = track?.count { it?.get("cmd") == "note" } ?: 0
                    println("DEBUG: [$name] Track $i noteCount=$noteCount")
                }
            }
            
            // Try to find the first track with notes if voiceIndex 0 has nothing
            var midiTrack = if (midiTracks != null && midiTracks.size > voiceIndex) midiTracks[voiceIndex] else null
            val hasMidiNotesAtVoiceIndex = midiTrack?.any { trackEntry -> trackEntry?.get("cmd") == "note" } ?: false
            
            if (!hasMidiNotesAtVoiceIndex && midiTracks != null && voiceIndex == 0) {
               midiTrack = midiTracks.firstOrNull { t -> t?.any { it?.get("cmd") == "note" } ?: false }
            }
            
            val hasMidiNotes = midiTrack?.any { trackEntry -> trackEntry?.get("cmd") == "note" } ?: false

            val candidates = mutableListOf<List<Map<String, Any>>>()

            // Candidate A: From midiTracks
            midiTracks?.forEachIndexed { trackIdx, track ->
                val notes = track?.filter { it?.get("cmd") == "note" && it?.get("pitch") != null }?.filterNotNull() ?: emptyList()
                if (notes.isNotEmpty()) {
                    val grouped = notes.groupBy { Math.round((it["start"] as Number).toDouble() * 480.0) }
                        .toSortedMap()
                        .values
                        .map { chordEvents ->
                            mapOf(
                                "el_type" to "note",
                                "isMidiTrack" to true,
                                "duration" to (chordEvents.first()["duration"] as Number).toDouble(),
                                "midiPitches" to chordEvents.map { trackEntry ->
                                    mapOf("pitch" to (trackEntry["pitch"] as Number).toInt(), "duration" to (trackEntry["duration"] as Number).toDouble())
                                }
                            )
                        }
                    candidates.add(grouped)
                }
            }

            // Candidate B: From notation lines
            val flatAbcjsNotation = mutableListOf<Map<String, Any>>()
            abcjsEventsUnfiltered.forEach { event ->
                if (event == null) return@forEach
                val elType = event["el_type"] as? String
                @Suppress("UNCHECKED_CAST")
                val isSpacer = (event["rest"] as? Map<String, Any>)?.get("type") == "spacer"
                if ((elType == "note" || elType == "rest") && !isSpacer) {
                    @Suppress("UNCHECKED_CAST")
                    val graceNotes = event["gracenotes"] as? List<Map<String, Any>>
                    graceNotes?.forEach { gn ->
                        flatAbcjsNotation.add(gn.toMutableMap().apply { 
                            put("el_type", "note")
                            put("isGrace", true) 
                            if (!containsKey("duration")) put("duration", 0.0)
                        })
                    }
                    flatAbcjsNotation.add(event)
                }
            }
            if (flatAbcjsNotation.isNotEmpty()) candidates.add(flatAbcjsNotation)

            // Determine expected counts
            val unexpandedNotesForVoice = if (sortedUnexpandedVoices.size > voiceIndex) sortedUnexpandedVoices[voiceIndex].value else emptyList()

            // Heuristic for picking candidates: Try matching against Expanded/Unexpanded and with/without Grace notes.
            data class MatchAttempt(
                val abcjsEvents: List<Map<String, Any>>,
                val ourNotes: List<InterpretedNote>,
                val usingUnexpanded: Boolean,
                val isGraceFiltered: Boolean,
                val score: Int
            )

            val attempts = mutableListOf<MatchAttempt>()
            candidates.forEach { candidate ->
                listOf(true, false).forEach { useUnexpanded ->
                    listOf(true, false).forEach { filterGrace ->
                        val baseNotes = if (useUnexpanded) unexpandedNotesForVoice else expandedNotes
                        val ourNotes = if (filterGrace) baseNotes.filter { !it.isGrace } else baseNotes
                        
                        val score = if (candidate.size == ourNotes.size) 1000 else -Math.abs(candidate.size - ourNotes.size)
                        attempts.add(MatchAttempt(candidate, ourNotes, useUnexpanded, filterGrace, score))
                    }
                }
            }

            val bestMatch = attempts.maxByOrNull { it.score } ?: MatchAttempt(emptyList(), emptyList(), false, false, -1000)
            
            val abcjsEvents = bestMatch.abcjsEvents
            val usingUnexpanded = bestMatch.usingUnexpanded
            val isGraceFiltered = bestMatch.isGraceFiltered
            var currentNotes = bestMatch.ourNotes
            val isMidiBaseline = abcjsEvents.isNotEmpty() && abcjsEvents.first().containsKey("isMidiTrack")

            var finalNotes = currentNotes
            if (isMidiBaseline) {
                finalNotes = finalNotes.filter { !it.isRest }
            }

            val compareSize = Math.min(abcjsEvents.size, finalNotes.size)
            for (noteIndex in 0 until compareSize) {
                val interpretedNote = finalNotes[noteIndex]
                val abcjsEvent = abcjsEvents[noteIndex]
                val context = if (noteIndex > 0) {
                    val prevNote = currentNotes[noteIndex-1]
                    " (Prev: ${prevNote.duration}/${prevNote.playedDuration})"
                } else ""

                val abcjsDuration = (abcjsEvent["duration"] as Number).toDouble()
                val ourComparisonDuration = if (isMidiBaseline) interpretedNote.playedDuration.toDouble() else interpretedNote.duration.toDouble()
                
                if (Math.abs(abcjsDuration - ourComparisonDuration) > 0.001) {
                    // Match notation fallback
                    val matchNotation = Math.abs(abcjsDuration - interpretedNote.duration.toDouble()) < 0.001
                    if (!matchNotation) {
                        assertEquals(abcjsDuration, ourComparisonDuration, 0.001, 
                            "[$name] Duration mismatch at event $noteIndex in voice $voiceId$context (${if(usingUnexpanded) "unexpanded" else "expanded"}). abcjsDur: $abcjsDuration, ours: $ourComparisonDuration")
                    }
                }
                
                val isAbcjsRest = abcjsEvent["el_type"] == "rest" || abcjsEvent.containsKey("rest")
                
                if (interpretedNote.isRest) {
                    assertEquals(true, isAbcjsRest, "[$name] Expected rest at event $noteIndex in voice $voiceId$context")
                } else {
                    assertEquals(false, isAbcjsRest, "[$name] Expected note (got rest) at event $noteIndex in voice $voiceId$context")
                    
                    @Suppress("UNCHECKED_CAST")
                    val abcjsMidiPitchesRaw = abcjsEvent["midiPitches"] as? List<Map<String, Any>> ?: emptyList()
                    val abcjsMidiPitches = abcjsMidiPitchesRaw.map { (it["pitch"] as Number).toInt() }

                    val interpretedMidi = interpretedNote.midiPitches
                    val abcjsSorted = abcjsMidiPitches.sorted()
                    val interpretedSorted = interpretedMidi.sorted()
                    
                    if (abcjsSorted != interpretedSorted) {
                        val isOctaveShift = abcjsSorted.size == interpretedSorted.size && 
                            abcjsSorted.zip(interpretedSorted).all { (a, b) -> Math.abs(a - b) % 12 == 0 }
                        
                        if (!isOctaveShift) {
                            assertEquals(abcjsSorted, interpretedSorted, "[$name] Pitch mismatch at event $noteIndex in voice $voiceId$context")
                        }
                    }
                }
            }
            assertEquals(abcjsEvents.size, finalNotes.size, "[$name] Event count mismatch in voice $voiceId. (picked size ${abcjsEvents.size}, expected ${finalNotes.size}. usingUnexpanded=$usingUnexpanded, isGraceFiltered=$isGraceFiltered)")
        }
    }

    private fun compareWithMusic21(name: String, interpreted: InterpretedTune, m21Results: List<List<Map<String, Any>>>): Boolean {
        val sortedInterpretedVoices = interpreted.voices.entries.sortedBy { entry -> entry.key }
        if (sortedInterpretedVoices.size != m21Results.size) {
            if (System.getProperty("abc.test.debug") == "true") println("DEBUG: [$name] m21 voice count mismatch: ours=${sortedInterpretedVoices.size}, m21=${m21Results.size}")
            return false
        }
        
        sortedInterpretedVoices.forEachIndexed { voiceIndex, (_, notes) ->
            val m21Events = m21Results[voiceIndex].filter { event ->
                val duration = (event["duration"] as? Number)?.toDouble() ?: 0.0
                val isGrace = event["isGrace"] as? Boolean ?: false
                duration > 0.0 || isGrace
            }
            if (notes.size != m21Events.size) {
                if (System.getProperty("abc.test.debug") == "true") println("DEBUG: [$name] m21 event count mismatch in voice $voiceIndex: ours=${notes.size}, m21=${m21Events.size}")
                return false
            }
            
            notes.forEachIndexed { noteIndex, interpretedNote ->
                val m21Event = m21Events[noteIndex]
                val m21Type = m21Event["type"] as? String ?: return false
                
                if (interpretedNote.isRest) {
                    if (m21Type != "rest") {
                        if (System.getProperty("abc.test.debug") == "true") println("DEBUG: [$name] m21 mismatch at event $noteIndex: expected rest, got $m21Type")
                        return false
                    }
                } else {
                    if (m21Type != "note" && m21Type != "chord") {
                        if (System.getProperty("abc.test.debug") == "true") println("DEBUG: [$name] m21 mismatch at event $noteIndex: expected note/chord, got $m21Type")
                        return false
                    }
                    
                    val m21Pitches = if (m21Type == "note") {
                        listOf((m21Event["pitch"] as Number).toInt())
                    } else {
                        @Suppress("UNCHECKED_CAST")
                        (m21Event["pitches"] as List<Number>).map { it.toInt() }
                    }
                    
                    val ourPitches = interpretedNote.midiPitches
                    if (ourPitches != m21Pitches && !interpretedNote.isTieContinued) {
                        val isOctaveShift = m21Pitches.size == ourPitches.size &&
                            m21Pitches.sorted().zip(ourPitches.sorted()).all { (a, b) -> Math.abs(a - b) % 12 == 0 }
                        if (!isOctaveShift) {
                            if (System.getProperty("abc.test.debug") == "true") println("DEBUG: [$name] m21 pitch mismatch at event $noteIndex: m21=$m21Pitches, ours=$ourPitches")
                            return false
                        }
                    }
                }
                
                val m21WholeNoteDuration = (m21Event["duration"] as Number).toDouble() * 0.25
                val ourComparisonDuration = interpretedNote.semanticDuration.toDouble()
                if (Math.abs(m21WholeNoteDuration - ourComparisonDuration) > 0.001) {
                    if (System.getProperty("abc.test.debug") == "true") {
                        println("DEBUG: [$name] m21 duration mismatch at event $noteIndex: m21=$m21WholeNoteDuration, ours=$ourComparisonDuration, note=${interpretedNote.pitches}, duration=${interpretedNote.duration}, semanticDuration=${interpretedNote.semanticDuration}, playedDuration=${interpretedNote.playedDuration}")
                    }
                    return false
                }
            }
        }
        return true
    }

    private fun compareAbcjsWithMusic21(abcjsTune: Map<String, Any>, m21Results: List<List<Map<String, Any>>>): Boolean {
        @Suppress("UNCHECKED_CAST")
        val midiData = abcjsTune["midiData"] as? Map<String, Any>
        @Suppress("UNCHECKED_CAST")
        val midiTracks = midiData?.get("tracks") as? List<List<Map<String, Any>?>> ?: return false
        
        if (midiTracks.size != m21Results.size) return false
        
        midiTracks.forEachIndexed { index, track ->
            val abcjsNoteCount = track?.count { it?.get("cmd") == "note" } ?: 0
            val m21NoteCount = m21Results[index].count { it["type"] == "note" || it["type"] == "chord" }
            if (Math.abs(abcjsNoteCount - m21NoteCount) > 2) return false
        }
        return true
    }

    private fun logTroublesome(filename: String, error: String) {
        val rootDir = if (File(System.getProperty("user.dir")).name == "abc-test") {
            File(System.getProperty("user.dir")).parentFile
        } else {
            File(System.getProperty("user.dir"))
        }
        val batchName = filename.split("/").firstOrNull() ?: "unknown"
        val reportFile = File(rootDir, "reports/troublesome_$batchName.md")
        if (!reportFile.exists()) {
            reportFile.writeText("# Troublesome Files: $batchName\nBoth abcjs and music21 disagree with our parser OR they disagree with each other.\n\n| File | Error |\n| --- | --- |\n")
        }
        val entry = "| $filename | $error |\n"
        if (!reportFile.readText().contains(filename)) {
            Files.write(reportFile.toPath(), entry.toByteArray(), StandardOpenOption.APPEND)
        }
    }

    private fun logDiscrepancy(filename: String, warnings: List<String>) {
        val rootDir = if (File(System.getProperty("user.dir")).name == "abc-test") {
            File(System.getProperty("user.dir")).parentFile
        } else {
            File(System.getProperty("user.dir"))
        }
        val batchName = filename.split("/").firstOrNull() ?: "unknown"
        val reportFile = File(rootDir, "reports/abcjs_discrepancies_$batchName.md")
        if (!reportFile.exists()) {
            reportFile.writeText("# Abcjs Warnings Report: $batchName\n\n| File | Warning |\n| --- | --- |\n")
        }
        val entry = "| $filename | ${warnings.joinToString("; ")} |\n"
        if (!reportFile.readText().contains(filename)) {
            Files.write(reportFile.toPath(), entry.toByteArray(), StandardOpenOption.APPEND)
        }
    }

    companion object {
        @JvmStatic
        fun baselineSources(): Stream<AbcjsBaseline> {
            val batchDirProp = System.getProperty("abc.test.batchDir")
            if (batchDirProp != null) {
                return getBaselinesFromDir(File(batchDirProp))
            }
            return Stream.empty()
        }

        private fun getBaselinesFromDir(batchDir: File): Stream<AbcjsBaseline> {
            val resolvedBatchDir = if (!batchDir.exists() && !batchDir.isAbsolute) {
                // Try relative to project root if running from module
                val projectRoot = File(System.getProperty("user.dir")).parentFile
                File(projectRoot, batchDir.path)
            } else batchDir

            val abcFilesDir = File(resolvedBatchDir, "abc_files")
            val midiJsonDir = File(resolvedBatchDir, "midi_json")
            val m21JsonDir = File(resolvedBatchDir, "music21_json")
            
            val actualAbcDir = if (abcFilesDir.exists()) abcFilesDir else resolvedBatchDir
            val actualJsonDir = if (midiJsonDir.exists()) midiJsonDir else resolvedBatchDir

            val filter = System.getProperty("abc.test.filter")
            val files = actualAbcDir.listFiles { f -> f.extension == "abc" }
            if (filter != null) {
                println("DEBUG: getBaselinesFromDir: actualAbcDir=${actualAbcDir.absolutePath}, filter=$filter, total files=${files?.size ?: 0}")
            }

            return (files?.mapNotNull { abcFile ->
                val jsonFile = File(actualJsonDir, abcFile.nameWithoutExtension + ".json")
                val m21JsonFile = File(m21JsonDir, abcFile.nameWithoutExtension + ".json")
                
                val baselineName = "${batchDir.name}/${abcFile.name}"
                val filterList = filter?.split(",") ?: emptyList()
                val matchesFilter = filter == null || filterList.any { baselineName.contains(it) || abcFile.nameWithoutExtension.contains(it) }
                
                if (!matchesFilter) return@mapNotNull null

                if (jsonFile.exists()) {
                    AbcjsBaseline(
                        baselineName, 
                        abcFile.readText(), 
                        jsonFile.readText(), 
                        if (m21JsonFile.exists()) m21JsonFile.readText() else null,
                        abcFile.absolutePath
                    )
                } else {
                    if (matchesFilter) println("DEBUG: Found ABC but NO JSON for ${abcFile.name} in ${actualJsonDir.absolutePath}")
                    null
                }
            }?.asSequence() ?: emptySequence())
                .asStream()
        }
    }
}
</file>

<file path="abc-test/REGRESSION.md">
# ABC Parser Batch Regression Testing

This document describes how to perform large-scale semantic validation of the ABC parser using the ABC notation dataset and baseline tools.

## 1. Prerequisites

- **Node.js** (v18 or higher)
- **Python 3** with `music21` installed: `pip3 install music21`
- **Maven**

## 2. Dataset Setup

The test suite uses a dataset of ~13,000 ABC tunes hosted on Zenodo.

### Download and Extract
Use the `DatasetDownloader` utility to fetch specific batches of 1,000 tunes each.

```bash
# In the abc-test directory
mvn exec:java -Dexec.mainClass="io.github.ryangardner.abc.test.DatasetDownloader" -Dexec.args="1 2 3"
```
This will extract files to `target/abc-dataset/abc_notation_batch_XXX/`.

## 3. Generating Baselines

Baselines are generated using `abcjs` to provide a ground truth for semantic parity.

```bash
cd tools/abcjs-exporter
npm install
node export-batch.js ../../target/abc-dataset/abc_notation_batch_001
```

This produces JSON files in the `midi_json` subdirectory of each batch, containing both the notation structure and the linear MIDI sequence.

## 4. Running Regression Tests

### Semantic Parity with abcjs
Run the `AbcjsSemanticParityTest` to compare the JVM parser output against the `abcjs` MIDI baselines.

```bash
# Run a specific batch
mvn test -Dtest=AbcjsSemanticParityTest \
  -DargLine="-Dtest.batchDir=$(pwd)/target/abc-dataset/abc_notation_batch_001"
```

### Filtering Tests
You can filter to a specific tune for debugging:
```bash
mvn test -Dtest=AbcjsSemanticParityTest \
  -DargLine="-Dtest.batchDir=$(pwd)/target/abc-dataset/abc_notation_batch_001 -Dabc.test.filter=tune_000004"
```

## 5. Cross-Validation

If a tune shows a mismatch between our parser and `abcjs`, use the `m21_validator.py` script to get a "second opinion" from the `music21` library.

```bash
# In the project root
python3 m21_validator.py abc-test/target/abc-dataset/abc_notation_batch_001/abc_files/tune_000004.abc
```

## 6. Interpreting Results

### Success-Failures (Expansion)
Due to structural expansion (Repeats, Variants, Parts), the note count in our parser's output may be significantly higher than the `abcjs` notation ground truth. These are often **successes**.
- **Bit-perfect parity**: Usually achieved for tunes without repeats.
- **Structural agreement**: Verified when our count matches `music21`'s expanded count, even if it differs from `abcjs`.

### Known Divergences
Refer to `semantic_divergence_report.md` in the artifacts directory for documented edge cases where we intentionally diverge from `abcjs` or where further work is needed.
</file>

<file path="abc-theory/src/main/kotlin/io/github/ryangardner/abc/theory/AbcExtensions.kt">
package io.github.ryangardner.abc.theory

import io.github.ryangardner.abc.core.model.AbcTune

/**
 * Idiomatic Kotlin extension. 
 * Performs semantic transposition (changes the underlying note data and key signature).
 */
public fun AbcTune.transpose(semitones: Int): AbcTune = Transposer.transpose(this, semitones)

/**
 * Idiomatic Kotlin extension.
 * Performs visual transposition (changes only the rendering hint, leaves notes untouched).
 * Mimics abcjs client-side behavior.
 */
public fun AbcTune.setVisualTranspose(semitones: Int): AbcTune {
    return this.copy(metadata = this.metadata.copy(visualTranspose = semitones))
}
</file>

<file path="abc-theory/src/main/kotlin/io/github/ryangardner/abc/theory/CircleOfFifths.kt">
package io.github.ryangardner.abc.theory

import io.github.ryangardner.abc.core.model.*

public data class KeyCandidate(
    public val tonicStep: NoteStep,
    public val tonicAccidental: Int, // -1 for flat, 0 for natural, 1 for sharp, etc.
    public val accidentalsCount: Int // Positive for sharps, negative for flats
) {
    public val absoluteAccidentals: Int get() = kotlin.math.abs(accidentalsCount)
    
    public val tonicName: String get() = buildString {
        append(tonicStep.name)
        when (tonicAccidental) {
            1 -> append("#")
            -1 -> append("b")
            2 -> append("##")
            -2 -> append("bb")
        }
    }
}

public object CircleOfFifths {
    // Maps semitones (0-11) to candidate Major keys
    private val majorKeys = mapOf(
        0 to listOf(KeyCandidate(NoteStep.C, 0, 0)),
        1 to listOf(KeyCandidate(NoteStep.D, -1, -5), KeyCandidate(NoteStep.C, 1, 7)),
        2 to listOf(KeyCandidate(NoteStep.D, 0, 2)),
        3 to listOf(KeyCandidate(NoteStep.E, -1, -3), KeyCandidate(NoteStep.D, 1, 9)),
        4 to listOf(KeyCandidate(NoteStep.E, 0, 4)),
        5 to listOf(KeyCandidate(NoteStep.F, 0, -1)),
        6 to listOf(KeyCandidate(NoteStep.F, 1, 6), KeyCandidate(NoteStep.G, -1, -6)),
        7 to listOf(KeyCandidate(NoteStep.G, 0, 1)),
        8 to listOf(KeyCandidate(NoteStep.A, -1, -4), KeyCandidate(NoteStep.G, 1, 8)),
        9 to listOf(KeyCandidate(NoteStep.A, 0, 3)),
        10 to listOf(KeyCandidate(NoteStep.B, -1, -2), KeyCandidate(NoteStep.A, 1, 10)),
        11 to listOf(KeyCandidate(NoteStep.B, 0, 5), KeyCandidate(NoteStep.C, -1, -7))
    )

    public fun getBestMajorKey(semitones: Int): KeyCandidate {
        val normalized = ((semitones % 12) + 12) % 12
        return majorKeys[normalized]?.minByOrNull { it.absoluteAccidentals } 
            ?: KeyCandidate(NoteStep.C, 0, 0)
    }

    /**
     * Gets the best key for a given semitone and mode.
     */
    public fun getBestKey(key: KeySignature): KeyCandidate {
        val tonicSemitones = key.tonicSemitones
        val mode = key.mode
        
        val modeOffset = getModeOffsetInSemitones(mode)
        // Find the relative major semitones
        val relativeMajorSemitones = (tonicSemitones + modeOffset + 12) % 12
        
        val candidates = majorKeys[relativeMajorSemitones] ?: listOf(KeyCandidate(NoteStep.C, 0, 0))
        
        // If the key explicitly specifies an accidental for the root, prefer that candidate
        val rootAccidentalValue = accidentalToSemitones(key.root.accidental)
        val bestMajor = if (rootAccidentalValue != 0) {
            // This is slightly tricky because the root accidental is for the MODE's root, not the Major's root.
            // But usually they match in terms of sharp/flat preference.
            candidates.find { 
                val candidateModeStepOrdinal = (it.tonicStep.ordinal + (7 - getModeStepOffset(mode))) % 7
                val candidateModeStep = NoteStep.values()[candidateModeStepOrdinal]
                val candidateBaseSemitones = stepToSemitones(candidateModeStep)
                var candidateDiff = (tonicSemitones - candidateBaseSemitones) % 12
                if (candidateDiff > 6) candidateDiff -= 12
                if (candidateDiff < -6) candidateDiff += 12
                candidateDiff == rootAccidentalValue
            } ?: candidates.minBy { it.absoluteAccidentals }
        } else {
            candidates.minBy { it.absoluteAccidentals }
        }
        
        // Now find the mode's tonic step by shifting from the major tonic step
        val stepOffset = getModeStepOffset(mode)
        val modeStepOrdinal = (bestMajor.tonicStep.ordinal + stepOffset) % 7
        val modeStep = NoteStep.values()[modeStepOrdinal]
        
        // Calculate accidental for this step to match tonicSemitones
        val baseSemitones = stepToSemitones(modeStep)
        var diff = (tonicSemitones - baseSemitones) % 12
        if (diff > 6) diff -= 12
        if (diff < -6) diff += 12
        
        return KeyCandidate(modeStep, diff, bestMajor.accidentalsCount)
    }

    public fun getBestKey(tonicSemitones: Int, mode: KeyMode): KeyCandidate {
        // Fallback for when we don't have the full KeySignature object
        val modeOffset = getModeOffsetInSemitones(mode)
        val relativeMajorSemitones = (tonicSemitones + modeOffset + 12) % 12
        val bestMajor = getBestMajorKey(relativeMajorSemitones)
        
        val stepOffset = getModeStepOffset(mode)
        val modeStepOrdinal = (bestMajor.tonicStep.ordinal + stepOffset) % 7
        val modeStep = NoteStep.values()[modeStepOrdinal]
        
        val baseSemitones = stepToSemitones(modeStep)
        var diff = (tonicSemitones - baseSemitones) % 12
        if (diff > 6) diff -= 12
        if (diff < -6) diff += 12
        
        return KeyCandidate(modeStep, diff, bestMajor.accidentalsCount)
    }

    private fun getModeOffsetInSemitones(mode: KeyMode): Int = when (mode) {
        KeyMode.MAJOR, KeyMode.IONIAN -> 0
        KeyMode.DORIAN -> 10 // or -2
        KeyMode.PHRYGIAN -> 8 // or -4
        KeyMode.LYDIAN -> 7 // or -5
        KeyMode.MIXOLYDIAN -> 5 // or -7
        KeyMode.MINOR, KeyMode.AEOLIAN -> 3
        KeyMode.LOCRIAN -> 1
    }

    private fun getModeStepOffset(mode: KeyMode): Int = when (mode) {
        KeyMode.MAJOR, KeyMode.IONIAN -> 0
        KeyMode.DORIAN -> 1
        KeyMode.PHRYGIAN -> 2
        KeyMode.LYDIAN -> 3
        KeyMode.MIXOLYDIAN -> 4
        KeyMode.MINOR, KeyMode.AEOLIAN -> 5
        KeyMode.LOCRIAN -> 6
    }

    public fun getAccidentalForStep(step: NoteStep, k: Int): Int {
        val sharpOrder = listOf(NoteStep.F, NoteStep.C, NoteStep.G, NoteStep.D, NoteStep.A, NoteStep.E, NoteStep.B)
        val flatOrder = sharpOrder.reversed()
        
        return if (k > 0) {
            if (sharpOrder.take(k).contains(step)) 1 else 0
        } else if (k < 0) {
            if (flatOrder.take(-k).contains(step)) -1 else 0
        } else {
            0
        }
    }

    public fun stepToSemitones(step: NoteStep): Int = when (step) {
        NoteStep.C -> 0
        NoteStep.D -> 2
        NoteStep.E -> 4
        NoteStep.F -> 5
        NoteStep.G -> 7
        NoteStep.A -> 9
        NoteStep.B -> 11
    }

    public fun accidentalToSemitones(accidental: Accidental?): Int = accidental?.semitones ?: 0

    public fun semitonesToAccidental(semitones: Int): Accidental? = when (semitones) {
        1 -> Accidental.SHARP
        -1 -> Accidental.FLAT
        2 -> Accidental.DOUBLE_SHARP
        -2 -> Accidental.DOUBLE_FLAT
        0 -> null
        else -> null
    }
}

/**
 * Extension property to get the absolute semitone value of a pitch within its octave.
 */
public val Pitch.semitones: Int
    get() = CircleOfFifths.stepToSemitones(step) + CircleOfFifths.accidentalToSemitones(accidental)

/**
 * Extension property to get the total semitones including octave.
 */
public val Pitch.totalSemitones: Int
    get() = semitones + octave * 12

/**
 * Extension property to get semitones of a KeySignature tonic.
 */
public val KeySignature.tonicSemitones: Int
    get() = CircleOfFifths.stepToSemitones(root.step) + CircleOfFifths.accidentalToSemitones(root.accidental)
</file>

<file path="abc-theory/src/main/kotlin/io/github/ryangardner/abc/theory/Transposer.kt">
package io.github.ryangardner.abc.theory

import io.github.ryangardner.abc.core.model.*

public object Transposer {
    /**
     * Transposes the given tune by the specified number of semitones.
     * Uses the Circle of Fifths to determine the new key signature.
     * Java usage: Transposer.transpose(tune, 2)
     */
    @JvmStatic
    public fun transpose(tune: AbcTune, semitones: Int): AbcTune {
        if (semitones == 0) return tune

        val newHeader = transposeHeader(tune.header, semitones)
        
        // Find the step difference between the old tonic and the new tonic
        val oldKey = tune.header.key
        val newKey = newHeader.key
        val stepDiff = (newKey.root.step.ordinal - oldKey.root.step.ordinal + 7) % 7

        // Get the new key's accidentals count (sharps/flats) to help with context-aware note transposition
        val bestKey = CircleOfFifths.getBestKey(newKey.tonicSemitones, newKey.mode)
        
        val newBody = transposeBody(tune.body, semitones, stepDiff, bestKey.accidentalsCount)
        
        // As per architecture: If physical notes changed, clear visualTranspose
        val newMetadata = tune.metadata.copy(visualTranspose = null)
        
        return tune.copy(header = newHeader, body = newBody, metadata = newMetadata)
    }

    private fun transposeHeader(header: TuneHeader, semitones: Int): TuneHeader {
        return header.copy(key = transposeKey(header.key, semitones))
    }

    private fun transposeKey(key: KeySignature, semitones: Int): KeySignature {
        val newTonicSemitones = ((key.tonicSemitones + semitones) % 12 + 12) % 12
        val bestKey = CircleOfFifths.getBestKey(newTonicSemitones, key.mode)
        
        return key.copy(
            root = KeyRoot(
                bestKey.tonicStep,
                CircleOfFifths.semitonesToAccidental(bestKey.tonicAccidental) ?: Accidental.NATURAL
            )
        )
    }

    private fun transposeBody(body: TuneBody, semitones: Int, stepDiff: Int, newKeyAccidentals: Int): TuneBody {
        return body.copy(elements = body.elements.map { transposeElement(it, semitones, stepDiff, newKeyAccidentals) })
    }

    private fun transposeElement(element: MusicElement, semitones: Int, stepDiff: Int, newKeyAccidentals: Int): MusicElement {
        return when (element) {
            is NoteElement -> transposeNote(element, semitones, stepDiff, newKeyAccidentals)
            is ChordElement -> element.copy(notes = element.notes.map { transposeNote(it, semitones, stepDiff, newKeyAccidentals) })
            is BarLineElement, is InlineFieldElement, is RestElement, is DirectiveElement -> element
            else -> element
        }
    }

    private fun transposeNote(note: NoteElement, semitones: Int, stepDiff: Int, newKeyAccidentals: Int): NoteElement {
        val newPitch = transposePitch(note.pitch, semitones, stepDiff, newKeyAccidentals)
        return note.copy(pitch = newPitch, accidental = newPitch.accidental)
    }

    private fun transposePitch(pitch: Pitch, semitones: Int, stepDiff: Int, newKeyAccidentals: Int): Pitch {
        val oldTotalSemitones = pitch.totalSemitones
        val newTotalSemitones = oldTotalSemitones + semitones
        
        // 1. Calculate New Step: First, shift the diatonic step
        val newStepOrdinal = (pitch.step.ordinal + stepDiff) % 7
        val newStep = NoteStep.values()[newStepOrdinal]
        
        // 2. Calculate New Alteration: Then, calculate the necessary accidental to match the target semitone pitch.
        val baseSemitones = CircleOfFifths.stepToSemitones(newStep)
        val diff = newTotalSemitones - baseSemitones
        var newOctave = Math.floorDiv(diff, 12)
        var accidentalSemitones = Math.floorMod(diff, 12)
        if (accidentalSemitones > 6) {
            accidentalSemitones -= 12
            newOctave += 1
        }

        // 3. Context Check: compare against the New Key Signature.
        val keyAccidental = CircleOfFifths.getAccidentalForStep(newStep, newKeyAccidentals)
        
        val finalAccidental = if (accidentalSemitones == keyAccidental) {
            null // The key already provides this accidental
        } else if (accidentalSemitones == 0) {
            Accidental.NATURAL
        } else {
            CircleOfFifths.semitonesToAccidental(accidentalSemitones)
        }
        
        return Pitch(newStep, newOctave, finalAccidental)
    }
}
</file>

<file path="abc-theory/src/test/kotlin/io/github/ryangardner/abc/theory/TransposerTest.kt">
package io.github.ryangardner.abc.theory

import io.github.ryangardner.abc.core.model.*
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Assertions.assertNull
import org.junit.jupiter.api.Test

public class TransposerTest {

    private fun createSimpleTune(tonic: NoteStep, accidental: Accidental, mode: KeyMode, notes: List<Pitch>): AbcTune {
        val key = KeySignature(KeyRoot(tonic, accidental), mode)
        val header = TuneHeader(
            reference = 1,
            title = listOf("Test Tune"),
            key = key,
            meter = TimeSignature(4, 4),
            length = NoteDuration(1, 8)
        )
        val body = TuneBody(
            elements = notes.map { NoteElement(it, NoteDuration(1, 8)) }
        )
        return AbcTune(header, body, TuneMetadata())
    }

    @Test
    public fun `test transpose C Major up 2 semitones to D Major`(): Unit {
        val tune = createSimpleTune(NoteStep.C, Accidental.NATURAL, KeyMode.IONIAN, listOf(Pitch(NoteStep.C, 4)))
        val transposed = Transposer.transpose(tune, 2)
        
        assertEquals(NoteStep.D, transposed.header.key.root.step)
        assertEquals(Accidental.NATURAL, transposed.header.key.root.accidental)
        assertEquals(KeyMode.IONIAN, transposed.header.key.mode)
        
        val note = transposed.body.elements[0] as NoteElement
        assertEquals(NoteStep.D, note.pitch.step)
        assertEquals(4, note.pitch.octave)
        assertNull(note.pitch.accidental)
    }

    @Test
    public fun `test transpose G Major up 1 semitone to Ab Major`(): Unit {
        val tune = createSimpleTune(NoteStep.G, Accidental.NATURAL, KeyMode.IONIAN, listOf(Pitch(NoteStep.G, 4)))
        val transposed = Transposer.transpose(tune, 1)
        
        assertEquals(NoteStep.A, transposed.header.key.root.step)
        assertEquals(Accidental.FLAT, transposed.header.key.root.accidental)
        
        val note = transposed.body.elements[0] as NoteElement
        assertEquals(NoteStep.A, note.pitch.step)
        assertNull(note.pitch.accidental) // Ab is in key sig
    }

    @Test
    public fun `test explicit natural in G Major`(): Unit {
        val tune = createSimpleTune(NoteStep.C, Accidental.NATURAL, KeyMode.IONIAN, listOf(Pitch(NoteStep.F, 4, Accidental.SHARP)))
        val transposed = Transposer.transpose(tune, 7)
        
        assertEquals(NoteStep.G, transposed.header.key.root.step)
        val note = transposed.body.elements[0] as NoteElement
        assertEquals(NoteStep.C, note.pitch.step)
        assertEquals(Accidental.SHARP, note.pitch.accidental)
    }

    @Test
    public fun `test natural accidental needed`(): Unit {
        val tune = createSimpleTune(NoteStep.G, Accidental.NATURAL, KeyMode.IONIAN, listOf(Pitch(NoteStep.F, 4, Accidental.NATURAL)))
        val transposed = Transposer.transpose(tune, 2)
        
        assertEquals(NoteStep.A, transposed.header.key.root.step)
        val note = transposed.body.elements[0] as NoteElement
        assertEquals(NoteStep.G, note.pitch.step)
        assertEquals(Accidental.NATURAL, note.pitch.accidental)
    }

    @Test
    public fun `test setVisualTranspose`(): Unit {
        val tune = createSimpleTune(NoteStep.C, Accidental.NATURAL, KeyMode.IONIAN, listOf(Pitch(NoteStep.C, 4)))
        val visual = tune.setVisualTranspose(2)
        
        assertEquals(2, visual.metadata.visualTranspose)
        // Ensure notes are NOT changed
        val note = visual.body.elements[0] as NoteElement
        assertEquals(NoteStep.C, note.pitch.step)
    }
}
</file>

<file path="docs/architecture.md">
# **Architectural Design Specification for LibABC-Kotlin: A JVM-Native Library for Symbolic Music Processing**

## **1\. Executive Summary and Architectural Vision**

The digital representation of music has evolved into a fragmented landscape of competing standards, each optimized for specific use casesMusicXML for interchange, MIDI for playback, and ABC notation for concise, human-readable transcription. The proposed library, LibABC-Kotlin, aims to unify these disparate domains within the Java Virtual Machine (JVM) ecosystem. This document outlines a rigorous architectural specification for a Kotlin-based library designed to parse, manipulate, and generate ABC notation with full fidelity to the abcjs dialect.

The primary objective is to engineer a high-performance, immutable, and strictly typed library that serves as a bridge between the textual flexibility of ABC notation and the structural rigidity of object-oriented models like TuxGuitar and MusicXML. This library is not merely a parser; it is a semantic engine capable of understanding musical context, performing complex music theory operations such as semantic transposition, and ensuring seamless interoperability with legacy Java codebases through idiomatic API design.

The architectural vision prioritizes "correctness over permissiveness" in its internal model while maintaining "permissiveness over correctness" in its parsing layer. This duality allows the library to ingest the often-messy, "loose" ABC files found in the wildspecifically those tailored for the web-based abcjs rendererwhile normalizing them into a coherent internal structure suitable for conversion to strict formats like Guitar Pro (via TuxGuitar) or MusicXML.

### **1.1 The Domain Problem: Symbolic Music Impedance Mismatch**

A core challenge addressed by this design is the "impedance mismatch" between stream-oriented and measure-oriented formats. ABC notation 1 is fundamentally a stream of events: notes, chords, and bar lines appear sequentially, often without strict enforcement of measure duration or voice synchronization. Conversely, libraries like TuxGuitar 3 and formats like MusicXML 5 are hierarchical and measure-centric; they require notes to be strictly contained within measure boundaries, often demanding precise vertical alignment of multiple voices.

LibABC-Kotlin solves this by implementing a "Verticalization Engine" as a core component of its architecture. This engine transforms the linear AST (Abstract Syntax Tree) derived from ABC text into a time-sliced, vertically aligned representation required for export to TuxGuitar and MusicXML. This approach ensures that the library acts not just as a translator, but as a structural validator, capable of detecting and reconciling rhythmic inconsistencies inherent in hand-typed ABC files.

### **1.2 The abcjs Compatibility Mandate**

While standard ABC 2.1 6 forms the baseline, the web ecosystem has coalesced around the abcjs library, which introduces a superset of directives for visual rendering and audio synthesis.8 Standard parsers often discard these directives as comments. To fulfill the requirement of "reading and writing to the abcjs format," LibABC-Kotlin treats abcjs directivessuch as %%visualTranspose, %%MIDI program, and formatting parameters like %%staffwidthas first-class citizens within the AST. This ensures that a file parsed, manipulated, and re-serialized by the library preserves the specific rendering instructions required for web presentation, facilitating a seamless round-trip workflow between the JVM backend and a browser frontend.

## **2\. High-Level System Architecture**

The library is structured as a multi-module Maven project. This modularity ensures separation of concerns, allowing users to import only the core data models without pulling in heavy dependencies related to TuxGuitar or complex analysis algorithms.

### **2.1 Module Decomposition**

| Module Name | Artifact ID | Description | Dependencies |
| :---- | :---- | :---- | :---- |
| **Core Model** | abc-core | Defines the immutable data classes, enums, and interfaces representing the ABC AST. Contains zero logic beyond data holding. | kotlin-stdlib |
| **Parser Engine** | abc-parser | Contains the Lexer, Parser, and Validator. Responsible for converting raw text strings into the Core Model. Handles abcjs directive parsing. | abc-core |
| **Music Theory** | abc-theory | Implements algorithmic manipulations: Transposition (chromatic/diatonic), key analysis, and duration calculations. | abc-core |
| **Integration** | abc-interop | Adapters for converting the Core Model to/from TuxGuitar and MusicXML formats. | abc-core, abc-theory, tuxguitar-lib |
| **Test Suite** | abc-test | Contains the "Ground Truth" datasets and integration tests. | All modules, JUnit 5 |

### **2.2 Technology Stack and Compatibility Profile**

To satisfy the requirement of easy Java integration 10, the library leverages Kotlin's static compilation features while targeting a baseline that ensures broad compatibility.

* **Language:** Kotlin 1.9+ (compiled with strict explicit API mode).  
* **JVM Target:** Java 8 (1.8). This ensures the library can be "dropped in" to legacy enterprise Java applications or older Android environments without version conflicts.11  
* **Build System:** Maven 3.8+. While Gradle is popular in Kotlin, Maven provides a rigid, declarative structure preferred for library publication and legacy integration.  
* **Interop Strategy:** The API surface utilizes @JvmOverloads, @JvmStatic, and @JvmField annotations to mask Kotlin-specific constructs (like companion objects or default arguments) from Java consumers, presenting a natural, idiomatic Java API.13

## **3\. The Abstract Syntax Tree (AST) Data Model**

The AST is the source of truth for the musical content. It is designed to be **immutable**, **type-safe**, and **exhaustive**. Unlike string-based manipulation, utilizing an AST prevents the generation of syntactically invalid ABC code.

### **3.1 The Root Structure: AbcTune**

The root object represents a single tune within an ABC file (or a file containing multiple tunes).

Kotlin

/\*\*  
 \* Represents a fully parsed ABC tune.  
 \* Immutable and thread-safe.  
 \*/  
data class AbcTune(  
    val header: TuneHeader,  
    val body: TuneBody,  
    val metadata: TuneMetadata  
)

### **3.2 The Header Model**

ABC headers define the global state. LibABC-Kotlin parses these into strongly typed objects rather than generic strings to facilitate algorithmic manipulation (e.g., transposition requires understanding KeySignature as an object, not just the string "K:Dm").

| Field | ABC Code | Type | Description |
| :---- | :---- | :---- | :---- |
| Reference | X: | Int | Unique index of the tune. |
| Title | T: | List\<String\> | Supports multiple titles (primary, secondary). |
| Key | K: | KeySignature | Encapsulates Tonic, Mode (Major, Minor, Dorian, etc.), and Accidental list. |
| Meter | M: | TimeSignature | Represents meter as numerator/denominator or symbols (C, \`C |
| Length | L: | NoteDuration | The default note length (e.g., 1/8). |
| Tempo | Q: | Tempo | Beats per minute mapping. |

### **3.3 The Musical Body: A Polymorphic Stream**

The body of an ABC tune is a sequence of musical elements. To represent this in Kotlin, we utilize a sealed class hierarchy. This allows for exhaustive when expressions in the compiler, ensuring that any visitor processing the music handles every possible element type.

Kotlin

sealed class MusicElement {  
    // Represents a playable note or rest  
    abstract val duration: Duration  
}

data class NoteElement(  
    val pitch: Pitch,  
    val length: Duration,  
    val ties: TieType \= TieType.NONE,  
    val decorations: List\<Decoration\> \= emptyList(), // e.g.,\!trill\!  
    val accidental: Accidental? \= null // Explicit accidental handling  
) : MusicElement()

data class ChordElement(  
    val notes: List\<NoteElement\>,  
    val duration: Duration,  
    val annotation: String? \= null // Text annotations like "Am7"  
) : MusicElement()

data class BarLineElement(  
    val type: BarLineType, // |, ||, |\], :|, |:  
    val repeatCount: Int \= 0  
) : MusicElement()

data class InlineFieldElement(  
    val fieldType: HeaderType, // e.g., K, L, M  
    val value: String  
) : MusicElement()

**Insight:** Standard ABC parsers often fail to distinguish between a "decorating chord" (text above staff) and a "sounding chord" (notes played together). LibABC-Kotlin disambiguates these by treating text annotations (e.g., "Am") as properties of the MusicElement, while sounding chords (\[CEG\]) are distinct ChordElement objects.

### **3.4 Handling abcjs Directives**

abcjs directives usually appear as comment-like lines starting with %%. To support reading and writing abcjs format, these are not discarded but parsed into a specialized FormattingModel.

* **Visual Transpose:** %%visualTranspose n shifts the rendering without changing the audio or logic. The library parses this into an integer field in TuneMetadata.8  
* **MIDI Directives:** %%MIDI program controls instrument selection. This is parsed into a MidiConfiguration object, critical for the TuxGuitar export layer to assign correct instrument tracks.

## **4\. Parser Implementation Strategy**

The parsing layer is critical for robustness. It must handle the variability of human-generated ABC files.

### **4.1 Lexical Analysis (Tokenization)**

The lexer transforms the raw string into a stream of AbcTokens.

* **State Machine:** The lexer operates in two primary states: HEADER\_SCAN and BODY\_SCAN.  
  * In HEADER\_SCAN, it looks for lines starting with Letter: and newline terminators.  
  * In BODY\_SCAN, it recognizes notes (C, ^C, C,,), durations (2, /2), and structural tokens (|, \` to determine the target key.  
  * *Example:* Transposing G Major (1 sharp) up 2 semitones \-\> A Major (3 sharps).  
  * *Enharmonic Resolution:* If the target key would have excessive accidentals (e.g., G\# Major with 8 sharps), the algorithm automatically snaps to the enharmonic equivalent (Ab Major with 4 flats).  
2. **Interval Calculation:**  
   * Determine the diatonic interval (number of staff lines to move) and the chromatic interval (semitones).  
   * *Example:* Up 2 semitones (Major 2nd) involves moving the diatonic step by \+1 (e.g., G \-\> A).  
3. **Note-Level Transposition:**  
   * For every NoteElement:  
     * Shift the step by the diatonic interval.  
     * Calculate the expected pitch of the new step in the *target key*.  
     * Adjust the accidental to match the target chromatic pitch.  
   * *Handling abcjs:* If %%visualTranspose is present, it must be cleared or adjusted, as the physical notes are now changed.

### **5.3 Handling abcjs Visual Transposition**

The library distinguishes between **Semantic Transposition** (changing the data) and **Visual Transposition** (changing the view).

* AbcTune.transpose(semitones: Int): Returns a new AbcTune with altered notes and key signature.  
* AbcTune.setVisualTranspose(semitones: Int): Returns a new AbcTune with the original notes but an updated %%visualTranspose directive. This mimics the client-side behavior of abcjs.8

## **6\. Integration: TuxGuitar and MusicXML**

This section addresses the complexity of bridging the linear ABC format with the vertical/hierarchical formats of MusicXML and TuxGuitar.

### **6.1 The Verticalization Problem**

ABC does not strictly enforce measure lengths. A voice can have 5 beats in a 4/4 measure. TuxGuitar's data model (TGMeasure) is rigid.

* **Solution: The Measure Quantizer.**  
  The abc-interop module implements a MeasureQuantizer. It iterates through the linear stream of ABC notes and "bins" them into measures based on the time signature.  
  * *Accumulator Logic:* The quantizer maintains a beat accumulator. When currentBeats \>= timeSignatureBeats, a new TGMeasure is instantiated.  
  * *Tie Handling:* If an ABC note overruns a measure boundary (which is valid in loose ABC), the quantizer splits the note into two TGNote objects tied together across the measure line.

### **6.2 Mapping to TuxGuitar (TG)**

Based on TuxGuitar's internal model 3:

* **AbcVoice \-\> TGTrack:** Each voice in the ABC file becomes a separate track.  
* **%%MIDI program \-\> TGChannel:** The library parses the MIDI directive to assign the correct instrument (e.g., Distortion Guitar vs. Piano) to the TGTrack.  
* **Decorations \-\> TGNoteEffect:** ABC decorations like . (staccato) or \~ (roll) are mapped to TGNoteEffect or TGEffect flags.

### **6.3 Mapping to MusicXML**

Since the user's software reads MusicXML, providing a robust export is crucial.

* **Part-wise Export:** The library exports to \<score-partwise\>.18  
* **Directives:** ABC headers (T:, C:) map to MusicXML metadata (\<work-title\>, \<creator type="composer"\>).  
* **Dynamics:** ABC dynamics (\!ff\!, \!p\!) are mapped to \<direction\>\<dynamics\>\<ff/\>\</dynamics\>\</direction\> elements in MusicXML.19

## **7\. Quality Assurance: Exhaustive Unit Testing**

To ensure the library is production-ready, we employ a "Ground Truth" testing strategy using large-scale datasets.

### **7.1 Ground Truth Datasets**

We utilize the **ABC Notation Dataset (10k samples)** from Zenodo.20 This dataset provides verified ABC files and their rendered images.

* **Test Setup:** The build system will download a subset of this dataset (e.g., the "Nottingham" subset for clean data, and a random subset for "wild" data) into src/test/resources.

### **7.2 Test Strategies**

1. **Round-Trip Fidelity (The Golden Test):**  
   * Parse File A \-\> AST \-\> Serialize to File B.  
   * Assert File A (normalized) \== File B.  
   * *Normalization:* The test ignores whitespace differences but strictly enforces that all headers, notes, and abcjs directives are preserved.  
2. **Transposition Verification:**  
   * Parse a tune in C Major.  
   * Transpose programmatically to D Major (+2 semitones).  
   * Compare the result against a manually verified "Gold Standard" file of the same tune in D Major.  
   * *Check:* Ensure accidentals are correctly spelled (F\# in D Major, not Gb).  
3. **TuxGuitar Integration Test:**  
   * Parse an ABC file.  
   * Convert to TGSong.  
   * Serialize TGSong to MusicXML using the internal converter.  
   * Validate the output XML against the official MusicXML 4.0 XSD schema.5

### **7.3 Code Coverage and Quality**

* **Kover:** Configured to enforce 90% branch coverage on the abc-parser and abc-theory modules.21  
* **Ktlint & Detekt:** Enforce style guides. Detekt is configured to flag complex methods (cyclomatic complexity \> 10), which often indicates fragile parsing logic.23

## **8\. Development Roadmap and Agent Tasks**

This section breaks down the implementation into discrete, verifiable tasks for an autonomous coding agent.

### **Phase 1: Core Foundation**

* **Task 1.1:** Initialize Maven project with modules: abc-core, abc-parser, abc-theory, abc-interop. Configure pom.xml with Kotlin 1.9, Java 1.8 target, and ktlint plugin.  
* **Task 1.2:** Implement AbcTune, TuneHeader, and MusicElement sealed classes in abc-core. Use @JvmOverloads on all constructors.  
* **Task 1.3:** Create Token enum and implement the AbcLexer in abc-parser. Write tests to verify tokenization of headers vs. body content.

### **Phase 2: Parser & abcjs Support**

* **Task 2.1:** Implement HeaderParser. Support all standard headers. Add a Map\<String, String\> for unknown headers.  
* **Task 2.2:** Implement BodyParser. Handle notes, rests, chords, and bar lines.  
* **Task 2.3:** Implement DirectiveParser specifically for abcjs. Parse %%visualTranspose, %%staffwidth, and %%MIDI into strongly typed configuration objects within the AST.

### **Phase 3: Theory & Transposition**

* **Task 3.1:** Implement Pitch class with semitone values. Implement KeySignature with a Circle of Fifths lookup table.  
* **Task 3.2:** Implement Transposer class. Logic: targetKey \= sourceKey \+ interval. targetNote \= sourceNote \+ interval. Ensure enharmonic spelling logic is robust (using key signature context).  
* **Task 3.3:** Add AbcTune.transpose(semitones: Int) method.

### **Phase 4: Integration**

* **Task 4.1:** Implement MeasureQuantizer in abc-interop. Convert linear MusicElement lists into fixed-duration chunks.  
* **Task 4.2:** Implement AbcToTuxGuitarConverter. Map AbcTune to TGSong and AbcVoice to TGTrack.  
* **Task 4.3:** Implement MusicXMLWriter. Serialize AbcTune to compliant MusicXML.

### **Phase 5: Verification**

* **Task 5.1:** Set up abc-test module. Write a script to download the Zenodo dataset.  
* **Task 5.2:** Implement parameterized JUnit 5 tests to run the Round-Trip check on 1,000 files.  
* **Task 5.3:** Run mvn kover:report and refine tests to hit coverage targets.

# ---

**Detailed Implementation Guide**

## **9\. Maven Build Specification**

To ensure compatibility with Java users ("drop it in easily") and modern Kotlin development, the Maven build is configured carefully.

### **9.1 Parent POM (pom.xml)**

XML

\<project xmlns\="http://maven.apache.org/POM/4.0.0"...\>  
    \<modelVersion\>4.0.0\</modelVersion\>  
    \<groupId\>com.example.music\</groupId\>  
    \<artifactId\>libabc-kotlin-parent\</artifactId\>  
    \<version\>1.0.0\</version\>  
    \<packaging\>pom\</packaging\>

    \<modules\>  
        \<module\>abc-core\</module\>  
        \<module\>abc-parser\</module\>  
        \<module\>abc-theory\</module\>  
        \<module\>abc-interop\</module\>  
    \</modules\>

    \<properties\>  
        \<kotlin.version\>1.9.22\</kotlin.version\>  
        \<java.version\>1.8\</java.version\>  
        \<tuxguitar.version\>1.5.4\</tuxguitar.version\>  
    \</properties\>l

    \<dependencyManagement\>  
        \<dependencies\>  
            \<dependency\>  
                \<groupId\>org.jetbrains.kotlin\</groupId\>  
                \<artifactId\>kotlin-stdlib\</artifactId\>
                \<version\>${kotlin.version}\</version\>  
            \</dependency\>  
            \<dependency\>  
                \<groupId\>org.jetbrains.kotlin\</groupId\>  
                \<artifactId\>kotlin-test-junit5\</artifactId\>  
                \<version\>${kotlin.version}\</version\>  
                \<scope\>test\</scope\>  
            \</dependency\>  
        \</dependencies\>  
    \</dependencyManagement\>

    \<build\>  
        \<plugins\>  
            \<plugin\>  
                \<groupId\>org.jetbrains.kotlin\</groupId\>  
                \<artifactId\>kotlin-maven-plugin\</artifactId\>  
                \<version\>${kotlin.version}\</version\>  
                \<configuration\>  
                    \<jvmTarget\>${java.version}\</jvmTarget\>  
                    \<args\>  
                        \<arg\>\-Xjvm-default=all\</arg\> \</args\>  
                \</configuration\>  
                \<executions\>  
                    \<execution\>  
                        \<id\>compile\</id\>  
                        \<goals\>\<goal\>compile\</goal\>\</goals\>  
                    \</execution\>  
                    \<execution\>  
                        \<id\>test-compile\</id\>  
                        \<goals\>\<goal\>test-compile\</goal\>\</goals\>  
                    \</execution\>  
                \</executions\>  
            \</plugin\>  
            \<plugin\>  
                \<groupId\>org.jetbrains.kotlinx\</groupId\>  
                \<artifactId\>kover-maven-plugin\</artifactId\>  
                \<version\>0.7.5\</version\>  
                \<executions\>  
                    \<execution\>  
                        \<goals\>\<goal\>report\</goal\>\</goals\>  
                    \</execution\>  
                \</executions\>  
            \</plugin\>  
        \</plugins\>  
    \</build\>  
\</project\>

### **9.2 Java Interoperability Strategy**

To make the library feel native to Java users:

* **@JvmOverloads:** Applied to the AbcParser.parse() method. This allows Java users to call parse(file) without supplying default configuration objects.  
* **@JvmStatic:** Used on companion object factory methods. Java code calls AbcFactory.create() instead of AbcFactory.Companion.create().  
* **@JvmField:** Used for public constants in AbcConstants to avoid getter overhead.

## **10\. Code Standards and Instructions**

### **10.1 Style Guide**

* **Kotlin:** Follow the official JetBrains style guide. Enforced via ktlint.  
* **Immutability:** All AST nodes (NoteElement, Header) must be data class with val properties. No var in the core model.  
* **Nullability:** Use strict null checks. Java interop boundaries must ensure null is not returned unless explicitly typed as Optional or documented @Nullable.

### **10.2 Documentation**

* KDoc is mandatory for all public members.  
* Must include @sample tags pointing to test cases for usage examples.

## **11\. Conclusion**

LibABC-Kotlin represents a robust, theoretically sound approach to bringing ABC notation into the professional Java/Kotlin ecosystem. By respecting the nuances of abcjs, implementing a rigorous semantic transposition engine, and solving the linear-to-vertical mapping problem for TuxGuitar integration, this library fills a critical gap in music software development tools. The detailed architectural plan and test-driven development roadmap provided herein ensure that an automated agent can execute this vision with high precision and reliability.

---

**Citations:** 1 \- ABC Standard & Notation. 1 \- abcjs directives and features. 3 \- TuxGuitar data models. 5 \- MusicXML structure. 15 \- Music theory and Transposition algorithms. 20 \- Ground Truth Datasets. 10 \- Java/Kotlin Interoperability. 11 \- Build & Quality tools.

#### **Works cited**

1. ABC Quick Reference Card \- Michael Eskin, accessed February 8, 2026, [https://michaeleskin.com/documents/ABCquickRefv0\_6.pdf](https://michaeleskin.com/documents/ABCquickRefv0_6.pdf)  
2. ABC notation \- Grokipedia, accessed February 8, 2026, [https://grokipedia.com/page/ABC\_notation](https://grokipedia.com/page/ABC_notation)  
3. Which file formats does TuxGuitar support?, accessed February 8, 2026, [https://tuxguitar.org/which-file-formats-does-tuxguitar-support/](https://tuxguitar.org/which-file-formats-does-tuxguitar-support/)  
4. Measure and beat \- TuxGuitar Help, accessed February 8, 2026, [https://www.tuxguitar.app/files/devel/desktop/help/detail\_measure\_beat.html](https://www.tuxguitar.app/files/devel/desktop/help/detail_measure_beat.html)  
5. MusicXML 3.0 Tutorial, accessed February 8, 2026, [https://www.musicxml.com/wp-content/uploads/2012/12/musicxml-tutorial.pdf](https://www.musicxml.com/wp-content/uploads/2012/12/musicxml-tutorial.pdf)  
6. ABC (musical notation) \- Just Solve the File Format Problem, accessed February 8, 2026, [http://justsolve.archiveteam.org/wiki/ABC\_(musical\_notation)](http://justsolve.archiveteam.org/wiki/ABC_\(musical_notation\))  
7. abc:standard:v2.1 \[abc wiki\] \- ABC Notation, accessed February 8, 2026, [https://abcnotation.com/wiki/abc:standard:v2.1](https://abcnotation.com/wiki/abc:standard:v2.1)  
8. abcjs/RELEASE.md at main  paulrosen/abcjs \- GitHub, accessed February 8, 2026, [https://github.com/paulrosen/abcjs/blob/main/RELEASE.md](https://github.com/paulrosen/abcjs/blob/main/RELEASE.md)  
9. abcjs \- NPM, accessed February 8, 2026, [https://www.npmjs.com/package/abcjs](https://www.npmjs.com/package/abcjs)  
10. Calling Kotlin from Java, accessed February 8, 2026, [https://kotlinlang.org/docs/java-to-kotlin-interop.html](https://kotlinlang.org/docs/java-to-kotlin-interop.html)  
11. Maven | Kotlin Documentation, accessed February 8, 2026, [https://kotlinlang.org/docs/maven.html](https://kotlinlang.org/docs/maven.html)  
12. Create a Java and Kotlin Project with Maven \- Baeldung, accessed February 8, 2026, [https://www.baeldung.com/kotlin/maven-java-project](https://www.baeldung.com/kotlin/maven-java-project)  
13. Using @JvmOverloads and @JvmStatic for Kotlin interoperability, accessed February 8, 2026, [https://dev.to/ike\_\_jr/using-jvmoverloads-and-jvmstatic-for-kotlin-interoperability-with-java-3ag7](https://dev.to/ike__jr/using-jvmoverloads-and-jvmstatic-for-kotlin-interoperability-with-java-3ag7)  
14. Understanding @JvmStatic, @JvmField, and @JvmOverloads in Kotlin, accessed February 8, 2026, [https://medium.com/@manishkumar\_75473/understanding-jvmstatic-jvmfield-and-jvmoverloads-11dbe4226c5c](https://medium.com/@manishkumar_75473/understanding-jvmstatic-jvmfield-and-jvmoverloads-11dbe4226c5c)  
15. Transpose Music Easily: Use the Circle of Fifths \- CircleOfFifths.io, accessed February 8, 2026, [https://circleoffifths.io/blog/transpose-music-easily-use-the-circle-of-fifths](https://circleoffifths.io/blog/transpose-music-easily-use-the-circle-of-fifths)  
16. Learn to use the circle of fifths, a powerful musical tool, accessed February 8, 2026, [https://musicteachers.co.uk/music/circle-of-fifths](https://musicteachers.co.uk/music/circle-of-fifths)  
17. Transposition | \- abcjs, accessed February 8, 2026, [https://docs.abcjs.net/transposing/transposing](https://docs.abcjs.net/transposing/transposing)  
18. The Structure of MusicXML Files, accessed February 8, 2026, [https://www.w3.org/2021/06/musicxml40/tutorial/structure-of-musicxml-files/](https://www.w3.org/2021/06/musicxml40/tutorial/structure-of-musicxml-files/)  
19. Notation Basics in MusicXML, accessed February 8, 2026, [https://www.w3.org/2021/06/musicxml40/tutorial/notation-basics/](https://www.w3.org/2021/06/musicxml40/tutorial/notation-basics/)  
20. ABC Notation Dataset (10k samples) \- Zenodo, accessed February 8, 2026, [https://zenodo.org/records/17694747](https://zenodo.org/records/17694747)  
21. Kover Maven Plugin | kotlinx-kover \- GitHub Pages, accessed February 8, 2026, [https://kotlin.github.io/kotlinx-kover/maven-plugin/](https://kotlin.github.io/kotlinx-kover/maven-plugin/)  
22. A Guide to Kotlinx-Kover: a Kotlin Code Coverage Toolset \- Baeldung, accessed February 8, 2026, [https://www.baeldung.com/kotlin/kover](https://www.baeldung.com/kotlin/kover)  
23. Enforcing Code Quality in Android with Detekt and Ktlint \- Medium, accessed February 8, 2026, [https://medium.com/@mohamad.alemicode/enforcing-code-quality-in-android-with-detekt-and-ktlint-a-practical-guide-907b57d047ec](https://medium.com/@mohamad.alemicode/enforcing-code-quality-in-android-with-detekt-and-ktlint-a-practical-guide-907b57d047ec)  
24. ABC Music Notation | \- abcjs, accessed February 8, 2026, [https://docs.abcjs.net/overview/abc-notation](https://docs.abcjs.net/overview/abc-notation)  
25. RenderAbc options |, accessed February 8, 2026, [https://docs.abcjs.net/visual/render-abc-options.html](https://docs.abcjs.net/visual/render-abc-options.html)  
26. The quirks of programming music theory | by Nick Rose \- Medium, accessed February 8, 2026, [https://medium.com/@nicholas.rose/the-quirks-of-programming-music-theory-fcffd42d9e50](https://medium.com/@nicholas.rose/the-quirks-of-programming-music-theory-fcffd42d9e50)
</file>

<file path=".gitignore">
target/
**/target/
.kotlin
*.log

### IntelliJ IDEA ###
.idea/
*.iws
*.iml
*.ipr
out/

### Eclipse ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/
build/

### VS Code ###
.vscode/

### Mac OS ###
.DS_Store
tools/abcjs-exporter/node_modules/
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/AbcTune.kt">
package io.github.ryangardner.abc.core.model

/**
 * Represents a fully parsed ABC tune.
 * Immutable and thread-safe.
 */
public data class AbcTune(
    public val header: TuneHeader,
    public val body: TuneBody,
    public val metadata: TuneMetadata
)
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/Accidental.kt">
package io.github.ryangardner.abc.core.model

public enum class Accidental(public val semitones: Int, public val offset: Double = 0.0) {
    SHARP(1),
    FLAT(-1),
    NATURAL(0),
    DOUBLE_SHARP(2),
    DOUBLE_FLAT(-2),
    
    QUARTER_SHARP(0, 0.5),
    THREE_QUARTER_SHARP(1, 0.5),
    QUARTER_FLAT(0, -0.5),
    THREE_QUARTER_FLAT(-1, -0.5)
}
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/BarLineType.kt">
package io.github.ryangardner.abc.core.model

public enum class BarLineType {
    SINGLE, DOUBLE, FINAL, REPEAT_START, REPEAT_END, REPEAT_BOTH
}
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/Decoration.kt">
package io.github.ryangardner.abc.core.model

public data class Decoration(
    public val value: String
)
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/HeaderType.kt">
package io.github.ryangardner.abc.core.model

public enum class HeaderType(public val key: String) {
    REFERENCE("X"), 
    TITLE("T"), 
    KEY("K"), 
    METER("M"), 
    LENGTH("L"), 
    TEMPO("Q"), 
    VOICE("V"),
    PARTS("P"),
    WORDS("W"),
    COMPOSER("C"),
    RHYTHM("R"),
    ORIGIN("O"),
    SOURCE("S"),
    TRANSCRIPTION("Z"),
    BOOK("B"),
    NOTES("N"),
    HISTORY("H"),
    DISCOGRAPHY("D"),
    FILE("F"),
    GROUP("G"),
    REMARK("r"),
    MACRO("m"),
    INSTRUCTION("I"),
    UNKNOWN("")
}
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/NoteDuration.kt">
package io.github.ryangardner.abc.core.model

/**
 * Represents a note duration.
 *
 * @property value The duration value (e.g., 1/8).
 */
public data class NoteDuration(
    public val numerator: Int,
    public val denominator: Int
) {
    public operator fun plus(other: NoteDuration): NoteDuration {
        val newNum = this.numerator * other.denominator + other.numerator * this.denominator
        val newDen = this.denominator * other.denominator
        return simplify(newNum, newDen)
    }

    public operator fun times(other: NoteDuration): NoteDuration {
        return simplify(this.numerator * other.numerator, this.denominator * other.denominator)
    }

    public fun toDouble(): Double = numerator.toDouble() / denominator.toDouble()

    public fun scale(multiplier: Double): NoteDuration {
        // multiplier is usually 1.5, 0.5, 1.75, 0.25, etc.
        // Convert to fraction
        val (mNum, mDen) = when (multiplier) {
            1.5 -> 3 to 2
            0.5 -> 1 to 2
            1.75 -> 7 to 4
            0.25 -> 1 to 4
            1.875 -> 15 to 8
            0.125 -> 1 to 8
            else -> {
                // Approximate if needed, but for broken rhythm these are the standard values
                (multiplier * 1000).toInt() to 1000
            }
        }
        return simplify(this.numerator * mNum, this.denominator * mDen)
    }

    public companion object {
        public fun simplify(num: Int, den: Int): NoteDuration {
            val common = gcd(num, den)
            return NoteDuration(num / common, den / common)
        }

        private fun gcd(a: Int, b: Int): Int {
            var x = a
            var y = b
            while (y != 0) {
                val temp = y
                y = x % y
                x = temp
            }
            return x
        }
    }
}
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/NoteStep.kt">
package io.github.ryangardner.abc.core.model

public enum class NoteStep {
    C, D, E, F, G, A, B
}
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/Pitch.kt">
package io.github.ryangardner.abc.core.model

public data class Pitch @JvmOverloads constructor(
    public val step: NoteStep,
    public val octave: Int,
    public val accidental: Accidental? = null
) {
    public val midiNoteNumber: Int
        get() {
            val baseSemitones = when (step) {
                NoteStep.C -> 0
                NoteStep.D -> 2
                NoteStep.E -> 4
                NoteStep.F -> 5
                NoteStep.G -> 7
                NoteStep.A -> 9
                NoteStep.B -> 11
            }
            val accidentalSemitones = accidental?.semitones ?: 0
            return 12 * (octave + 1) + baseSemitones + accidentalSemitones
        }
}
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/Tempo.kt">
package io.github.ryangardner.abc.core.model

/**
 * Represents the tempo of the tune.
 *
 * @property bpm Beats per minute.
 * @property beatUnit The note value that the beat refers to (optional).
 */
public data class Tempo @JvmOverloads constructor(
    public val bpm: Int,
    public val beatUnit: NoteDuration? = null
)
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/TieType.kt">
package io.github.ryangardner.abc.core.model

public enum class TieType {
    NONE, START, END, BOTH
}
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/TimeSignature.kt">
package io.github.ryangardner.abc.core.model

/**
 * Represents a time signature (meter).
 *
 * @property numerator The number of beats per measure.
 * @property denominator The note value that represents one beat.
 * @property symbol Optional symbol representation (e.g., "C", "C|").
 */
public data class TimeSignature @JvmOverloads constructor(
    public val numerator: Int,
    public val denominator: Int,
    public val symbol: String? = null
) {
    public fun toDouble(): Double = numerator.toDouble() / denominator.toDouble()
}
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/TuneBody.kt">
package io.github.ryangardner.abc.core.model

public data class TuneBody(
    public val elements: List<MusicElement>
)
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/TuneHeader.kt">
package io.github.ryangardner.abc.core.model

/**
 * Represents the header of an ABC tune.
 *
 * @property reference Unique index of the tune (X:).
 * @property title List of titles (T:).
 * @property key Key signature (K:).
 * @property meter Time signature (M:).
 * @property length Default note length (L:).
 * @property tempo Tempo (Q:).
 */
public data class TuneHeader @JvmOverloads constructor(
    public val reference: Int,
    public val title: List<String>,
    public val key: KeySignature,
    public val meter: TimeSignature,
    public val length: NoteDuration,
    public val tempo: Tempo? = null,
    public val headers: List<Pair<String, String>> = emptyList(),
    public val unknownHeaders: Map<String, String> = emptyMap(),
    public val version: String = "2.0",
    public val playingOrder: String? = null
)
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/TuneMetadata.kt">
package io.github.ryangardner.abc.core.model

public data class TuneMetadata @JvmOverloads constructor(
    public val visualTranspose: Int? = null,
    // val midi: MidiConfiguration? = null // Placeholder for now
)
</file>

<file path="abc-theory/pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>io.github.ryangardner</groupId>
        <artifactId>abc-jvm-parent</artifactId>
        <version>0.1.0-SNAPSHOT</version>
    </parent>

    <artifactId>abc-theory</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
        </dependency>
        <dependency>
            <groupId>io.github.ryangardner</groupId>
            <artifactId>abc-core</artifactId>
            <version>${project.version}</version>
        </dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-stdlib</artifactId>
        </dependency>
        <dependency>
            <groupId>org.jetbrains.kotlin</groupId>
            <artifactId>kotlin-test-junit5</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
</project>
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/KeySignature.kt">
package io.github.ryangardner.abc.core.model

/**
 * Represents a musical key signature.
 */
public data class KeySignature @JvmOverloads constructor(
    public val root: KeyRoot,
    public val mode: KeyMode = KeyMode.IONIAN,
    public val extraAccidentals: List<Pitch> = emptyList()
) {
    /**
     * String representation of the tonic, e.g., "C", "F#", "Bb".
     */
    public val tonicName: String get() = buildString {
        append(root.step.name)
        when (root.accidental) {
            Accidental.SHARP -> append("#")
            Accidental.FLAT -> append("b")
            Accidental.DOUBLE_SHARP -> append("##")
            Accidental.DOUBLE_FLAT -> append("bb")
            else -> {}
        }
    }
}
</file>

<file path="abc-core/src/main/kotlin/io/github/ryangardner/abc/core/model/MusicElement.kt">
package io.github.ryangardner.abc.core.model

public sealed interface MusicElement {
    public val duration: NoteDuration
}

public data class NoteElement @JvmOverloads constructor(
    public val pitch: Pitch,
    public val length: NoteDuration,
    public val ties: TieType = TieType.NONE,
    public val decorations: List<Decoration> = emptyList(),
    public val accidental: Accidental? = null
) : MusicElement {
    override val duration: NoteDuration get() = length
}

public data class ChordElement @JvmOverloads constructor(
    public val notes: List<NoteElement>,
    override val duration: NoteDuration,
    public val annotation: String? = null,
    public val decorations: List<Decoration> = emptyList()
) : MusicElement

public data class BarLineElement @JvmOverloads constructor(
    public val type: BarLineType,
    public val repeatCount: Int = 0
) : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}

public data class InlineFieldElement(
    public val fieldType: HeaderType,
    public val value: String
) : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}

public data class RestElement @JvmOverloads constructor(
    override val duration: NoteDuration,
    public val isInvisible: Boolean = false, // x or X
    public val decorations: List<Decoration> = emptyList()
) : MusicElement

public data class DirectiveElement(
    public val content: String
) : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}

public sealed interface SymbolItem
public data class SymbolChord(val name: String) : SymbolItem
public data class SymbolDecoration(val name: String) : SymbolItem
public object SymbolSkip : SymbolItem {
    override fun toString(): String = "*"
}
public object SymbolBar : SymbolItem {
    override fun toString(): String = "|"
}
public data class SymbolOther(val text: String) : SymbolItem // For robustness

public data class SymbolLineElement(
    public val items: List<SymbolItem>
) : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}

public data class TextBlockElement(
    public val content: List<String>
) : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}

public data class BodyHeaderElement(
    public val key: String,
    public val value: String
) : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}

public data class SlurElement(
    public val isStart: Boolean
) : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}

public data class TupletElement(
    public val p: Int, // number of notes to be played
    public val q: Int? = null, // in the time of q notes
    public val r: Int? = null  // for the next r notes
) : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}

public data class GraceNoteElement @JvmOverloads constructor(
    public val notes: List<NoteElement>,
    public val isAcciaccatura: Boolean = false // {/g}
) : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}

public data class SpacerElement(
    public val text: String
) : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}

public object OverlayElement : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}
public data class LyricElement(
    public val content: String
) : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}

public data class VariantElement(
    public val variants: List<Int>
) : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}

public data class PartElement(
    public val name: String
) : MusicElement {
    override val duration: NoteDuration = NoteDuration(0, 1)
}
</file>

<file path="pom.xml">
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>io.github.ryangardner</groupId>
    <artifactId>abc-jvm-parent</artifactId>
    <version>0.1.0-SNAPSHOT</version>
    <packaging>pom</packaging>

    <modules>
        <module>abc-core</module>
        <module>abc-parser</module>
        <module>abc-theory</module>
        <module>abc-interop</module>
        <module>abc-test</module>
        <module>abc-parser-antlr</module>
        <module>abc-parser-v2</module>
    </modules>

    <properties>
        <kotlin.version>1.9.22</kotlin.version>
        <java.version>1.8</java.version>
        <tuxguitar.version>1.5.4</tuxguitar.version>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <kover.version>0.8.3</kover.version>
        <detekt.version>1.23.5</detekt.version>
        <junit.version>5.10.1</junit.version>
        <slf4j.version>2.0.9</slf4j.version>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.slf4j</groupId>
                <artifactId>slf4j-api</artifactId>
                <version>${slf4j.version}</version>
            </dependency>
            <dependency>
                <groupId>org.slf4j</groupId>
                <artifactId>slf4j-simple</artifactId>
                <version>${slf4j.version}</version>
            </dependency>
            <dependency>
                <groupId>org.jetbrains.kotlin</groupId>
                <artifactId>kotlin-stdlib</artifactId>
                <version>${kotlin.version}</version>
            </dependency>
            <dependency>
                <groupId>org.junit.jupiter</groupId>
                <artifactId>junit-jupiter-api</artifactId>
                <version>${junit.version}</version>
                <scope>test</scope>
            </dependency>
            <dependency>
                <groupId>org.junit.jupiter</groupId>
                <artifactId>junit-jupiter-engine</artifactId>
                <version>${junit.version}</version>
                <scope>test</scope>
            </dependency>
            <dependency>
                <groupId>org.junit.jupiter</groupId>
                <artifactId>junit-jupiter-params</artifactId>
                <version>${junit.version}</version>
                <scope>test</scope>
            </dependency>
            <dependency>
                <groupId>org.jetbrains.kotlin</groupId>
                <artifactId>kotlin-test-junit5</artifactId>
                <version>${kotlin.version}</version>
                <scope>test</scope>
            </dependency>
            <dependency>
                <groupId>io.github.ryangardner</groupId>
                <artifactId>abc-core</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>io.github.ryangardner</groupId>
                <artifactId>abc-parser</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>io.github.ryangardner</groupId>
                <artifactId>abc-theory</artifactId>
                <version>${project.version}</version>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.jetbrains.kotlin</groupId>
                <artifactId>kotlin-maven-plugin</artifactId>
                <version>${kotlin.version}</version>
                <configuration>
                    <jvmTarget>${java.version}</jvmTarget>
                    <args>
                        <arg>-Xjvm-default=all</arg>
                    </args>
                </configuration>
                <executions>
                    <execution>
                        <id>compile</id>
                        <goals>
                            <goal>compile</goal>
                        </goals>
                        <configuration>
                            <args>
                                <arg>-Xjvm-default=all</arg>
                                <arg>-Xexplicit-api=strict</arg>
                            </args>
                            <sourceDirs>
                                <sourceDir>${project.basedir}/src/main/kotlin</sourceDir>
                                <sourceDir>${project.basedir}/src/main/java</sourceDir>
                            </sourceDirs>
                        </configuration>
                    </execution>
                    <execution>
                        <id>test-compile</id>
                        <goals>
                            <goal>test-compile</goal>
                        </goals>
                        <configuration>
                            <sourceDirs>
                                <sourceDir>${project.basedir}/src/test/kotlin</sourceDir>
                                <sourceDir>${project.basedir}/src/test/java</sourceDir>
                            </sourceDirs>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>com.github.gantsign.maven</groupId>
                <artifactId>ktlint-maven-plugin</artifactId>
                <version>3.0.0</version>
                <executions>
                    <execution>
                        <id>check</id>
                        <goals>
                            <goal>check</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.jetbrains.kotlinx</groupId>
                <artifactId>kover-maven-plugin</artifactId>
                <version>${kover.version}</version>
                <executions>
                    <execution>
                        <id>report</id>
                        <goals>
                            <goal>report-xml</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>com.github.ozsie</groupId>
                <artifactId>detekt-maven-plugin</artifactId>
                <version>${detekt.version}</version>
                <configuration>
                    <config>config/detekt/detekt.yml</config>
                </configuration>
                <executions>
                    <execution>
                        <phase>verify</phase>
                        <goals>
                            <goal>check</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
</project>
</file>

</files>
